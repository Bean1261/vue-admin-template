### 基于vue + element ui +  spring boot开发学校图书管理系统实战视频教程



#### 第01讲 课程介绍与项目演示

###### 1.技术要点

html、css3、js、vue基础

###### 2.适合人群

有html、css3、js、vue2、spring boot基础，想学习vue、element ui开发后台管理系统的在校大学生、工作人员；

想学习如何实现动态菜单、动态路由、按钮权限的在职人员；

###### 3.学习收获

​	1.学会使用vue-admin-template搭建后台系统；

​	2.vue-admin-template登录源码、权限权限验证流程分析；

​	3.vue动态菜单、动态路由、按钮权限实现原理，代码实现；

​	4.通用弹框、tree组件优化、页面优化、通用axios封装、restful api支持封装；

​	5.前后端分离中的token(JWT)验证处理；

​	6.掌握spring boot在前后端分离项目中的使用;

​	7.全程手把手带领写代码，最终从0到1打造属于自己的前后端分离实战项目；

​    8.课程售后答疑 3501754007



#### 第02讲 开发环境准备

##### 1、环境准备

```js
1、安装node.js
2、安装vue-cli
3、安装 vs code开发工具
```

<span style='color:#FF7670;'>注意：本课程采用 node-v12.19.0-x64.msi版本，建议下载跟课程相同的版本进行安装</span>

##### 2、下载node.js

​	浏览器打开   https://nodejs.org/zh-cn/download/   进入如下所示的界面

![](D:\Files\Simple\vue+springboot资料\资料\images\以往版本选择.png)

###### 1.2点击【以往的版本】进入如下所示列表界面，选择自己所需要的版本进行下载安装

![](D:\Files\Simple\vue+springboot资料\资料\images\以往版本列表.png)



##### 3、vue-cli安装

###### 1.2.1检查node.js是否安装

通过命令提示符，node -v  npm -v查看，如果没有请先安装node.js,如下图，说明已经安装node.js

![](D:\Files\Simple\vue+springboot资料\资料\images\node安装9.png)



###### 1.2.2.把npm换成cnpm

命令工具输入   npm install -g cnpm --registry=https://registry.npm.taobao.org

安装完成 输入 cnpm -v 查看是否安装成功

卸载cnpm    npm uninstall cnpm -g

###### 1.2.3.安装vue-cli

cnpm install -g @vue/cli



###### 1.2.4.查看vue-cli是否安装成功

vue -V      

 注意 V是大写的



##### 4、vs code安装





#### 第03讲 vue-admin-template下载



##### 1、vue-element-admin介绍

[vue-element-admin](http://panjiachen.github.io/vue-element-admin) 是一个后台前端解决方案，它基于 [vue](https://github.com/vuejs/vue) 和 [element-ui](https://github.com/ElemeFE/element)实现。它使用了最新的前端技术栈，内置了 i18 国际化解决方案，动态路由，权限验证，提炼了典型的业务模型，提供了丰富的功能组件，它可以帮助你快速搭建企业级中后台产品原型。相信不管你的需求是什么，本项目都能帮助到你。

建议

本项目的定位是后台集成方案，不太适合当基础模板来进行二次开发。因为本项目集成了很多你可能用不到的功能，会造成不少的代码冗余。如果你的项目不关注这方面的问题，也可以直接基于它进行二次开发。

- 集成方案: [vue-element-admin](https://github.com/PanJiaChen/vue-element-admin)
- 基础模板: [vue-admin-template](https://github.com/PanJiaChen/vue-admin-template)
- 桌面终端: [electron-vue-admin](https://github.com/PanJiaChen/electron-vue-admin)
- Typescript 版: [vue-typescript-admin-template](https://github.com/Armour/vue-typescript-admin-template) (鸣谢: [@Armour](https://github.com/Armour))
- Others: [awesome-project](https://github.com/PanJiaChen/vue-element-admin/issues/2312)



**vue-element-admin和vue-admin-template区别**

```js
1、vue-admin-template是vue-element-admin的简化版，适合企业搭建项目；并且简化版有两个版本，注意选择；
2、vue-element-admin 定位是后台集成方案，不太适合当基础模板来进行二次开发。因为本项目集成了很多你可能用不到的功能，会造成不少的代码冗余
```



##### 

##### 2、vue-admin-template下载

```js
在线演示地址
https://panjiachen.github.io/vue-admin-template/#/login?redirect=%2Fdashboard

下载地址
https://github.com/PanJiaChen/vue-admin-template/tree/permission-control
```

##### 3、运行项目

```js
1.安装依赖   npm install 
2.运行项目   npm run dev
```

##### 4、运行项目报错解决

```js
1. error  Multiple spaces found before '//需要添加该项，否则上级不...'  no-multi-spaces错误
 找到项目的.eslintrc.js配置文件把rules:中的   'no-multi-spaces': 'off'   //关闭空格的检查

2. error    Trailing spaces not allowed                          no-trailing-spaces错误
找到项目的.eslintrc.js配置文件在rules:中添加   'no-trailing-spaces': 'error', // 行末不要空格
```





#### 第04讲  配置左侧导航菜单

![](D:\Files\Simple\vue+springboot资料\资料\images\1-1.png)

##### 1、修改应用的名称

找到src目录下的settings.js配置文件，修改为如下所示

```js
module.exports = {

  title: '学校图书管理系统',

  /**
   * @type {boolean} true | false
   * @description Whether fix the header
   */
  fixedHeader: true,   //固定头部

  /**
   * @type {boolean} true | false
   * @description Whether show the logo in sidebar
   */
  sidebarLogo: true  //显示图标
}

```

##### 2、修改右侧的下拉菜单

找到src/layout/components下的Navbar.vue文件，把el-dropdown-menu修改为如下所示代码

```js
<el-dropdown-menu  slot="dropdown" class="user-dropdown">
          <el-dropdown-item divided>
            <span style="display:block;">重置密码</span>
          </el-dropdown-item>
          <el-dropdown-item divided @click.native="logout">
            <span style="display:block;">退出登录</span>
          </el-dropdown-item>
</el-dropdown-menu>
```

##### 3、修改Dashboard为首页

3.1、修改router下的router.js里面的dashboard的title为 首页

```js
{
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  }
```

3.2、修改components/Breadcrumb/index.vue中的 title  为首页

```js
if (!this.isDashboard(first)) {
        matched = [{ path: '/dashboard', meta: { title: '首页' }}].concat(matched)
 }
```

##### 4、新建模块页面，并创建页面对应的路由

```js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

/* Layout */
import Layout from '@/layout'

/**
 * Note: sub-menu only appear when route children.length >= 1
 * Detail see: https://panjiachen.github.io/vue-element-admin-site/guide/essentials/router-and-nav.html
 *
 * hidden: true                   if set true, item will not show in the sidebar(default is false)
 * alwaysShow: true               if set true, will always show the root menu
 *                                if not set alwaysShow, when item has more than one children route,
 *                                it will becomes nested mode, otherwise not show the root menu
 * redirect: noRedirect           if set noRedirect will no redirect in the breadcrumb
 * name:'router-name'             the name is used by <keep-alive> (must set!!!)
 * meta : {
    roles: ['admin','editor']    control the page roles (you can set multiple roles)
    title: 'title'               the name show in sidebar and breadcrumb (recommend set)
    icon: 'svg-name'/'el-icon-x' the icon show in the sidebar
    breadcrumb: false            if set false, the item will hidden in breadcrumb(default is true)
    activeMenu: '/example/list'  if set path, the sidebar will highlight the path you set
  }
 */

/**
 * constantRoutes
 * a base page that does not have permission requirements
 * all roles can be accessed
 */
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },
  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard' }
    }]
  }
]

/**
 * asyncRoutes
 * the routes that need to be dynamically loaded based on user roles
 */
export const asyncRoutes = [
  {
    path: '/系统管理',
    component: Layout,
    alwaysShow: true,
    name: 'system',
    meta: { title: '系统管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/sysUserList',
        name: 'sysUserList',
        component: () => import('@/views/system/sysUserList'),
        meta: { title: '用户管理', icon: 'table' }
      },
      {
        path: '/sysRoleList',
        name: 'sysRoleList',
        component: () => import('@/views/system/sysRoleList'),
        meta: { title: '角色管理', icon: 'tree' }
      },
      {
        path: '/sysMenuList',
        name: 'sysMenuList',
        component: () => import('@/views/system/sysMenuList'),
        meta: { title: '菜单管理', icon: 'tree' }
      }
    ]
  },
  {
    path: '/reader',
    component: Layout,
    alwaysShow: true,
    name: 'reader',
    meta: { title: '读者管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/readerList',
        name: 'readerList',
        component: () => import('@/views/reader/readerList'),
        meta: { title: '读者管理', icon: 'table' }
      }
    ]
  },
  {
    path: '/book',
    component: Layout,
    alwaysShow: true,
    name: 'book',
    meta: { title: '图书管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/bookCategory',
        name: 'bookCategory',
        component: () => import('@/views/book/bookCategory'),
        meta: { title: '图书分类', icon: 'table' }
      },
      {
        path: '/bookList',
        name: 'bookList',
        component: () => import('@/views/book/bookList'),
        meta: { title: '图书列表', icon: 'table' }
      }
    ]
  },
  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router

```

##### 4、新建上面路由中对应的组件页面

###### 4.1、在src/views下新建system目录

1.新建sysMenuList.vue组件

```js
<template>
    <div>
菜单管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

2.新建sysRoleList.vue组件

```js
<template>
    <div>
角色管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```

3.新建sysUserList.vue组件

```js
<template>
    <div>
        用户管理
    </div>
</template>

<script>
    export default {
        
    }
</script>

<style lang="scss" scoped>

</style>
```



###### 4.2、在src/views下新建reader文件夹，并新建如下页面

1、readerList.vue页面

```js
<template>
  <div>读者管理</div>
</template>

<script>
export default {};
</script>

<style lang="scss" scoped>
</style>
```



###### 4.3、在src/views下新建book文件夹，并新建如下页面

1、bookCategory.vue页面

```js
<template>
  <div>图书分类</div>
</template>

<script>
export default {};
</script>

<style lang="scss" scoped>
</style>
```



2、bookList.vue页面

```js
<template>
  <div>图书列表</div>
</template>

<script>
export default {};
</script>

<style lang="scss" scoped>
</style>
```



##### 5、菜单改为打开一个

找到src/layout下的components目录，修改SideBar目录下的index.vue中的   :unique-opened="true"



#### 第05讲  项目添加添加tagsview选项卡

###### 1、添加TagsView文件

把vue-element-admin项目中的src\layout\components下的TagsView文件夹复制到vue-admin-template的 src\layout\components下

把vue-element-admin\src\store\modules\tagsView.js 复制到vue-admin-template\srcstore\modules\

###### 2、修改 vue-admin-template\src\layout\components\AppMain.vue文件

```js
<template>
  <section class="app-main">
    <transition name="fade-transform" mode="out-in">
      <!-- <router-view :key="key" /> -->
      <keep-alive :include="cachedViews">
        <router-view :key="key" />
      </keep-alive>
    </transition>
  </section>
</template>

<script>
export default {
  name: "AppMain",
  computed: {
    cachedViews() {
      return this.$store.state.tagsView.cachedViews;
    },
    key() {
      return this.$route.path;
    },
  },
};
</script>

<style scoped>
.app-main {
  /*50 = navbar  */
  min-height: calc(100vh - 50px);
  width: 100%;
  position: relative;
  overflow: hidden;
}
.fixed-header + .app-main {
  padding-top: 50px;
}
</style>

<style lang="scss">
// fix css style bug in open el-dialog
.el-popup-parent--hidden {
  .fixed-header {
    padding-right: 15px;
  }
}
</style>

```



###### 3、修改vue-admin-template\src\layout\components\index.js

```js
新增如下行：
export { default as TagsView } from './TagsView'
```

###### 4、修改 vue-admin-template\src\layout\index.vue

```js
<template>
  <div :class="classObj" class="app-wrapper">
    <div v-if="device==='mobile'&&sidebar.opened" class="drawer-bg" @click="handleClickOutside" />
    <sidebar class="sidebar-container" />
    <div class="main-container">
      <div :class="{'fixed-header':fixedHeader}">
        <navbar />
      </div>
      <tags-view />
      <app-main />
    </div>
  </div>
</template>

<script>
import { Navbar, Sidebar, AppMain,TagsView  } from './components'
import ResizeMixin from './mixin/ResizeHandler'

export default {
  name: 'Layout',
  components: {
    Navbar,
    Sidebar,
    AppMain,
    TagsView 
  },
  mixins: [ResizeMixin],
  computed: {
    sidebar() {
      return this.$store.state.app.sidebar
    },
    device() {
      return this.$store.state.app.device
    },
    fixedHeader() {
      return this.$store.state.settings.fixedHeader
    },
    classObj() {
      return {
        hideSidebar: !this.sidebar.opened,
        openSidebar: this.sidebar.opened,
        withoutAnimation: this.sidebar.withoutAnimation,
        mobile: this.device === 'mobile'
      }
    }
  },
  methods: {
    handleClickOutside() {
      this.$store.dispatch('app/closeSideBar', { withoutAnimation: false })
    }
  }
}
</script>

<style lang="scss" scoped>
  @import "~@/styles/mixin.scss";
  @import "~@/styles/variables.scss";

  .app-wrapper {
    @include clearfix;
    position: relative;
    height: 100%;
    width: 100%;
    &.mobile.openSidebar{
      position: fixed;
      top: 0;
    }
  }
  .drawer-bg {
    background: #000;
    opacity: 0.3;
    width: 100%;
    top: 0;
    height: 100%;
    position: absolute;
    z-index: 999;
  }

  .fixed-header {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 9;
    width: calc(100% - #{$sideBarWidth});
    transition: width 0.28s;
  }

  .hideSidebar .fixed-header {
    width: calc(100% - 54px)
  }

  .mobile .fixed-header {
    width: 100%;
  }
</style>

```



###### 5、修改 vue-admin-template\src\store\getters.js，

新增

 visitedViews: state => state.tagsView.visitedViews,
 cachedViews: state => state.tagsView.cachedViews

```js
const getters = {
  sidebar: state => state.app.sidebar,
  device: state => state.app.device,
  token: state => state.user.token,
  avatar: state => state.user.avatar,
  name: state => state.user.name,
  visitedViews: state => state.tagsView.visitedViews,
  cachedViews: state => state.tagsView.cachedViews
}
export default getters

```

###### 6、修改 vue-admin-template\src\store\index.js

引入 import tagsView from './modules/tagsView'

```js
import Vue from 'vue'
import Vuex from 'vuex'
import getters from './getters'
import app from './modules/app'
import settings from './modules/settings'
import user from './modules/user'
import tagsView from './modules/tagsView'
Vue.use(Vuex)

const store = new Vuex.Store({
  modules: {
    app,
    settings,
    user,
    tagsView
  },
  getters
})

export default store

```

###### 7、运行报错如下

![](D:\Files\Simple\vue+springboot资料\资料\images\tagsview错误.png)

解决方式

删除vue-admin-template\src\layout\components\TagsView\index.vue中routes方法

![](D:\Files\Simple\vue+springboot资料\资料\images\tags报错1.png)

![](D:\Files\Simple\vue+springboot资料\资料\images\tags报错2.png)



###### 8、解决开启头部固定，不会显示 TagsView的问题

如果settings里面开启的如下所示，TagsView将不会显示

```js
  fixedHeader: true,
```

8.1、修改vue-admin-template\src\settings.js 添加

```js
tagsView: true,
```

8.2、修改vue-admin-template\src\store\modules\settings.js

```js
import defaultSettings from '@/settings'

const { showSettings, fixedHeader, sidebarLogo,tagsView } = defaultSettings

const state = {
  showSettings: showSettings,
  fixedHeader: fixedHeader,
  sidebarLogo: sidebarLogo,
  tagsView: tagsView,
}

const mutations = {
  CHANGE_SETTING: (state, { key, value }) => {
    // eslint-disable-next-line no-prototype-builtins
    if (state.hasOwnProperty(key)) {
      state[key] = value
    }
  }
}

const actions = {
  changeSetting({ commit }, data) {
    commit('CHANGE_SETTING', data)
  }
}

export default {
  namespaced: true,
  state,
  mutations,
  actions
}
```

8.3、修改 vue-admin-template\src\layout\components\AppMain.vue文件的样式如下

主要是有hasTagsView样式的时候

```js
<template>
  <section class="app-main">
    <transition name="fade-transform" mode="out-in">
      <!-- <router-view :key="key" /> -->
      <keep-alive :include="cachedViews">
        <router-view :key="key" />
      </keep-alive>
    </transition>
  </section>
</template>

<script>
export default {
  name: "AppMain",
  computed: {
    cachedViews() {
      return this.$store.state.tagsView.cachedViews;
    },
    key() {
      return this.$route.path;
    },
  },
};
</script>

<style lang="scss" scoped>
.app-main {
  /* 50= navbar  50  */
  min-height: calc(100vh - 50px);
  width: 100%;
  position: relative;
  overflow: hidden;
}

.fixed-header+.app-main {
  padding-top: 50px;
}

.hasTagsView {
  .app-main {
    /* 84 = navbar + tags-view = 50 + 34 */
    min-height: calc(100vh - 84px);
  }

  .fixed-header+.app-main {
    padding-top: 84px;
  }
}
</style>

<style lang="scss">
// fix css style bug in open el-dialog
.el-popup-parent--hidden {
  .fixed-header {
    padding-right: 15px;
  }
}
</style>

```

8.4、修改 vue-admin-template\src\layout\index.vue如下

主要是通过needTagsView进行判断

```js
<template>
  <div :class="classObj" class="app-wrapper">
    <div
      v-if="device === 'mobile' && sidebar.opened"
      class="drawer-bg"
      @click="handleClickOutside"
    />
    <sidebar class="sidebar-container" />
    <div :class="{ hasTagsView: needTagsView }" class="main-container">
      <div :class="{ 'fixed-header': fixedHeader }">
        <navbar />
        <tags-view v-if="needTagsView" />
      </div>
      <app-main />
    </div>
    <!-- <div class="hasTagsView main-container">
      <div :class="{'fixed-header':fixedHeader}">
        <navbar />
      </div>
       <tags-view />
      <app-main />
    </div> -->
  </div>
</template>

<script>
import { Navbar, Sidebar, AppMain, TagsView } from "./components";
import ResizeMixin from "./mixin/ResizeHandler";

export default {
  name: "Layout",
  components: {
    Navbar,
    Sidebar,
    AppMain,
    TagsView,
  },
  mixins: [ResizeMixin],
  computed: {
    sidebar() {
      return this.$store.state.app.sidebar;
    },
    device() {
      return this.$store.state.app.device;
    },
    fixedHeader() {
      return this.$store.state.settings.fixedHeader;
    },
    needTagsView() {
      return this.$store.state.settings.tagsView;
    },
    classObj() {
      return {
        hideSidebar: !this.sidebar.opened,
        openSidebar: this.sidebar.opened,
        withoutAnimation: this.sidebar.withoutAnimation,
        mobile: this.device === "mobile",
      };
    },
  },
  methods: {
    handleClickOutside() {
      this.$store.dispatch("app/closeSideBar", { withoutAnimation: false });
    },
  },
};
</script>

<style lang="scss" scoped>
@import "~@/styles/mixin.scss";
@import "~@/styles/variables.scss";

.app-wrapper {
  @include clearfix;
  position: relative;
  height: 100%;
  width: 100%;
  &.mobile.openSidebar {
    position: fixed;
    top: 0;
  }
}
.drawer-bg {
  background: #000;
  opacity: 0.3;
  width: 100%;
  top: 0;
  height: 100%;
  position: absolute;
  z-index: 999;
}

.fixed-header {
  position: fixed;
  top: 0;
  right: 0;
  z-index: 9;
  width: calc(100% - #{$sideBarWidth});
  transition: width 0.28s;
}

.hideSidebar .fixed-header {
  width: calc(100% - 54px);
}

.mobile .fixed-header {
  width: 100%;
}
</style>

```

######  9、解决刷新浏览器，TagsView选项卡丢失问题

找到 src\views\layout\components\TagsView.vue 组件

9.1、在methods方法中添加如下方法

```js
// 解决刷新浏览器tabs选项卡丢失问题
    beforeUnload() {
      // 监听页面刷新
      window.addEventListener("beforeunload", () => {
        // visitedViews数据结构太复杂无法直接JSON.stringify处理，先转换需要的数据
        let tabViews = this.visitedViews.map((item) => {
          return {
            fullPath: item.fullPath,
            hash: item.hash,
            meta: { ...item.meta },
            name: item.name,
            params: { ...item.params },
            path: item.path,
            query: { ...item.query },
            title: item.title,
          };
        });
        sessionStorage.setItem("tabViews", JSON.stringify(tabViews));
      });
      // 页面初始化加载判断缓存中是否有数据
      let oldViews = JSON.parse(sessionStorage.getItem("tabViews")) || [];
      if (oldViews.length > 0) {
        this.$store.state.tagsView.visitedViews = oldViews;
      }
    },
```

9.2、mounted()生命周期函数中添加刷新选项卡方法

```js
mounted() {
    this.initTags();
    this.addTags();
     // 解决刷新选项卡丢失问题
    this.beforeUnload();
},
```

###### 10、解决选项卡为【首页】不能关闭的问题

在router中的index.js找到首页路由配置项，并在 meta中添加   affix: true    如下meta配置所示

```js
{
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard', affix: true }
    }]
  }
```







#### 第06讲 权限相关数据库设计



##### 1、用户表字段(sys_user)

| 字段名称                   | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注                              |
| :------------------------- | -------- | -------- | -------- | -------- | --------------------------------- |
| user_id                    | int      | 11       | 是       | 否       | 用户id                            |
| username                   | varchar  | 64       | 否       | 是       | 登录账户                          |
| password                   | varchar  | 128      | 否       | 是       | 登录密码                          |
| phone                      | varchar  | 13       | 否       | 是       | 用户电话                          |
| email                      | varchar  | 36       | 否       | 是       | 邮箱                              |
| sex                        | varchar  | 2        | 否       | 是       | 0:男 1：女                        |
| is_admin                   | tinyint  | 2        | 否       | 是       | 是否为超级管理员 1：是 0：否      |
| is_account_non_expired     | tinyint  | 2        | 否       | 是       | 帐户是否过期(1 未过期，0已过期)   |
| is_account_non_locked      | tinyint  | 2        | 否       | 是       | 帐户是否被锁定(1 未锁定，0已锁定) |
| is_credentials_non_expired | tinyint  | 2        | 否       | 是       | 密码是否过期(1 未过期，0已过期)   |
| is_enabled                 | tinyint  | 2        | 否       | 是       | 帐户是否可用(1 可用，0 删除用户)  |
| nick_name                  | varchar  | 36       | 否       | 是       | 姓名                              |
| create_time                | datetime |          | 否       | 是       | 创建时间                          |
| update_time                | datetime |          | 否       | 是       | 更新时间                          |



##### 2、用户角色表(sys_user_role)

| 字段名称     | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注   |
| ------------ | -------- | -------- | -------- | -------- | ------ |
| user_role_id | int      | 11       | 是       | 否       | 主键   |
| user_id      | int      | 11       | 否       | 否       | 用户id |
| role_id      | int      | 11       | 否       | 否       | 角色id |



##### 3、角色表字段(sys_role)

| 字段名称    | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注                          |
| :---------- | -------- | -------- | -------- | -------- | ----------------------------- |
| role_id     | int      | 11       | 是       | 否       | 角色id                        |
| role_name   | varchar  | 64       | 否       | 是       | 角色名称                      |
| role_type   | varchar  | 2        | 否       | 是       | 角色类型 1：系统用户  2：读者 |
| remark      | varchar  | 128      | 否       | 是       | 觉备注                        |
| create_time | datetime |          | 否       | 是       | 创建时间                      |
| update_time | datetime |          | 否       | 是       | 更新时间                      |



##### 4、角色菜单表(sys_role_menu)

| 字段名称     | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注   |
| ------------ | -------- | -------- | -------- | -------- | ------ |
| role_menu_id | int      | 11       | 是       | 否       | 主键   |
| menu_id      | int      | 11       | 否       | 否       | 菜单id |
| role_id      | int      | 11       | 否       | 否       | 角色id |



##### 5、菜单表字段(sys_menu)

| 字段名称    | 数据类型 | 字段大小 | 是否主键 | 是否为空 | 备注                      |
| :---------- | -------- | -------- | -------- | -------- | ------------------------- |
| menu_id     | int      | 11       | 是       | 否       | 菜单id                    |
| parent_id   | int      | 11       | 否       | 是       | 父级菜单id                |
| title       | varchar  | 64       | 否       | 是       | 菜单名称                  |
| code        | varchar  | 64       | 否       | 是       | 权限字段                  |
| name        | varchar  | 36       | 否       | 是       | 路由name                  |
| path        | varchar  | 36       | 否       | 是       | 路由path                  |
| url         | varchar  | 128      | 否       | 是       | 组件路径                  |
| type        | varchar  | 2        | 否       | 是       | 类型(0 目录 1菜单，2按钮) |
| icon        | varchar  | 36       | 否       | 是       | 菜单图标                  |
| parent_name | varchar  | 64       | 否       | 是       | 上级菜单名称              |
| order_num   | int      | 11       | 否       | 是       | 序号                      |
| create_time | datetime |          | 否       | 是       | 创建时间                  |
| update_time | datetime |          | 否       | 是       | 更新时间                  |

```js
/*==============================================================*/
/* DBMS name:      MySQL 5.0                                    */
/* Created on:     2021-10-12 18:26:27                          */
/*==============================================================*/


drop table if exists sys_menu;

drop table if exists sys_role;

drop table if exists sys_role_menu;

drop table if exists sys_user;

drop table if exists sys_user_role;

/*==============================================================*/
/* Table: sys_menu                                              */
/*==============================================================*/
create table sys_menu
(
   menu_id              int not null auto_increment comment '菜单id',
   parent_id            int comment '父级菜单id',
   title                varchar(64) comment '菜单名称',
   code                 varchar(36) comment '权限字段',
   name                 varchar(36) comment '路由name',
   path                 varchar(36) comment '路由path',
   url                  varchar(128) comment '组件路径',
   type                 varchar(2) comment '类型(0 目录 1菜单，2按钮)',
   icon                 varchar(36) comment '菜单图标',
   parent_name          varchar(64) comment '上级菜单名称',
   order_num            int comment '序号',
   create_time          datetime comment '创建时间',
   update_time          datetime comment '更新时间',
   primary key (menu_id)
);

/*==============================================================*/
/* Table: sys_role                                              */
/*==============================================================*/
create table sys_role
(
   role_id              int not null auto_increment comment '角色id',
   role_name            varchar(36) comment '角色名称',
   role_type            varchar(2) comment '角色类型 1：系统用户  2：读者',
   remark               varchar(64) comment '备注',
   create_time          datetime comment '创建时间',
   update_time          datetime comment '更新时间',
   primary key (role_id)
);

/*==============================================================*/
/* Table: sys_role_menu                                         */
/*==============================================================*/
create table sys_role_menu
(
   role_menu_id         int not null auto_increment comment '主键',
   role_id              int comment '角色id',
   menu_id              int comment '菜单id',
   primary key (role_menu_id)
);

/*==============================================================*/
/* Table: sys_user                                              */
/*==============================================================*/
create table sys_user
(
   user_id              int not null auto_increment comment '用户id',
   username             varchar(36) comment '登录账户',
   password             varchar(128) comment '登录密码',
   phone                varchar(13) comment '用户电话',
   email                varchar(64) comment '邮箱',
   sex                  varchar(2) comment '0:男 1：女',
   is_admin             varchar(2) comment '是否为超级管理员 1：是 0：否',
   is_account_non_expired tinyint(2) comment '帐户是否过期(1 未过期，0已过期)',
   is_account_non_locked tinyint(2) comment '帐户是否被锁定(1 未锁定，0已锁定)',
   is_credentials_non_expired tinyint(2) comment '密码是否过期(1 未过期，0已过期)',
   is_enabled           tinyint(2) comment '帐户是否可用(1 可用，0 删除用户)',
   nick_name            varchar(36) comment '姓名',
   create_time          datetime comment '创建时间',
   update_time          datetime comment '更新时间',
   primary key (user_id)
);

/*==============================================================*/
/* Table: sys_user_role                                         */
/*==============================================================*/
create table sys_user_role
(
   user_role_id         int not null auto_increment comment '主键',
   user_id              int comment '用户id',
   role_id              int comment '角色id',
   primary key (user_role_id)
);

```





#### 第07讲  后台多模块系统搭建

**开发环境配置：**

```js
1、JDK安装配置
2、IDEA安装
3、maven安装
4、MySql安装
5、数据库可视化工具 Navicat安装
```

**maven配置**

```js
1、本地仓库配置: <localRepository>D:\javaDe\apache-maven-3.5.4\repo</localRepository>

2、配置阿里镜像:
<mirror>
  <id>nexus-aliyun</id>
  <mirrorOf>central</mirrorOf>
  <name>Nexus aliyun</name>
  <url>http://maven.aliyun.com/nexus/content/groups/public</url>
</mirror>
```



###### 1、项目依赖版本号**

JDk1.8及以上、Maven3.5以上、MySq5.7以上



###### 2、项目结构

| itmk-base-parent | 父模块，pom类型、统一管理子模块 |
| ---------------- | ------------------------------- |
| itmk-base-common | 公共模块、如通用工具的封装等    |
| itmk-base-web    | 前端接口模块，提供api接口       |

###### 3、创建itmk-base-parent父模块

1、打开IDEA，file -> new - > project

![](D:\Files\Simple\vue+springboot资料\资料\images\4-1.png)

2、选择左侧**Maven**，Project SDK选择**1.8及以上**，点击Next

![](D:\Files\Simple\vue+springboot资料\资料\images\4-2.png)

3、Name里面输入**模块名称**，Location选择**项目存储路径**，GroupId:**输入包名，同一个项目，各个模块的包名一致**    ArtifactId: **模块名称**；点击Finish

![](D:\Files\Simple\vue+springboot资料\资料\images\4-3.png)

4、由于itmk-base-parent作为父模块，把生成的模块中的src删除；

![](D:\Files\Simple\vue+springboot资料\资料\images\4-4.png)



###### 4、创建itmk-base-common模块

1.在父模块itmk-base-parent上右键->New->Module，如下所示

![](D:\Files\Simple\vue+springboot资料\资料\images\4-5.png)

2.选择Maven,SDK选择1.8及以上，点击Next

![](D:\Files\Simple\vue+springboot资料\资料\images\4-6.png)

3.Name:输入模块名称 itmk-base-common，点击Finish

![](D:\Files\Simple\vue+springboot资料\资料\images\4-7.png)

###### 5、创建itmk-base-web模块

1.itmk-base-parent模块右键，点击New->Module

![](D:\Files\Simple\vue+springboot资料\资料\images\4-8.png)

2.选择Maven，SDK选择1.8及以上，点击 Next

![](D:\Files\Simple\vue+springboot资料\资料\images\4-9.png)

3.Name填入模块名称，点击Finish

![](D:\Files\Simple\vue+springboot资料\资料\images\4-10.png)

4.项目最终模块

![](D:\Files\Simple\vue+springboot资料\资料\images\4-11.png)





#### 第08讲 引入各个模块依赖

###### 1、修改package类型

修改父模块 itmk-base-parent的pom.xml打包类型为 pom; 

itmk-base-common的pom.xml打包类型为 jar；

itmk-base-wem的pom.xml打包类型为jar

![](D:\Files\Simple\vue+springboot资料\资料\images\5-1.png)



###### 2、itmk-base-parent pom.xml文件

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.itmk</groupId>
    <artifactId>itmk-base-parent</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>itmk-base-common</module>
        <module>itmk-base-web</module>
    </modules>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.4.4</version>
    </parent>
    <properties>
        <java.version>1.8</java.version>
        <swagger2.version>3.0.0</swagger2.version>
        <lombok-version>1.18.12</lombok-version>
        <mybatis-plus.version>3.4.2</mybatis-plus.version>
        <druid.version>1.2.1</druid.version>
        <kaptcha.version>2.3.2</kaptcha.version>
        <fastjson.version>1.2.68</fastjson.version>
        <commons-lang.version>2.6</commons-lang.version>
        <commons-collections.version>3.2.2</commons-collections.version>
        <commons-io.version>2.6</commons-io.version>
        <mysql-connection.version>8.0.21</mysql-connection.version>
    </properties>
    <dependencyManagement>
        <dependencies>
            <!-- lombok依赖 -->
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <version>${lombok-version}</version>
                <scope>provided</scope>
            </dependency>
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql-connection.version}</version>
                <scope>runtime</scope>
            </dependency>
            <!--druid连接池-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>druid-spring-boot-starter</artifactId>
                <version>${druid.version}</version>
            </dependency>
            <!--mybatis-plus依赖-->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            <!-- kaptcha 图形验证码 -->
            <dependency>
                <groupId>com.github.penggle</groupId>
                <artifactId>kaptcha</artifactId>
                <version>${kaptcha.version}</version>
            </dependency>

            <!-- JSON转换工具类依赖 -->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>${fastjson.version}</version>
            </dependency>

            <dependency>
                <groupId>commons-lang</groupId>
                <artifactId>commons-lang</artifactId>
                <version>${commons-lang.version}</version>
            </dependency>
            <dependency>
                <groupId>commons-collections</groupId>
                <artifactId>commons-collections</artifactId>
                <version>${commons-collections.version}</version>
            </dependency>
            <dependency>
                <groupId>commons-io</groupId>
                <artifactId>commons-io</artifactId>
                <version>${commons-io.version}</version>
            </dependency>
            <dependency>
                <groupId>io.springfox</groupId>
                <artifactId>springfox-boot-starter</artifactId>
                <version>${swagger2.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>

</project>
```



###### 3、itmk-base-common  pom.xml

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>itmk-base-parent</artifactId>
        <groupId>com.itmk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>itmk-base-common</artifactId>
    <dependencies>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!-- swagger api文档 -->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <!-- jwt-->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>0.9.0</version>
        </dependency>
        <!-- 工具类依赖 -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```



###### 4、itmk-base-web  pom.xml

```js
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>itmk-base-parent</artifactId>
        <groupId>com.itmk</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>itmk-base-web</artifactId>
    <dependencies>
        <dependency>
            <groupId>com.itmk</groupId>
            <artifactId>itmk-base-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--web启动器,对springmvc,serlvet等支持-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>

        <!--数据库依赖-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!--mybatis-plus启动器-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <!--druid连接池-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <!-- swagger api文档 -->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-compress</artifactId>
            <version>1.18</version>
        </dependency>
		<dependency>
            <groupId>commons-lang</groupId>
            <artifactId>commons-lang</artifactId>
        </dependency>
    </dependencies>
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>2.1.4.RELEASE</version>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>2.19.1</version>
                <configuration>
                    <skipTests>true</skipTests>    <!--打包过程默认关掉单元测试 -->
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
```



#### 第09讲 整合MyBatis Plus

mybatis plus官方教程**

```js
https://mp.baomidou.com/guide/
```



###### **1、新建application.yml文件**

​	1.1、在itmk-base-web模块resources文件下新建 application-test.yml文件

```js
#端口号配置
server:
  port: 8089
#数据库连接配置
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/sys_wygl?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
    username: root
    password: 123456

#mybatis plus配置
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      #配置mybatis plus 在更新时只更新非空和非NULL的字段
      update-strategy: not_empty

logging:
  pattern:
    console: '%d{yyyy-MM-dd} [%thread] %-5level %logger- %msg%n'
```

1.2、在itmk-base-web模块resources文件下新建 application.yml文件

```js
spring:
  profiles:
    active: test
```

###### 2、配置MyBatis Plus配置文件

```js
package com.itmk.config.mybatis;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.itmk.*.*.mapper")
public class MyBatisPlusConfig {
    // 最新版
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```



###### 3、封装返回值

在itmk-base-common下新建 com.itmk.utils包

```js
package com.itmk.utils;
import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class ResultVo<T> {
    private String msg;
    private int code;
    private T data;
}
```



###### 4、返回状态码定义

在itmk-base-common模块新建com.itmk.status包，然后新建 StatusCode类，如下所示

```js
package com.itmk.status;

/**
 * 返回状态码
 */
public class StatusCode {
    //返回成功
    public static final int SUCCESS_CODE = 200;
    //错误状态码
    public static final int ERROR_CODE = 500;
    //无权限
    public static final int NO_LOGIN = 600;
    public static final int NO_AUTH = 700;
}
```



###### 5、返回工具类的封装

在itmk-base-common模块下的com.itmk.utils包中新建ResultUtils类

```js
package com.itmk.utils;

import com.itmk.status.StatusCode;

/**
 * 数据返回工具类
 */
public class ResultUtils {
    /**
     * 无参数返回
     * @return
     */
    public static ResultVo succcess() {
        return Vo(null, StatusCode.SUCCESS_CODE, null);
    }
    public static ResultVo success(String msg){
        return Vo(msg,StatusCode.SUCCESS_CODE,null);
    }
    /**
     * 返回带参数
     * @param msg
     * @param data
     * @return
     */
    public static ResultVo success(String msg,Object data){
        return Vo(msg,StatusCode.SUCCESS_CODE,data);
    }
    public static ResultVo success(String msg,int code,Object data){
        return Vo(msg,code,data);
    }
    public static ResultVo Vo(String msg, int code, Object data) {
        return new ResultVo(msg, code, data);
    }

    /**
     * 错误返回
     * @return
     */
    public static ResultVo error(){
        return Vo(null,StatusCode.ERROR_CODE,null);
    }
    public static ResultVo error(String msg){
        return Vo(msg,StatusCode.ERROR_CODE,null);
    }
    public static ResultVo error(String msg,int code,Object data){
        return Vo(msg,code,data);
    }
    public static ResultVo error(String msg,int code){
        return Vo(msg,code,null);
    }
    public static ResultVo error(String msg,Object data){
        return Vo(msg, StatusCode.ERROR_CODE,data);
    }
}
```



#### 第10讲  用户管理列表页面制作

##### 1、sysUserList.vue页面编写

```js
<template>
  <el-main>
    <!-- 搜索栏   element ui的标签，就当做普通的div就可以，只是他添加了一些属性
    :model:  form表单绑定的数据，通常是一个对象
    :rules: form表单验证的规则
    ref :  类似div的id，是唯一的
    label-width：表单文字标签的宽度
    :inline ： 是否同一行显示
    size: 表单内组件的大小
     -->
    <el-form
      :model="listParm"
      ref="searchRef"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.nickName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input placeholder="请输入电话" v-model="listParm.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height='tableHeight' :data="tableData" border stripe>
      <el-table-column prop="name" label="姓名"></el-table-column>
      <el-table-column prop="address" label="地址"></el-table-column>
      <el-table-column prop="date" label="日期"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10,20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total" background>
    </el-pagination>
    
  </el-main>
</template>

<script>
export default {
  data() {
    return {
      //表格高度
      tableHeight:0,
      //列表查询的参数
      listParm: {
        phone: "",
        nickName: "",
        currentPage:1,
        pageSize:10,
        total:0
      },
      //表格的数据
      tableData: [
        {
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
        },
        {
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
    };
  },
  methods: {
    //重置按钮
    resetBtn(){

    },
    //搜索按钮
    searchBtn(){

    },
    //新增按钮
    addBtn() {},
    //编辑按钮
    editBtn(row) {},
    //删除按钮
    deleteBtn(row) {},
    //页容量改变触发
    sizeChange(val){

    },
    //页数改变触发
    currentChange(val){

    }
  },
  mounted(){
    this.$nextTick(() =>{
      this.tableHeight = window.innerHeight -220
    })
  }
};
</script>

<style lang="scss" scoped>
</style>
```

##### 2、分页插件显示中文

在main.js中引入如下，注释原来的local

```js
// import locale from 'element-ui/lib/locale/lang/en' // lang i18n
import locale from 'element-ui/lib/locale/lang/zh-CN'
```





#### 第11讲 通用弹框组件封装

```js
知识点：

父组件向子组件传值 ：属性绑定

子组件调用父组件的方法 : $emit向父组件触发事件
```



###### 1.封装效果

![](D:\Files\Simple\vue+springboot资料\资料\images\对话框.png)

###### 2.对话框官网 

https://element.eleme.cn/#/zh-CN/component/dialog

###### 3.对话框封装

在components下新建system目录，然后新建SysDialog.vue组件，然后把官网弹框代码复制进去

```js
<!--弹出框组件
  参数说明：
  title:弹出框标题
  visible:控制弹出框的显示和影藏
  width:弹出框的宽度，百分百，0~100的整数
  before-close：弹出框右上角关闭事件
  close-on-click-modal:防止点击弹出框以外的区域造成弹出框关闭
-->
<template>
  <div>
    <el-dialog
      top="5vh"
      :title="title"
      :visible.sync="visible"
      :width="width + 'px'"
      :before-close="onClose"
      :close-on-click-modal="false"
    >
     <div class="containner" :style="{ height: height + 'px' }">
      <slot name="content"></slot>
    </div>
      <span slot="footer" class="dialog-footer">
        <el-button @click="onClose">取 消</el-button>
        <el-button type="primary" @click="onConfirm">确 定</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
export default {
  props: {
    title: {
      type: String,
      default: "标题",
    },
    visible: {
      type: Boolean,
      default: false,
    },
    width: {
      type: Number,
      default: 600,
    },
    height: {
      type: Number,
      default: 250,
    },
  },
  data() {
    return {};
  },
  methods: {
    onClose() {
      this.$emit("onClose");
    },
    onConfirm() {
      this.$emit("onConfirm");
    },
  },
};
</script>

<style lang="scss" scoped>
.containner{
  overflow-x: initial;
  overflow-y: auto;
}
        
.el-dialog__wrapper {
  ::v-deep .el-dialog {
    border-top-left-radius: 7px !important;
    border-top-right-radius: 7px !important;
    .el-dialog__header {
      border-top-left-radius: 7px !important;
      border-top-right-radius: 7px !important;
      background-color: #1890ff;
      .el-dialog__title {
        color: #fff;
        font-size: 15px;
        font-weight: 700;
      }
      .el-dialog__close {
        color: #fff;
      }
    }
    .el-dialog__body {
      padding: 10px 10px !important;
    }
    .el-dialog__footer {
      border-top: 1px solid #e8eaec !important;
      padding: 10px !important;
    }
  }
}
</style>

```

###### 4.测试官网对话框

​	找到sysUserList.vue组件，然后引入SysDialog.vue组件，并注册SysDialog组件

```js
<template>
  <div>
   <sys-dialog
      :title="addDialog.title"
      :visible="addDialog.visible"
      :width="addDialog.width"
      :height="addDialog.height"
      @onClose="onColse"
      @onConfirm="onConfirm"
    >
      <div slot="content">弹框内容</div>
    </sys-dialog>
  </div>
</template>

<script>
import SysDialog from "@/components/system/SysDialog";
export default {
  components: { 
      SysDialog 
  },
  data(){
      return{
          addDialog: {
        title: "新增用",
        visible: false,
        width: 600,
        height: 250,
      },
      }
  },
  methods:{
       //弹框取消事件
    onColse() {
      this.addDialog.visible = false;
    },
    //弹框确认事件
    onConfirm() {
      this.addDialog.visible = false;
    },
  }
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第12讲 新增用户页面布局讲解

##### 1、解决点击弹框外关闭问题

```js
1、添加  :close-on-click-modal='false'  属性
```

##### 2、新增表单效果

![](D:\Files\Simple\vue+springboot资料\资料\images\新增用户弹框.png)

##### 3、代码

```js
<!-- 新增或编辑弹框组件 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- form表单
        el-form ： 当做普通的form标签
        model ： 表单数据对象
        ref : 相当于div的id,唯一的
        rules : 表单验证规则
        label-width ： 表单域标签的宽度
        inline ： 是否在同一行显示，如果和el-row使用的时候，不需要添加该属性
        size ： 尺寸
        el-form-item ： 当做普通的div，
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="60px"
          size="small"
          style="margin-right: 20px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
```





#### 第13讲 表单验证规则

##### 1、表单验证的关键

```js
1、给表单添加ref属性
2、给el-form-item添加prop属性
3、定义表单验证的规则
4、表单提交时，通过 this.$refs.表单的ref.validate()
```



#### 第14讲 用户管理接口开发

##### 1、新建用户实体类

新建com.itmk.web.sys_user.entity包，然后新建SysUser实体类

```js
package com.itmk.web.sys_user.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

@Data
@TableName("sys_user")
public class SysUser {
    @TableId(type = IdType.AUTO)
    private Long userId;
    private String username;
    private String password;
    private String phone;
    private String email;
    private String sex;
    private String isAdmin;
     //帐户是否过期(1 未过期，0已过期)
    private boolean isAccountNonExpired = true;
    //帐户是否被锁定(1 未锁定，0已锁定)
    private boolean isAccountNonLocked = true;
    //密码是否过期(1 未过期，0已过期)
    private boolean isCredentialsNonExpired = true;
    //帐户是否可用(1 可用，0 删除用户)
    private boolean isEnabled = true;
    private String nickName;
    //创建时间
    private Date createTime;
    //更新时间
    private Date updateTime;
}

```

##### 2、新建mapper接口

```js
package com.itmk.web.sys_user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_user.entity.SysUser;

public interface SysUserMapper extends BaseMapper<SysUser> {
}

```

##### 3、新建mapper接口映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_user.mapper.SysUserMapper">

</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.sys_user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;

public interface SysUserService extends IService<SysUser> {
    IPage<SysUser> list(PageParm parm);
}

```

**参数接收类**

```js
package com.itmk.web.sys_user.entity;

import lombok.Data;

@Data
public class PageParm {
    private Long currentPage;
    private Long pageSize;
    private String phone;
    private String nickName;
}

```



**实现类**

```js
package com.itmk.web.sys_user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.mapper.SysUserMapper;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
    @Override
    public IPage<SysUser> list(PageParm parm) {
        //构造分页对象
        IPage<SysUser> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        //构造查询条件
        if(StringUtils.isNotEmpty(parm.getNickName())){
            query.lambda().like(SysUser::getNickName,parm.getNickName());
        }
        if(StringUtils.isNotEmpty(parm.getPhone())){
            query.lambda().like(SysUser::getPhone,parm.getPhone());
        }
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 5、新建控制器层

```js
package com.itmk.web.sys_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/user")
public class SysUserController {
    @Autowired
    private SysUserService sysUserService;

    //新增员工
    @PostMapping
    public ResultVo addUser(@RequestBody SysUser sysUser){
        //判断用户名是否存在
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,sysUser.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null){
            return ResultUtils.error("账户已经被占用");
        }
        //密码加密
        if(StringUtils.isNotEmpty(sysUser.getPassword())){
            sysUser.setPassword(DigestUtils.md5DigestAsHex(sysUser.getPassword().getBytes()));
        }
        sysUser.setIsAdmin("0");
        sysUser.setCreateTime(new Date());
        //存入数据库
        boolean save = sysUserService.save(sysUser);
        if(save){
            return ResultUtils.success("新增用户成功!");
        }
        return  ResultUtils.error("新增用户失败!");
    }

    //编辑员工
    @PutMapping
    public ResultVo editUser(@RequestBody SysUser sysUser){
        //判断用户名是否存在
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,sysUser.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null && one.getUserId() != sysUser.getUserId()){
            return ResultUtils.error("账户已经被占用");
        }
        //密码加密
        if(StringUtils.isNotEmpty(sysUser.getPassword())) {
            sysUser.setPassword(DigestUtils.md5DigestAsHex(sysUser.getPassword().getBytes()));
        }
        sysUser.setUpdateTime(new Date());
        //存入数据库
        boolean save = sysUserService.updateById(sysUser);
        if(save){
            return ResultUtils.success("编辑用户成功!");
        }
        return  ResultUtils.error("编辑用户失败!");
    }

    //删除用户
    @DeleteMapping("/{userId}")
    public ResultVo deleteUser(@PathVariable("userId") Long userId){
        boolean remove = sysUserService.removeById(userId);
        if(remove){
            return ResultUtils.success("删除用户成功!");
        }
        return ResultUtils.error("删除用户失败!");
    }
    //用户列表
    @GetMapping("/list")
    public ResultVo getList(PageParm parm){
        IPage<SysUser> list = sysUserService.list(parm);
        //密码不显示
        list.getRecords().stream().forEach(item ->{
            item.setPassword("");
        });
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第15讲 用户管理列表接口对接

##### 1、安装qs

```js
npm install qs
```

##### 2、新建http.js

```js
import axios from 'axios'
import { MessageBox, Message } from 'element-ui'
import store from '@/store'
import { getToken } from '@/utils/auth'
import qs from 'qs'
// create an axios instance
//创建一个axios实例
const service = axios.create({
  baseURL: process.env.VUE_APP_BASE_API_PRO, // url = base url + request url
  // withCredentials: true, // send cookies when cross-domain requests
  timeout: 5000 // request timeout
})

// request interceptor
//请求发送之前的拦截器
service.interceptors.request.use(
  config => {
    // do something before request is sent
    //如果token存在，把token添加到请求的头部
    if (store.getters.token) {
      // let each request carry token
      // ['X-Token'] is a custom headers key
      // please modify it according to the actual situation
      config.headers['token'] = getToken()
    }
    return config
  },
  error => {
    // do something with request error
    console.log(error) // for debug
    return Promise.reject(error)
  }
)

// response interceptor
//请求返回之后的处理
service.interceptors.response.use(
  /**
   * If you want to get http information such as headers or status
   * Please return  response => response
  */

  /**
   * Determine the request status by custom code
   * Here is just an example
   * You can also judge the status by HTTP Status Code
   */
  response => {
    const res = response.data

    // if the custom code is not 20000, it is judged as an error.
    if (res.code !== 200) {
      Message({
        message: res.msg || '服务器出错',
        type: 'error',
        duration: 5 * 1000
      })

      //600是token过期或token验证失败 50008: Illegal token; 50012: Other clients logged in; 50014: Token expired;
      if (res.code === 600) {
        // to re-login
        MessageBox.confirm('您的登录信息已过期，请重新登录！', '系统提示', {
          confirmButtonText: '去登录',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          store.dispatch('user/resetToken').then(() => {
            location.reload()
          })
        })
      }
      return Promise.reject(new Error(res.msg || '服务器出错'))
    } else {
      return res
    }
  },
  error => {
    console.log('err' + error) // for debug
    Message({
      message: error.msg || '服务器出错!',
      type: 'error',
      duration: 5 * 1000
    })
    return Promise.reject(error)
  }
)

//请求方法
const http = {
    post(url, params) {
      return service.post(url, params, {
        transformRequest: [(params) => {
          return JSON.stringify(params)
        }],
        headers: {
          'Content-Type': 'application/json'
        }
      })
    },
    put(url, params) {
      return service.put(url, params, {
        transformRequest: [(params) => {
          return JSON.stringify(params)
        }],
        headers: {
          'Content-Type': 'application/json'
        }
      })
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user?id=10
    get(url, params) {
      return service.get(url, {
        params: params,
        paramsSerializer: (params) => {
          return qs.stringify(params)
        }
      })
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user/10
    getRestApi(url, params) {
      let _params
      if (Object.is(params, undefined || null)) {
        _params = ''
      } else {
        _params = '/'
        for (const key in params) {
          console.log(key)
          console.log(params[key])
          // eslint-disable-next-line no-prototype-builtins
          if (params.hasOwnProperty(key) && params[key] !== null && params[key] !== '') {
            _params += `${params[key]}/`
          }
        }
        //去掉参数最后一位?
        _params = _params.substr(0, _params.length - 1)
      }
      console.log(_params)
      if (_params) {
        return service.get(`${url}${_params}`)
      } else {
        return service.get(url)
      }
    },
    //parm =>  {id:10}
    // http://localhost:8089/api/user/10
    delete(url, params) {
      let _params
      if (Object.is(params, undefined || null)) {
        _params = ''
      } else {
        _params = '/'
        for (const key in params) {
          // eslint-disable-next-line no-prototype-builtins
          if (params.hasOwnProperty(key) && params[key] !== null && params[key] !== '') {
            _params += `${params[key]}/`
          }
        }
        //去掉参数最后一位?
        _params = _params.substr(0, _params.length - 1)
      }
      if (_params) {
        return service.delete(`${url}${_params}`).catch(err => {
          // message.error(err.msg)
          return Promise.reject(err)
        })
      } else {
        return service.delete(url).catch(err => {
          // message.error(err.msg)
          return Promise.reject(err)
        })
      }
    },
    upload(url, params) {
      return service.post(url, params, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
    }
  }
  export default http

```

##### 3、api/user添加getUserListApi()方法

```js
//获取用户列表
export const getUserListApi = async(parm) =>{
  return await http.get("/api/user/list",parm)
}
```



##### 4、sysUserList.vue页面使用



##### 5、跨域解决

```js
package com.itmk.config.web;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    /**
     * 跨域配置
     * @param registry
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*")
                .allowedHeaders("*")
                .maxAge(3600)
                .allowCredentials(true);
    }
}
```





#### 第16讲 常用工具的封装



##### 1、对象的快速复制

```js
//对象的快速复制
export default async function objCoppy(obj1,obj2){
    Object.keys(obj2).forEach(key =>{
        obj2[key] = obj1[key]
    })
}
```



##### 2、清空表单

```js
//表单清空
// formName: 表单的ref属性  obj表单的数据域
export default function resetForm(formName,obj){
    //清空表单
    if(this.$refs[formName]){
        this.$refs[formName].resetFields();
        this.$refs[formName].clearValidate();
    }
    //清空数据域
    Object.keys(obj).forEach(key =>{
        obj[key] = '';
    })
}
```



##### 3、信息确认弹框封装

```js
import {MessageBox,Message} from 'element-ui'
//信息确认弹框封装
export default function myconfirm(text){
    return new Promise((resolve,reject)=>{
        MessageBox.confirm(text,'系统提示',{
            confirmButtonText:'确定',
            cancelButtonText:'取消',
            type:'warning'
        }).then(()=>{
            resolve(true);
        }).catch(()=>{
            Message.warning('已取消')
            reject(false)
        })
    }).catch(()=>{
        return false;
    })
}
```



##### 4、main.js全局挂载

```js
//清空表单
import resetForm from '@/utils/resetForm'
Vue.prototype.$resetForm = resetForm;
//信息提示框
import myconfirm from '@/utils/myconfirm'
Vue.prototype.$myconfirm = myconfirm;
//对象快速复制
import objCoppy from '@/utils/objCoppy'
Vue.prototype.$objCoppy = objCoppy;
```





#### 第17讲 新增、编辑接口对接

##### 1、api/user下新增如下方法

```js
//新增
export const addUserApi = async (parm) => {
  return await http.post("/api/user", parm)
}
//编辑
export const editUserApi = async (parm) => {
  return await http.put("/api/user", parm)
}
```

##### 2、sysUserList.vue页面

```js
<template>
  <!-- 只需要把element的标签，当做一个普通的div -->
  <el-main>
    <!-- 搜索栏 
    :model： 表单绑定的数据，通常是一个对象
    ref ： 相当于一个div的id,唯一的
    :rules ： 表单验证的规则
    label-width： 表单域标签的宽度，例如 '50px'
    :inline ： 是否在同一行显示
    size： 尺寸
    -->
    <el-form
      :model="listParm"
      ref="form"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.nickName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input placeholder="请输入电话" v-model="listParm.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 
    :data 表格的数据

    -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="nickName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="email" label="邮箱"></el-table-column>
      <el-table-column label="操作" width="180" align="center">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="editBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框组件 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- el-form :当做一个普通的form标签
        el-input : 相当于 普通的 input标签
          el-form-item ： 表单的每一项
          model ： 表单绑定的数据
          ref ： 相当于一个div的id , 唯一的
          rules : 表单验证规则
          label-width ： 表单域标签的宽度
          inline ： 是否在同一行显示，如果和el-row使用时，不需要该属性
          size ： 尺寸
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 40px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="nickName" label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addUserApi, editUserApi } from "@/api/user";
//引入弹框组件
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册弹框组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        nickName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写账户",
          },
        ],
        password: [
          {
            trigger: "blur",
            required: true,
            message: "请填写密码",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        type: "",
        userId: "",
        nickName: "",
        phone: "",
        email: "",
        sex: "",
        username: "",
        password: "",
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        width: 630,
        height: 200,
      },
      //表格的高度
      tableHeight: 0,
      listParm: {
        total: 0,
        pageSize: 10, //默认每页显示10条数据
        currentPage: 1,
        nickName: "",
        phone: "",
      },
      tableData: [],
    };
  },
  created() {
    this.getList();
  },
  methods: {
    async getList() {
      let res = await getListApi(this.listParm);
      console.log("请求成功");
      console.log(res);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //弹框的确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          this.dialog.visible = false;
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          } else {
            res = await editUserApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表单
            this.getList();
            this.$message({ type: "success", message: res.msg });
          }
        }
      });
    },
    //弹框的取消
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑标识
      this.addModel.type = "1";
    },
    //搜索按钮
    searchBtn() {},
    //搜索按钮
    resetBtn() {},
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置编辑标识
      this.addModel.type = "0";
    },
  },
  mounted() {
    this.$nextTick(() => {
      //计算表格的高度
      this.tableHeight = window.innerHeight - 220;
    });
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第18讲 删除、搜索功能对接

##### 1、api/user下新建如下方法

```js
//删除
export const deleteUserApi = async(parm) =>{
  return await http.delete("/api/user",parm)
}

```

##### 2、sysUserList.vue

```js
<template>
  <!-- 只需要把element的标签，当做一个普通的div -->
  <el-main>
    <!-- 搜索栏 
    :model： 表单绑定的数据，通常是一个对象
    ref ： 相当于一个div的id,唯一的
    :rules ： 表单验证的规则
    label-width： 表单域标签的宽度，例如 '50px'
    :inline ： 是否在同一行显示
    size： 尺寸
    -->
    <el-form
      :model="listParm"
      ref="form"
      label-width="80px"
      :inline="true"
      size="small"
    >
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.nickName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input placeholder="请输入电话" v-model="listParm.phone"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 
    :data 表格的数据

    -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="nickName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="email" label="邮箱"></el-table-column>
      <el-table-column label="操作" width="180" align="center">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框组件 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- el-form :当做一个普通的form标签
        el-input : 相当于 普通的 input标签
          el-form-item ： 表单的每一项
          model ： 表单绑定的数据
          ref ： 相当于一个div的id , 唯一的
          rules : 表单验证规则
          label-width ： 表单域标签的宽度
          inline ： 是否在同一行显示，如果和el-row使用时，不需要该属性
          size ： 尺寸
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 40px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="nickName" label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListApi, addUserApi, editUserApi, deleteUserApi } from "@/api/user";
//引入弹框组件
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册弹框组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        nickName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写账户",
          },
        ],
        password: [
          {
            trigger: "blur",
            required: true,
            message: "请填写密码",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        type: "",
        userId: "",
        nickName: "",
        phone: "",
        email: "",
        sex: "",
        username: "",
        password: "",
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        width: 630,
        height: 200,
      },
      //表格的高度
      tableHeight: 0,
      listParm: {
        total: 0,
        pageSize: 10, //默认每页显示10条数据
        currentPage: 1,
        nickName: "",
        phone: "",
      },
      tableData: [],
    };
  },
  created() {
    this.getList();
  },
  methods: {
    async getList() {
      let res = await getListApi(this.listParm);
      console.log("请求成功");
      console.log(res);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //弹框的确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          this.dialog.visible = false;
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          } else {
            res = await editUserApi(this.addModel);
          }
          if (res && res.code == 200) {
            //刷新表单
            this.getList();
            this.$message({ type: "success", message: res.msg });
          }
        }
      });
    },
    //弹框的取消
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把当前要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑标识
      this.addModel.type = "1";
    },
    //删除按钮
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteUserApi({ userId: row.userId });
        if (res && res.code == 200) {
          //刷新表单
          this.getList();
          this.$message({ type: "success", message: res.msg });
        }
      }
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //搜索按钮
    resetBtn() {
      this.listParm.nickName = "";
      this.listParm.phone = "";
      this.getList();
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置编辑标识
      this.addModel.type = "0";
    },
  },
  mounted() {
    this.$nextTick(() => {
      //计算表格的高度
      this.tableHeight = window.innerHeight - 220;
    });
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第19讲 角色管理模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

@Data
@TableName("sys_role")
public class SysRole {
    @TableId(type = IdType.AUTO)
    private Long roleId;
    private String roleName;
    private String roleType;
    private String remark;
    private Date createTime;
    private Date updateTime;
}

```

**列表参数接收**

```js
package com.itmk.web.sys_role.entity;

import lombok.Data;

@Data
public class RoleParm {
    private Long currentPage;
    private Long pageSize;
    private String roleName;
}

```

##### 2、新建mapper

```js
package com.itmk.web.sys_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_role.entity.SysRole;

public interface SysRoleMapper extends BaseMapper<SysRole> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_role.mapper.SysRoleMapper">

</mapper>
```

##### 3、service层

```js
package com.itmk.web.sys_role.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_role.entity.RoleParm;
import com.itmk.web.sys_role.entity.SysRole;

public interface SysRoleService extends IService<SysRole> {
    IPage<SysRole> list(RoleParm parm);
}

```

**实现类**

```js
package com.itmk.web.sys_role.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_role.entity.RoleParm;
import com.itmk.web.sys_role.entity.SysRole;
import com.itmk.web.sys_role.mapper.SysRoleMapper;
import com.itmk.web.sys_role.service.SysRoleService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> implements SysRoleService {
    @Override
    public IPage<SysRole> list(RoleParm parm) {
        //构造分页对象
        IPage<SysRole> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        //构造查询条件
        QueryWrapper<SysRole> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getRoleName())){
            query.lambda().like(SysRole::getRoleName,parm.getRoleName());
        }
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 4、控制器

```js
package com.itmk.web.sys_role.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_role.entity.RoleParm;
import com.itmk.web.sys_role.entity.SysRole;
import com.itmk.web.sys_role.service.SysRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/role")
public class SysRoleController {
    @Autowired
    private SysRoleService sysRoleService;

    //新增角色
    @PostMapping
    public ResultVo addRole(@RequestBody SysRole role){
        role.setCreateTime(new Date());
        boolean save = sysRoleService.save(role);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑角色
    @PutMapping
    public ResultVo editRole(@RequestBody SysRole role){
        role.setUpdateTime(new Date());
        boolean save = sysRoleService.updateById(role);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除角色
    @DeleteMapping("/{roleId}")
    public ResultVo deleteRole(@PathVariable("roleId") Long roleId){
        boolean b = sysRoleService.removeById(roleId);
        if(b){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //角色列表
    @GetMapping("/list")
    public ResultVo getList(RoleParm parm){
        IPage<SysRole> list = sysRoleService.list(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第20讲角色管理列表制作

##### 1、src/api新建role.js

```js
import http from '@/utils/http'
//获取列表
export const getListApi = async(parm) =>{
    return await http.get("/api/role/list",parm)
}
```

##### 2、sysRoleList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" ref="searchRef" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670">重置</el-button>
        <el-button type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="备注"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/role";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //搜索栏数据
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格数据
      tableData: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第21讲 新增、编辑制作与对接

##### 1、src/api/role.js添加如下方法

```js
//新增
export const addRoleApi = async(parm) =>{
     return await http.post("/api/role",parm)
}
//编辑
export const editRoleApi = async(parm) =>{
    return await http.put("/api/role",parm)
}
```

##### 2、sysRoleList.vue

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" ref="searchRef" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670">重置</el-button>
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="备注"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button type="primary" icon="el-icon-edit" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button type="danger" icon="el-icon-delete" size="small" @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleType" label="角色类型">
                <el-select v-model="addModel.roleType" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, addRoleApi, editRoleApi } from "@/api/role";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //角色类型
      options: [
        {
          value: "1",
          label: "系统用户",
        },
        {
          value: "2",
          label: "学生",
        },
        {
          value: "3",
          label: "教师",
        },
      ],
      //表单验证
      rules: {
        roleName: [
          {
            required: true,
            message: "请输入角色名称",
            trigger: "blur",
          },
        ],
        roleType: [
          {
            required: true,
            message: "请选择角色类型",
            trigger: "blur",
          },
        ],
      },
      //新增表单绑定的数据
      addModel: {
        type: "", //0：新增 1：编辑
        roleId: "",
        roleName: "",
        roleType: "",
        remark: "",
      },
      //弹框属性
      dialog: {
        height: 150,
        visible: false,
        title: "",
      },
      //表格高度
      tableHeight: 0,
      //搜索栏数据
      listParm: {
        roleName: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格数据
      tableData: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增角色";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm('addRef',this.addModel)
      //设置为新增
      this.addModel.type = '0'
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async(valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新列表
            this.getList();
          }
        }
      });
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        //设置表格数据
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = '编辑角色'
      this.dialog.visible = true;
      //清空表单
      this.$resetForm('addRef',this.addModel)
      //设置为编辑
      this.addModel.type = '1'
      //把当前要编辑的数据设置到表单数据域
      this.$objCoppy(row,this.addModel)
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第22讲 删除、搜索功能对接

##### 1、api/role.js添加如下方法

```
//删除
export const deleteRoleApi = async(parm) =>{
    return await http.delete("/api/role",parm)
}
```

##### 2、sysRoleList.vue组件

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="searchBtn" icon="el-icon-search">搜索</el-button>
        <el-button @click="resetBtn" icon="el-icon-close" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="remark" label="角色备注"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, addRoleApi, editRoleApi, deleteRoleApi } from "@/api/role";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证
      rules: {
        roleName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写角色名称",
          },
        ],
      },
      //表单数据
      addModel: {
        type: "", // 0：新增 1：编辑
        roleId: "",
        roleName: "",
        remark: "",
      },
      //弹框属性
      dialog: {
        title: "",
        height: 150,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //列表查询参数
      listParm: {
        pageSize: 10,
        currentPage: 1,
        roleName: "",
        total: 0,
      },
      tableData: [],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          this.dialog.visible = false;
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      //确定
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteRoleApi({ roleId: row.roleId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.visible = true;
      this.dialog.title = "新增角色";
      //清空表单数据
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据放到表单数据对象
      this.$objCoppy(row, this.addModel);
      this.addModel.type = "1"; //编辑
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.visible = true;
      this.dialog.title = "新增角色";
      //清空表单数据
      this.$resetForm("addRef", this.addModel);
      //
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.listParm.roleName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第23讲 菜单管理模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_menu.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Data
@TableName("sys_menu")
public class SysMenu {
    @TableId(type = IdType.AUTO)
    private Long menuId;
    private Long parentId;
    private String title;
    private String code;
    private String name;
    private String path;
    private String url;
    //类型(0 目录 1菜单，2按钮)
    private String type;
    private String icon;
    private String parentName;
    private Long orderNum;
    private Date createTime;
    private Date updateTime;
    //该字段不属于数据库表，需要排除
    @TableField(exist = false)
    private List<SysMenu> children = new ArrayList<>();
}

```

##### 2、新建mapper

```js
package com.itmk.web.sys_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_menu.entity.SysMenu;

public interface SysMenuMapper extends BaseMapper<SysMenu> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_menu.mapper.SysMenuMapper">

</mapper>
```

##### 3、新建service

```js
package com.itmk.web.sys_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_menu.entity.SysMenu;

import java.util.List;

public interface SysMenuService extends IService<SysMenu> {
    List<SysMenu> menuList();
}

```

**实现类**

```js
package com.itmk.web.sys_menu.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_menu.entity.MakeTree;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.mapper.SysMenuMapper;
import com.itmk.web.sys_menu.service.SysMenuService;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class SysMenuServiceImpl extends ServiceImpl<SysMenuMapper, SysMenu> implements SysMenuService {

    @Override
    public List<SysMenu> menuList() {
        //查询列表
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().orderByAsc(SysMenu::getOrderNum);
        List<SysMenu> menuList = this.baseMapper.selectList(query);
        //组装树
        List<SysMenu> list = MakeTree.makeMenuTree(menuList, 0L);
        return list;
    }
}

```

```js
package com.itmk.web.sys_menu.entity;

import org.springframework.beans.BeanUtils;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

public class MakeTree {

    public static List<SysMenu> makeMenuTree(List<SysMenu> menuList, Long pid) {
        List<SysMenu> list = new ArrayList<>();
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item -> item != null && item.getParentId() == pid)
                .forEach(dom -> {
                    SysMenu menu = new SysMenu();
                    BeanUtils.copyProperties(dom, menu);
                    //查询该项的下级菜单
                    List<SysMenu> sysMenus = makeMenuTree(menuList, dom.getMenuId());
                    menu.setChildren(sysMenus);
                    list.add(menu);
                });
        return list;
    }
}

```

##### 4、新建控制器

```js
package com.itmk.web.sys_menu.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_menu.entity.SysMenu;
import com.itmk.web.sys_menu.service.SysMenuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;
import java.util.List;

@RestController
@RequestMapping("/api/menu")
public class SysMenuController {
    @Autowired
    private SysMenuService sysMenuService;

    //新增
    @PostMapping
    public ResultVo addMenu(@RequestBody SysMenu menu){
        menu.setCreateTime(new Date());
        boolean save = sysMenuService.save(menu);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑
    @PutMapping
    public ResultVo editMenu(@RequestBody SysMenu menu){
        menu.setUpdateTime(new Date());
        boolean save = sysMenuService.updateById(menu);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{menuId}")
    public ResultVo deleteMenu(@PathVariable("menuId") Long menuId){
        //判断是否有下级，有下级，不能删除
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().eq(SysMenu::getParentId,menuId);
        List<SysMenu> list = sysMenuService.list(query);
        if(list.size() > 0){
            return ResultUtils.error("该菜单存在下级，不能删除!");
        }
        boolean save = sysMenuService.removeById(menuId);
        if(save){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //菜单列表
    public ResultVo getList(){
        List<SysMenu> list = sysMenuService.menuList();
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第24讲 菜单管理列表制作

##### 1、api下新建menu.js

```js
import http from '@/utils/http'
export const getMenuListApi = async() =>{
    return await http.get("/api/menu/list",null)
}
```

##### 2、sysMenuList.vue

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button type="primary" icon="el-icon-plus">新增</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="id"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="date" label="日期" sortable width="180">
      </el-table-column>
      <el-table-column prop="name" label="姓名" sortable width="180">
      </el-table-column>
      <el-table-column prop="address" label="地址"> </el-table-column>
    </el-table>
  </el-main>
</template>

<script>
import {getMenuListApi} from '@/api/menu'
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [
        {
          id: 1,
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          id: 2,
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          id: 3,
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
          children: [
            {
              id: 31,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
            {
              id: 32,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
          ],
        },
        {
          id: 4,
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created(){
    this.getList()
  },
  methods:{
    async getList(){
      let res = await getMenuListApi()
      if(res && res.code == 200){
        console.log(res)
        // this.tableData = res.data
      }
    }
  }
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第25讲 新增菜单制作

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="id"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="date" label="日期" sortable width="180">
      </el-table-column>
      <el-table-column prop="name" label="姓名" sortable width="180">
      </el-table-column>
      <el-table-column prop="address" label="地址"> </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right:8px;"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input v-model="addModel.parentName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getMenuListApi } from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {},
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width:650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [
        {
          id: 1,
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          id: 2,
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          id: 3,
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
          children: [
            {
              id: 31,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
            {
              id: 32,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
          ],
        },
        {
          id: 4,
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
    },
    //弹框确定
    onConfirm() {
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        // this.tableData = res.data
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第26讲选择上级菜单

##### 1、SysMenuService接口添加如下方法

```js
List<SysMenu> parentList();
```

**实现类**

```js
 @Override
    public List<SysMenu> parentList() {
        String[] types = {"0","1"};
        QueryWrapper<SysMenu> query = new QueryWrapper<>();
        query.lambda().in(SysMenu::getType, Arrays.asList(types)).orderByAsc(SysMenu::getOrderNum);
        List<SysMenu> menuList = this.baseMapper.selectList(query);
        //组装顶级菜单，防止无数据的时候，没有菜单
        SysMenu menu = new SysMenu();
        menu.setMenuId(0L);
        menu.setParentId(-1L);
        menu.setTitle("顶级菜单");
        menuList.add(menu);
        List<SysMenu> list = MakeTree.makeMenuTree(menuList, -1L);
        return list;
    }
```

##### 2、控制器

```js
//上级菜单列表
    @GetMapping("/parent")
    public ResultVo getParentList(){
        List<SysMenu> list = sysMenuService.parentList();
        return ResultUtils.success("查询成功",list);
    }
```

##### 3、api/menu.js

```js
//上级菜单树
export const getParentMenuListApi = async() =>{
    return await http.get("/api/menu/parent",null)
}
```

##### 4、上级菜单弹框

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="id"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="date" label="日期" sortable width="180">
      </el-table-column>
      <el-table-column prop="name" label="姓名" sortable width="180">
      </el-table-column>
      <el-table-column prop="address" label="地址"> </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 8px"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input
                  @click.native="selectParent"
                  readonly
                  v-model="addModel.parentName"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级部门弹框 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="parentData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          default-expand-all
          :expand-on-click-node="false"
          @node-click="handleNodeClick"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getMenuListApi, getParentMenuListApi } from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //上级菜单树数据
      parentData: [],
      //上级弹框属性
      parentDialog: {
        width: 300,
        title: "选择上级菜单",
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {},
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [
        {
          id: 1,
          date: "2016-05-02",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1518 弄",
        },
        {
          id: 2,
          date: "2016-05-04",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1517 弄",
        },
        {
          id: 3,
          date: "2016-05-01",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1519 弄",
          children: [
            {
              id: 31,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
            {
              id: 32,
              date: "2016-05-01",
              name: "王小虎",
              address: "上海市普陀区金沙江路 1519 弄",
            },
          ],
        },
        {
          id: 4,
          date: "2016-05-03",
          name: "王小虎",
          address: "上海市普陀区金沙江路 1516 弄",
        },
      ],
      selectNode: {
        id: "",
        title: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //上级树节点点击事件
    handleNodeClick(node) {
      console.log(node);
      this.selectNode.id = node.menuId
      this.selectNode.title = node.title
    },
    parentConfirm() {
      this.addModel.parentId = this.selectNode.id
      this.addModel.parentName = this.selectNode.title
      this.parentDialog.visible = false;
    },
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单
    async selectParent() {
      let res = await getParentMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.parentData = res.data;
      }
      console.log(this.parentData);
      this.parentDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
    },
    //弹框确定
    onConfirm() {
      this.dialog.visible = false;
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        // this.tableData = res.data
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第27讲 菜单新增对接

##### 1、api/menu.js添加如下方法

```js
export const addMenuApi = async(parm) =>{
    return await http.post("/api/menu",parm)
}
//编辑
export const editMenuApi = async(parm) =>{
    return await http.put(parm)
}
```

##### 2、sysMenuList.vue

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="menuId"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="title" label="菜单名称"> </el-table-column>
      <el-table-column prop="title" label="菜单图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="菜单类型"> 
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'">目录</el-tag>
          <el-tag type="success" v-if="scope.row.type == '1'">菜单</el-tag>
          <el-tag type="danger" v-if="scope.row.type == '2'">按钮</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="路由名称"> </el-table-column>
      <el-table-column prop="path" label="路由地址"> </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 8px"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="parentName" label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input
                  @click.native="selectParent"
                  v-model="addModel.parentName"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="title" label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item prop="name" label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item prop="path" label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="url" label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级菜单 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          :data="treeData"
          :props="defaultProps"
          @node-click="handleNodeClick"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getMenuListApi,
  getParentMenuListApi,
  addMenuApi,
  editMenuApi,
} from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //上级菜单数据
      treeData: [],
      //上级弹框属性
      parentDialog: {
        width: 300,
        title: "选择上级菜单",
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            trigger: "blur",
            required: true,
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            trigger: "blur",
            required: true,
            message: "请选择上级菜单",
          },
        ],
        title: [
          {
            trigger: "blur",
            required: true,
            message: "请填写菜单名称",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            trigger: "blur",
            required: true,
            message: "请填写组件路径",
          },
        ],
      },
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //树选择的数据
      selectNode: {
        id: "",
        title: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //上级菜单树点击事件
    handleNodeClick(node) {
      console.log(node);
      this.selectNode.id = node.menuId;
      this.selectNode.title = node.title;
    },
    //上级菜单确定事件
    parentConfirm() {
      this.addModel.parentId = this.selectNode.id;
      this.addModel.parentName = this.selectNode.title;
      this.parentDialog.visible = false;
      console.log(this.addModel);
    },
    //上级菜单关闭事件
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单事件
    async selectParent() {
      //查询上级菜单树数据
      let res = await getParentMenuListApi();
      if (res && res.code == 200) {
        this.treeData = res.data;
      }
      this.parentDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.editType = "0";
    },
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addMenuApi(this.addModel);
          } else {
            res = await editMenuApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第28讲 菜单编辑、删除接口对接

##### 1、api/menu.js添加如下方法

```js
import http from '@/utils/http'
//列表
export const getMenuListApi = async() =>{
    return await http.get("/api/menu/list",null)
}
//上级列表
export const getParentMenuListApi = async() =>{
    return await http.get("/api/menu/parent",null)
}
//新增
export const addMenuApi = async(parm) =>{
    return await http.post("/api/menu",parm)
}
//编辑
export const editMenuApi = async(parm) =>{
    return await http.put("/api/menu",parm)
}
//删除
export const deleteMenuApi = async(parm) =>{
    return await http.delete("/api/menu",parm)
}
```



##### 2、sysMenuList.vue

```js
<template>
  <el-main>
    <el-form size="small">
      <el-form-item>
        <el-button @click="addBtn" type="primary" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      :height="tableHeight"
      :data="tableData"
      border
      stripe
      row-key="menuId"
      default-expand-all
      :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
    >
      <el-table-column prop="title" label="菜单名称"> </el-table-column>
      <el-table-column prop="title" label="菜单图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="菜单类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.type == '0'">目录</el-tag>
          <el-tag type="success" v-if="scope.row.type == '1'">菜单</el-tag>
          <el-tag type="danger" v-if="scope.row.type == '2'">按钮</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="name" label="路由名称"> </el-table-column>
      <el-table-column prop="path" label="路由地址"> </el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 新增、编辑 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 8px"
        >
          <el-row>
            <el-col :span="24" :offset="0">
              <el-form-item prop="type" label="菜单类型">
                <el-radio-group v-model="addModel.type">
                  <el-radio :label="'0'">目录</el-radio>
                  <el-radio :label="'1'">菜单</el-radio>
                  <el-radio :label="'2'">按钮</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="parentName" label="上级菜单">
                <!-- <el-input type="hidden" v-model="addModel.parentId"></el-input> -->
                <el-input
                  @click.native="selectParent"
                  v-model="addModel.parentName"
                ></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="title" label="菜单名称">
                <el-input v-model="addModel.title"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col v-if="addModel.type != '2'" :span="12" :offset="0">
              <el-form-item label="菜单图标">
                <el-input v-model="addModel.icon"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '1'" :span="12" :offset="0">
              <el-form-item prop="name" label="路由名称">
                <el-input v-model="addModel.name"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row v-if="addModel.type == '1'">
            <el-col :span="12" :offset="0">
              <el-form-item prop="path" label="路由地址">
                <el-input v-model="addModel.path"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="url" label="组件路径">
                <el-input v-model="addModel.url"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="权限字段">
                <el-input v-model="addModel.code"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="菜单序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 上级菜单 -->
    <sys-dialog
      :title="parentDialog.title"
      :width="parentDialog.width"
      :height="parentDialog.height"
      :visible="parentDialog.visible"
      @onClose="parentClose"
      @onConfirm="parentConfirm"
    >
      <div slot="content">
        <el-tree
          ref="parentTree"
          :data="treeData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="false"
          :highlight-current="true"
          default-expand-all
          :expand-on-click-node="false"
          @node-click="handleNodeClick"
        >
          <div slot-scope="{ node, data }">
            <!-- 如果没有下级，显示文档图标 -->
            <span v-if="data.children.length == 0">
              <i style="margin-left: 3px" class="el-icon-document"></i>
            </span>
            <!-- 有下级，判断是否展开 -->
            <span v-else @click.stop="openBtn(data)">
              <i
                v-if="data.open"
                style="margin-left: 3px"
                class="el-icon-plus"
              ></i>
              <i v-else style="margin-left: 3px" class="el-icon-minus"></i>
            </span>
            <span style="margin-left: 3px">{{ node.label }}</span>
          </div>
        </el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getMenuListApi,
  getParentMenuListApi,
  addMenuApi,
  editMenuApi,
  deleteMenuApi,
} from "@/api/menu";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      //上级菜单数据
      treeData: [],
      //上级弹框属性
      parentDialog: {
        width: 300,
        title: "选择上级菜单",
        height: 450,
        visible: false,
      },
      //表单验证规则
      rules: {
        type: [
          {
            trigger: "blur",
            required: true,
            message: "请选择菜单类型",
          },
        ],
        parentName: [
          {
            trigger: "blur",
            required: true,
            message: "请选择上级菜单",
          },
        ],
        title: [
          {
            trigger: "blur",
            required: true,
            message: "请填写菜单名称",
          },
        ],
        name: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由名称",
          },
        ],
        path: [
          {
            trigger: "blur",
            required: true,
            message: "请填写路由地址",
          },
        ],
        url: [
          {
            trigger: "blur",
            required: true,
            message: "请填写组件路径",
          },
        ],
      },
      //表单数据
      addModel: {
        editType: "", // 0:新增 1：编辑
        menuId: "",
        type: "",
        parentId: "",
        title: "",
        code: "",
        name: "",
        path: "",
        url: "",
        icon: "",
        parentName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 650,
        title: "",
        height: 280,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //树选择的数据
      selectNode: {
        id: "",
        title: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //编辑
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑菜单";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据放到表单绑定的数据里面,回显
      this.$objCoppy(row, this.addModel);
      this.addModel.editType = "1";
    },
    //删除按钮
    async deleteBtn(row) {
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteMenuApi({ menuId: row.menuId });
        if (res && res.code == 200) {
          this.$message({ type: "success", message: res.msg });
          this.getList();
        }
      }
    },
    //上级部门节点加号和减号点击事件
    openBtn(data) {
      data.open = !data.open;
      this.$refs.parentTree.store.nodesMap[data.menuId].expanded = !data.open;
    },
    //上级菜单树点击事件
    handleNodeClick(node) {
      console.log(node);
      this.selectNode.id = node.menuId;
      this.selectNode.title = node.title;
    },
    //上级菜单确定事件
    parentConfirm() {
      this.addModel.parentId = this.selectNode.id;
      this.addModel.parentName = this.selectNode.title;
      this.parentDialog.visible = false;
      console.log(this.addModel);
    },
    //上级菜单关闭事件
    parentClose() {
      this.parentDialog.visible = false;
    },
    //选择上级菜单事件
    async selectParent() {
      //查询上级菜单树数据
      let res = await getParentMenuListApi();
      if (res && res.code == 200) {
        this.treeData = res.data;
      }
      this.parentDialog.visible = true;
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增菜单";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.editType = "0";
    },
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addMenuApi(this.addModel);
          } else {
            res = await editMenuApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message({ type: "success", message: res.msg });
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    async getList() {
      let res = await getMenuListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data;
      }
    },
  },
};
</script>


<style lang="scss" scoped>
::v-deep .el-tree {
  // 将每一行的设置为相对定位 方便后面before after 使用绝对定位来固定位置
  .el-tree-node {
    position: relative;
    padding-left: 10px;
  }
  // 子集像右偏移 给数线留出距离
  .el-tree-node__children {
    padding-left: 20px;
  }
  //这是竖线
  .el-tree-node :last-child:before {
    height: 40px;
  }
  .el-tree > .el-tree-node:before {
    border-left: none;
  }
  .el-tree > .el-tree-node:after {
    border-top: none;
  }
  //这自定义的线 的公共部分
  .el-tree-node:before,
  .el-tree-node:after {
    content: "";
    left: -4px;
    position: absolute;
    right: auto;
    border-width: 1px;
  }
  .tree :first-child .el-tree-node:before {
    border-left: none;
  }
  // 竖线
  .el-tree-node:before {
    border-left: 1px dotted #d9d9d9;
    bottom: 0px;
    height: 100%;
    top: -25px;
    width: 1px;
  }
  //横线
  .el-tree-node:after {
    border-top: 1px dotted #d9d9d9;
    height: 20px;
    top: 14px;
    width: 24px;
  }
  .el-tree-node__expand-icon.is-leaf {
    width: 8px;
  }
  //去掉elementui自带的展开按钮  一个向下的按钮,打开时向右
  .el-tree-node__content > .el-tree-node__expand-icon {
    display: none;
  }
  //每一行的高度
  .el-tree-node__content {
    line-height: 30px;
    height: 30px;
    padding-left: 10px !important;
  }
}
//去掉最上级的before  after 即是去电最上层的连接线
::v-deep .el-tree > div {
  &::before {
    display: none;
  }
  &::after {
    display: none;
  }
}
</style>
```





#### 第29讲 读者表、图书分类、图书表设计

##### 1、读者表

```js
create table sys_reader
(
   reader_id            int not null auto_increment comment '读者id',
   learn_num            varchar(36) comment '学生证号码',
   username             varchar(36) comment '姓名',
   id_card              varchar(20) comment '身份证号码',
   sex                  varchar(2) comment '性别',
   phone                varchar(15) comment '电话',
   password             varchar(128) comment '密码',
   type                 varchar(2) comment '类型',
   check_status         varchar(2) comment '审核状态 0：未审核  1：已审核',
   user_status          varchar(2) comment '用户状态 0:停用  1：启用',
   class_name           varchar(64) comment '班级',
   primary key (reader_id)
);

```



##### 2、图书分类

```js
create table sys_category
(
   category_id          int not null auto_increment comment '分类id',
   category_name        varchar(64) comment '分类名称',
   order_num            int comment '序号',
   primary key (category_id)
);

```



##### 3、图书表设计

```js
create table sys_books
(
   book_id              int not null auto_increment comment '图书id',
   category_id          int comment '分类id',
   book_name            varchar(128) comment '图书名称',
   book_code            varchar(128) comment '图书条码',
   book_place_num       varchar(128) comment '书架号',
   book_auther          varchar(64) comment '作者',
   book_product         varchar(128) comment '出版社',
   book_price           decimal(18,2) comment '价格',
   book_store           int comment '库存',
   primary key (book_id)
);

```



#### 第30讲 读者管理模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_reader.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

@Data
@TableName("sys_reader")
public class SysReader {
    @TableId(type = IdType.AUTO)
    private Long readerId;
    private String learnNum;
    private String username;
    private String idCard;
    private String sex;
    private String phone;
    private String password;
    private String type;
    private String checkStatus;
    private String userStatus;
    private String className;
}

```

```js
package com.itmk.web.sys_reader.entity;

import lombok.Data;

@Data
public class ReaderParm {
    private Long currentPage;
    private Long pageSize;
    private String username;
    private String idCard;
    private String phone;
    private String learnNum;
}

```



##### 2、新建mapper层

```js
package com.itmk.web.sys_reader.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_reader.entity.SysReader;

public interface SysReaderMapper extends BaseMapper<SysReader> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_reader.mapper.SysReaderMapper">

</mapper>
```



##### 3、service层

```js
package com.itmk.web.sys_reader.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_reader.entity.ReaderParm;
import com.itmk.web.sys_reader.entity.SysReader;

public interface SysReaderService extends IService<SysReader> {
    IPage<SysReader> getList(ReaderParm parm);
}

```

**实现类**

```js
package com.itmk.web.sys_reader.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_reader.entity.ReaderParm;
import com.itmk.web.sys_reader.entity.SysReader;
import com.itmk.web.sys_reader.mapper.SysReaderMapper;
import com.itmk.web.sys_reader.service.SysReaderService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysReaderServiceImpl extends ServiceImpl<SysReaderMapper, SysReader> implements SysReaderService {
    @Override
    public IPage<SysReader> getList(ReaderParm parm) {
        //构造查询条件
        QueryWrapper<SysReader> query = new QueryWrapper<>();
        if (StringUtils.isNotEmpty(parm.getIdCard())) {
            query.lambda().like(SysReader::getIdCard, parm.getIdCard());
        }
        if (StringUtils.isNotEmpty(parm.getLearnNum())) {
            query.lambda().like(SysReader::getLearnNum, parm.getLearnNum());
        }
        if (StringUtils.isNotEmpty(parm.getPhone())) {
            query.lambda().like(SysReader::getPhone, parm.getPhone());
        }
        if (StringUtils.isNotEmpty(parm.getUsername())) {
            query.lambda().like(SysReader::getUsername, parm.getUsername());
        }
        //构造分页对象
        IPage<SysReader> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 4、控制器

```js
package com.itmk.web.sys_reader.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_reader.entity.ReaderParm;
import com.itmk.web.sys_reader.entity.SysReader;
import com.itmk.web.sys_reader.service.SysReaderService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/reader")
public class SysReaderController {
    @Autowired
    private SysReaderService sysReaderService;

    //新增
    @PostMapping
    public ResultVo addReader(@RequestBody SysReader reader){
        reader.setCheckStatus("1");
        reader.setUserStatus("1");
        boolean save = sysReaderService.save(reader);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败！");
    }

    //编辑
    @PutMapping
    public ResultVo editReader(@RequestBody SysReader reader){
        boolean save = sysReaderService.updateById(reader);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败！");
    }

    //删除
    @DeleteMapping("/{readerId}")
    public ResultVo deleteReader(@PathVariable("readerId") Long readerId){
        boolean remove = sysReaderService.removeById(readerId);
         if(remove){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败！");
    }

    //列表
    @GetMapping("/list")
    public ResultVo getList(ReaderParm parm){
        IPage<SysReader> list = sysReaderService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第31讲 读者列表页面制作

##### 1、src/api下新建 reader.js

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get('/api/reader/list',parm)
}
```

##### 2、readerList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入学号"
          v-model="listParm.learnNum"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.username"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入电话号码"
          v-model="listParm.phone"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入身份证号码"
          v-model="listParm.idCard"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="username" label="姓名"></el-table-column>
      <el-table-column prop="learnNum" label="学号"></el-table-column>
      <el-table-column prop="className" label="班级"></el-table-column>
      <el-table-column prop="idCard" label="身份证号"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="sex" label="审核状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.checkStatus == '0'">未审核</el-tag>
          <el-tag v-if="scope.row.checkStatus == '1'">已审核</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="sex" label="用户状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.userStatus == '0'">停用</el-tag>
          <el-tag v-if="scope.row.userStatus == '1'">启用</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
          ></el-button>
          <el-button
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
          ></el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/reader";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        username: "",
        idCard: "",
        phone: "",
        learnNum: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第32讲 新增读者页面制作

##### 1、readerList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入学号"
          v-model="listParm.learnNum"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.username"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入电话号码"
          v-model="listParm.phone"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入身份证号码"
          v-model="listParm.idCard"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="username" label="姓名"></el-table-column>
      <el-table-column prop="learnNum" label="学号"></el-table-column>
      <el-table-column prop="className" label="班级"></el-table-column>
      <el-table-column prop="idCard" label="身份证号"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="sex" label="审核状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.checkStatus == '0'">未审核</el-tag>
          <el-tag v-if="scope.row.checkStatus == '1'">已审核</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="sex" label="用户状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.userStatus == '0'">停用</el-tag>
          <el-tag v-if="scope.row.userStatus == '1'">启用</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
          ></el-button>
          <el-button
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
          ></el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 30px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="姓名">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="learnNum" label="学号">
                <el-input v-model="addModel.learnNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="className" label="班级">
                <el-input v-model="addModel.className"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="idCard" label="身份证">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi } from "@/api/reader";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //弹框属性
      dialog: {
        title: "",
        width: 640,
        height: 230,
        visible: false,
      },
      rules: {
        learnNum: [{ required: true, message: "请填写学号", trigger: "blur" }],
        username: [{ required: true, message: "请填写姓名", trigger: "blur" }],
        idCard: [
          { required: true, message: "请填写身份证号", trigger: "blur" },
        ],
        phone: [{ required: true, message: "请填写电话", trigger: "blur" }],
        password: [{ required: true, message: "请填写密码", trigger: "blur" }],
        className: [{ required: true, message: "请填写班级", trigger: "blur" }],
      },
      //表单属性
      addModel: {
        type: "",
        readerId: "",
        learnNum: "",
        username: "",
        idCard: "",
        sex: "",
        phone: "",
        password: "",
        type: "",
        className: "",
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        username: "",
        idCard: "",
        phone: "",
        learnNum: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate((valid) => {
        if (valid) {
          this.dialog.visible = false;
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {
      this.dialog.title = "新增读者";
      this.dialog.visible = true;
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第33讲 新增、编辑、删除对接

##### 1、src/api/reader.js添加如下方法

```js
//新增
export const addReaderApi = async(parm) =>{
    return await http.post("/api/reader",parm)
}
//编辑
export const editReaderApi = async(parm) =>{
    return await http.put("/api/reader",parm)
}
//删除
export const deleteReaderApi = async(parm) =>{
    return await http.delete("/api/reader",parm)
}
```



##### 2、readerList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入学号"
          v-model="listParm.username"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入姓名"
          v-model="listParm.learnNum"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入电话号码"
          v-model="listParm.phone"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入身份证号码"
          v-model="listParm.idCard"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="learnNum" label="姓名"></el-table-column>
      <el-table-column prop="username" label="学号"></el-table-column>
      <el-table-column prop="className" label="班级"></el-table-column>
      <el-table-column prop="idCard" label="身份证号"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="sex" label="性别">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.sex == '0'">男</el-tag>
          <el-tag v-if="scope.row.sex == '1'">女</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="sex" label="审核状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.checkStatus == '0'">未审核</el-tag>
          <el-tag v-if="scope.row.checkStatus == '1'">已审核</el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="sex" label="用户状态">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.userStatus == '0'">停用</el-tag>
          <el-tag v-if="scope.row.userStatus == '1'">启用</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            icon="el-icon-delete"
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 30px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="learnNum" label="姓名">
                <el-input v-model="addModel.learnNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="学号">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="className" label="班级">
                <el-input v-model="addModel.className"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="idCard" label="身份证">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getListApi,
  addReaderApi,
  editReaderApi,
  deleteReaderApi,
} from "@/api/reader";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //弹框属性
      dialog: {
        title: "",
        width: 640,
        height: 230,
        visible: false,
      },
      rules: {
        learnNum: [{ required: true, message: "请填写姓名", trigger: "blur" }],
        username: [{ required: true, message: "请填写学号", trigger: "blur" }],
        idCard: [
          { required: true, message: "请填写身份证号", trigger: "blur" },
        ],
        phone: [{ required: true, message: "请填写电话", trigger: "blur" }],
        password: [{ required: true, message: "请填写密码", trigger: "blur" }],
        className: [{ required: true, message: "请填写班级", trigger: "blur" }],
      },
      //表单属性
      addModel: {
        type: "",
        readerId: "",
        learnNum: "",
        username: "",
        idCard: "",
        sex: "",
        phone: "",
        password: "",
        type: "",
        className: "",
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        username: "",
        idCard: "",
        phone: "",
        learnNum: "",
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //弹框确定
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addReaderApi(this.addModel);
          } else {
            res = await editReaderApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //删除按钮
    async deleteBtn(row) {
      let confirm =  await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteReaderApi({ readerId: row.readerId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      this.dialog.title = "编辑读者";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑属性
      this.addModel.type = "1";
    },
    //新增按钮
    addBtn() {
      this.dialog.title = "新增读者";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置编辑属性
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.listParm.username = ''
      this.listParm.idCard = ''
      this.listParm.learnNum = ''
      this.listParm.phone = ''
      this.getList()
    },
    //搜索按钮
    searchBtn() {
      this.getList()
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第34讲 图书分类接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_category.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

@Data
@TableName("sys_category")
public class SysCategory {
    @TableId(type = IdType.AUTO)
    private Long categoryId;
    private String categoryName;
    private Long orderNum;
}

```

```js
package com.itmk.web.sys_category.entity;

import lombok.Data;

@Data
public class ListCateParm {
    private Long currentPage;
    private Long pageSize;
    private String categoryName;
}

```

##### 2、新建mapper

```js
package com.itmk.web.sys_category.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_category.entity.SysCategory;

public interface SysCategoryMapper extends BaseMapper<SysCategory> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_category.mapper.SysCategoryMapper">

</mapper>
```

##### 3、service层

```js
package com.itmk.web.sys_category.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_category.entity.ListCateParm;
import com.itmk.web.sys_category.entity.SysCategory;

public interface SysCategoryService extends IService<SysCategory> {
    IPage<SysCategory> getList(ListCateParm parm);
}

```

**实现类**

```js
package com.itmk.web.sys_category.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_category.entity.ListCateParm;
import com.itmk.web.sys_category.entity.SysCategory;
import com.itmk.web.sys_category.mapper.SysCategoryMapper;
import com.itmk.web.sys_category.service.SysCategoryService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysCategoryServiceImpl extends ServiceImpl<SysCategoryMapper, SysCategory> implements SysCategoryService {
    @Override
    public IPage<SysCategory> getList(ListCateParm parm) {
        //构造分页对象
        IPage<SysCategory> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        //查询条件
        QueryWrapper<SysCategory> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getCategoryName())) {
            query.lambda().like(SysCategory::getCategoryName,parm.getCategoryName());
        }
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 4、控制器

```js
package com.itmk.web.sys_category.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_category.entity.ListCateParm;
import com.itmk.web.sys_category.entity.SysCategory;
import com.itmk.web.sys_category.service.SysCategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/category")
public class SysCategoryController {
    @Autowired
    private SysCategoryService sysCategoryService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SysCategory category){
        boolean save = sysCategoryService.save(category);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //新增
    @PutMapping
    public ResultVo edit(@RequestBody SysCategory category){
        boolean save = sysCategoryService.updateById(category);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{categoryId}")
    public ResultVo delete(@PathVariable("categoryId") Long categoryId){
        boolean remove = sysCategoryService.removeById(categoryId);
        if(remove){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表
    @GetMapping("/list")
    public ResultVo getList(ListCateParm parm){
        IPage<SysCategory> list = sysCategoryService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第35讲 图书分类列表制作

##### 1、src/api下新建category.js

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get("/api/category/list",parm)
}
```

##### 2、bookCategory.vue页面

```js
<template>
  <el-main>
    <!--搜索栏 -->
    <el-form :model="listParm" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="listParm.categoryName"
          placeholder="请输入类型名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="categoryName" label="分类名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/category";
export default {
  data() {
    return {
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        currentPage: 1,
        pageSize: 10,
        categoryName: "",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发事件
    currentChange(val) {},
    //页容量改动时触发事件
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增
    addBtn() {},
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第36讲 图书分类新增页面制作

##### 1、src/api/category.js添加如下方法

```js
//新增
export const addApi = async(parm) =>{
    return await http.post("/api/category",parm)
}
//编辑
export const editApi = async(parm) =>{
    return await http.put("/api/category",parm)
}
```



##### 2、bookCategory.vue页面

```js
<template>
  <el-main>
    <!--搜索栏 -->
    <el-form :model="listParm" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="listParm.categoryName"
          placeholder="请输入类型名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="categoryName" label="分类名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑页面 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 15px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="categoryName" label="分类名称">
                <el-input v-model="addModel.categoryName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, addApi, editApi } from "@/api/category";
export default {
  //注册
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        categoryName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写分类名称",
          },
        ],
      },
      //表单绑定的属性
      addModel: {
        type: "",
        categoryId: "",
        categoryName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 630,
        height: 150,
        title: "",
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        currentPage: 1,
        pageSize: 10,
        categoryName: "",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发事件
    currentChange(val) {},
    //页容量改动时触发事件
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑分类";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      this.addModel.type = "1";
    },
    //新增
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增分类";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第37讲图书分类删除、搜索对接

##### 1、src/api/category.js添加如下方法

```js
//删除
export const deleteApi = async(parm) =>{
    return await http.delete("/api/category",parm)
}
```



##### 2、bookCategory.vue页面

```js
<template>
  <el-main>
    <!--搜索栏 -->
    <el-form :model="listParm" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input
          v-model="listParm.categoryName"
          placeholder="请输入类型名称"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" style="color: #ff7670" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="categoryName" label="分类名称"></el-table-column>
      <el-table-column prop="orderNum" label="序号"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑页面 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 15px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="categoryName" label="分类名称">
                <el-input v-model="addModel.categoryName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="序号">
                <el-input v-model="addModel.orderNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, addApi, editApi, deleteApi } from "@/api/category";
export default {
  //注册
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        categoryName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写分类名称",
          },
        ],
      },
      //表单绑定的属性
      addModel: {
        type: "",
        categoryId: "",
        categoryName: "",
        orderNum: "",
      },
      //弹框属性
      dialog: {
        width: 630,
        height: 150,
        title: "",
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表参数
      listParm: {
        currentPage: 1,
        pageSize: 10,
        categoryName: "",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发事件
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改动时触发事件
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      //信息确认
      const confrim = await this.$myconfirm("确定删除该数据吗?");
      if (confrim) {
        let res = await deleteApi({ categoryId: row.categoryId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑分类";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据复制到表单数据域
      this.$objCoppy(row, this.addModel);
      this.addModel.type = "1";
    },
    //新增
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增分类";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      //清空表单
      this.listParm.categoryName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第38讲 图书管理模块接口开发

##### 1、新建实体类

```js
package com.itmk.web.sys_books.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.math.BigDecimal;

@Data
@TableName("sys_books")
public class SysBooks {
    @TableId(type = IdType.AUTO)
    private Long bookId;
    private Long categoryId;
    @TableField(exist = false)
    private String categoryName;
    private String bookName;
    private String bookCode;
    private String bookPlaceNum;
    private String bookAuther;
    private String bookProduct;
    private BigDecimal bookPrice;
    private Integer bookStore;
}

```

```js
package com.itmk.web.sys_books.entity;

import lombok.Data;

@Data
public class ListParm {
    private Long currentPage;
    private Long pageSize;
    private String categoryId;
    private String bookName;
    private String bookPlaceNum;
    private String bookAuther;
}

```

##### 2、新建mapper层

```js
package com.itmk.web.sys_books.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;
import org.apache.ibatis.annotations.Param;

public interface SysBooksMapper extends BaseMapper<SysBooks> {
    IPage<SysBooks> getList(Page<SysBooks> page, @Param("parm") ListParm parm);
}

```

##### 3、新建映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_books.mapper.SysBooksMapper">
    <select id="getList" resultType="com.itmk.web.sys_books.entity.SysBooks">
        select b.*,c.category_name from sys_books as b , sys_category as c where  b.category_id = c.category_id
        <if test="parm.categoryId != null and parm.categoryId !=''">
            and c.category_id =#{parm.categoryId}
        </if>
        <if test="parm.bookName != null and parm.bookName !=''">
            and b.book_name like CONCAT('%',#{parm.bookName},'%')
        </if>
        <if test="parm.bookPlaceNum != null and parm.bookPlaceNum !=''">
            and b.book_place_num like CONCAT('%',#{parm.bookPlaceNum},'%')
        </if>
        <if test="parm.bookAuther != null and parm.bookAuther !=''">
            and b.book_auther like CONCAT('%',#{parm.bookAuther},'%')
        </if>
    </select>
</mapper>
```

##### 4、新建service层

```js
package com.itmk.web.sys_books.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;

public interface SysBooksService extends IService<SysBooks> {
    IPage<SysBooks> getList(ListParm listParm);
}

```

**实现类**

```js
package com.itmk.web.sys_books.service.impl;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.mapper.SysBooksMapper;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.stereotype.Service;

@Service
public class SysBooksServiceImpl extends ServiceImpl<SysBooksMapper, SysBooks> implements SysBooksService {
    @Override
    public IPage<SysBooks> getList(ListParm listParm) {
        //构造分页对象
        Page<SysBooks> page = new  Page();
        page.setCurrent(listParm.getCurrentPage());
        page.setSize(listParm.getPageSize());
        return this.baseMapper.getList(page,listParm);
    }
}

```

##### 5、控制器

```js
package com.itmk.web.sys_books.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/books")
public class SysBooksController {
    @Autowired
    private SysBooksService sysBooksService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SysBooks books){
        boolean save = sysBooksService.save(books);
        if(save){
            return ResultUtils.success("新增成功!");
        }
        return ResultUtils.error("新增失败!");
    }

    //新增
    @PutMapping
    public ResultVo edit(@RequestBody SysBooks books){
        boolean save = sysBooksService.updateById(books);
        if(save){
            return ResultUtils.success("编辑成功!");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{bookId}")
    public ResultVo delete(@PathVariable("bookId") Long bookId){
        boolean remove = sysBooksService.removeById(bookId);
        if(remove){
            return ResultUtils.success("删除成功!");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表
    @GetMapping("/list")
    public ResultVo getList(ListParm parm){
        IPage<SysBooks> list = sysBooksService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```

#### 第39讲 图书列表页面布局

##### 1、src/api新建book.js文件

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get("/api/books/list",parm)
}
//查询图书列表
export const getCateListApi = async() =>{
    return await http.get("/api/category/cateList",null)
}
```

##### 2、bookList.vue页面

```js
<template>
  <el-main>
    <!--搜索栏 -->
    <el-form :model="listParm" :inline="true" size="small">
      <el-form-item>
        <el-select v-model="listParm.categoryId" placeholder="请选择">
          <el-option
            v-for="item in options"
            :key="item.categoryId"
            :label="item.categoryName"
            :value="item.categoryId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入图书名称"
          v-model="listParm.bookName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入书架号"
          v-model="listParm.bookPlaceNum"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入作者"
          v-model="listParm.bookAuther"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="closeBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column label="图书名称" prop="bookName"></el-table-column>
      <el-table-column label="图书分类" prop="categoryName"></el-table-column>
      <el-table-column label="书架号" prop="bookPlaceNum"></el-table-column>
      <el-table-column label="作者" prop="bookAuther"></el-table-column>
      <el-table-column label="出版社" prop="bookProduct"></el-table-column>
      <el-table-column label="价格" prop="bookPrice"></el-table-column>
      <el-table-column label="库存" prop="bookStore"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="default" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="default"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi, getCateListApi } from "@/api/book";
export default {
  data() {
    return {
      //下拉数据
      options:[],
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表查询参数
      listParm: {
        currentPage: 1,
        pageSize: 10,
        categoryId: "",
        bookName: "",
        bookPlaceNum: "",
        bookAuther: "",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getCateList();
  },
  methods: {
    //查询分类列表
    async getCateList() {
      let res = await getCateListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.options = res.data;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {},
    //重置按钮
    closeBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第40讲 新增图书制作

##### 1、在src/api/books.js添加如下方法

```js
//新增图书
export const addBookApi = async(parms) =>{
    return await http.post("/api/books",parms)
}
```



##### 2、bookList.vue页面

```js
<template>
  <el-main>
    <!--搜索栏 -->
    <el-form :model="listParm" :inline="true" size="small">
      <el-form-item>
        <el-select v-model="listParm.categoryId" placeholder="请选择">
          <el-option
            v-for="item in options"
            :key="item.categoryId"
            :label="item.categoryName"
            :value="item.categoryId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入图书名称"
          v-model="listParm.bookName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入书架号"
          v-model="listParm.bookPlaceNum"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入作者"
          v-model="listParm.bookAuther"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="closeBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column label="图书名称" prop="bookName"></el-table-column>
      <el-table-column label="图书分类" prop="categoryName"></el-table-column>
      <el-table-column label="书架号" prop="bookPlaceNum"></el-table-column>
      <el-table-column label="作者" prop="bookAuther"></el-table-column>
      <el-table-column label="出版社" prop="bookProduct"></el-table-column>
      <el-table-column label="价格" prop="bookPrice"></el-table-column>
      <el-table-column label="库存" prop="bookStore"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button type="primary" size="small" @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 10px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="categoryId" label="图书分类">
                <el-select v-model="addModel.categoryId" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.categoryId"
                    :label="item.categoryName"
                    :value="item.categoryId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookName" label="图书名称">
                <el-input v-model="addModel.bookName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookCode" label="图书编码">
                <el-input v-model="addModel.bookCode"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookPlaceNum" label="书架号">
                <el-input v-model="addModel.bookPlaceNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookAuther" label="图书作者">
                <el-input v-model="addModel.bookAuther"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookProduct" label="出版社">
                <el-input v-model="addModel.bookProduct"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookPrice" label="图书价格">
                <el-input v-model="addModel.bookPrice"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookStore" label="图书库存">
                <el-input v-model="addModel.bookStore"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi, getCateListApi, addBookApi } from "@/api/book";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        categoryId: [
          {
            required: true,
            trigger: "blur",
            message: "请选择图书分类",
          },
        ],
        bookCode: [
          {
            required: true,
            trigger: "blur",
            message: "请填写图书编码",
          },
        ],
        bookPlaceNum: [
          {
            required: true,
            trigger: "blur",
            message: "请填写书架号",
          },
        ],
        bookProduct: [
          {
            required: true,
            trigger: "blur",
            message: "请填写图书出版社",
          },
        ],
        bookAuther: [
          {
            required: true,
            trigger: "blur",
            message: "请填写作者",
          },
        ],
        bookPrice: [
          {
            required: true,
            trigger: "blur",
            message: "请填写价格",
          },
        ],
        bookStore: [
          {
            required: true,
            trigger: "blur",
            message: "请填写库存",
          },
        ],
        bookName: [
          {
            required: true,
            trigger: "blur",
            message: "请填写图书名称",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        bookId: "",
        categoryId: "",
        bookName: "",
        categoryName: "",
        bookCode: "",
        bookPlaceNum: "",
        bookProduct: "",
        bookAuther: "",
        bookPrice: "",
        bookStore: "",
        type: "",
      },
      //弹框属性
      dialog: {
        height: 250,
        width: 650,
        visible: false,
        title: "",
      },
      //下拉数据
      options: [],
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表查询参数
      listParm: {
        currentPage: 1,
        pageSize: 10,
        categoryId: "",
        bookName: "",
        bookPlaceNum: "",
        bookAuther: "",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getCateList();
    this.getList();
  },
  methods: {
    //列表查询
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //弹框确定事件
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addBookApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //查询分类列表
    async getCateList() {
      let res = await getCateListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.options = res.data;
      }
    },
    //页数改变时触发
    currentChange(val) {},
    //页容量改变时触发
    sizeChange(val) {},
    //删除按钮
    deleteBtn(row) {},
    //编辑按钮
    editBtn(row) {},
    //新增按钮
    addBtn() {
      this.dialog.title = "新增图书";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "0";
    },
    //重置按钮
    closeBtn() {},
    //搜索按钮
    searchBtn() {},
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第41讲 编辑、删除图书功能开发

##### 1、在src/api/book.js添加如下方法

```js
//编辑
export const editBookApi = async(parm) =>{
    return await http.put("/api/books",parm)
}
//删除
export const deleteBookApi = async(parm) =>{
    return await http.delete("/api/books",parm)
}
```

##### 2、bookList.vue页面完整源码

```js
<template>
  <el-main>
    <!--搜索栏 -->
    <el-form :model="listParm" :inline="true" size="small">
      <el-form-item>
        <el-select v-model="listParm.categoryId" placeholder="请选择">
          <el-option
            v-for="item in options"
            :key="item.categoryId"
            :label="item.categoryName"
            :value="item.categoryId"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入图书名称"
          v-model="listParm.bookName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入书架号"
          v-model="listParm.bookPlaceNum"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input
          placeholder="请输入作者"
          v-model="listParm.bookAuther"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close" @click="resetBtn"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column label="图书名称" prop="bookName"></el-table-column>
      <el-table-column label="图书分类" prop="categoryName"></el-table-column>
      <el-table-column label="书架号" prop="bookPlaceNum"></el-table-column>
      <el-table-column label="作者" prop="bookAuther"></el-table-column>
      <el-table-column label="出版社" prop="bookProduct"></el-table-column>
      <el-table-column label="价格" prop="bookPrice"></el-table-column>
      <el-table-column label="库存" prop="bookStore"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
          style="margin-right: 10px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="categoryId" label="图书分类">
                <el-select v-model="addModel.categoryId" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.categoryId"
                    :label="item.categoryName"
                    :value="item.categoryId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookName" label="图书名称">
                <el-input v-model="addModel.bookName"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookCode" label="图书编码">
                <el-input v-model="addModel.bookCode"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookPlaceNum" label="书架号">
                <el-input v-model="addModel.bookPlaceNum"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookAuther" label="图书作者">
                <el-input v-model="addModel.bookAuther"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookProduct" label="出版社">
                <el-input v-model="addModel.bookProduct"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookPrice" label="图书价格">
                <el-input v-model="addModel.bookPrice"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="bookStore" label="图书库存">
                <el-input v-model="addModel.bookStore"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getListApi,
  getCateListApi,
  addBookApi,
  editBookApi,
  deleteBookApi,
} from "@/api/book";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        categoryId: [
          {
            required: true,
            trigger: "blur",
            message: "请选择图书分类",
          },
        ],
        bookCode: [
          {
            required: true,
            trigger: "blur",
            message: "请填写图书编码",
          },
        ],
        bookPlaceNum: [
          {
            required: true,
            trigger: "blur",
            message: "请填写书架号",
          },
        ],
        bookProduct: [
          {
            required: true,
            trigger: "blur",
            message: "请填写图书出版社",
          },
        ],
        bookAuther: [
          {
            required: true,
            trigger: "blur",
            message: "请填写作者",
          },
        ],
        bookPrice: [
          {
            required: true,
            trigger: "blur",
            message: "请填写价格",
          },
        ],
        bookStore: [
          {
            required: true,
            trigger: "blur",
            message: "请填写库存",
          },
        ],
        bookName: [
          {
            required: true,
            trigger: "blur",
            message: "请填写图书名称",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        bookId: "",
        categoryId: "",
        bookName: "",
        categoryName: "",
        bookCode: "",
        bookPlaceNum: "",
        bookProduct: "",
        bookAuther: "",
        bookPrice: "",
        bookStore: "",
        type: "",
      },
      //弹框属性
      dialog: {
        height: 250,
        width: 650,
        visible: false,
        title: "",
      },
      //下拉数据
      options: [],
      //表格高度
      tableHeight: 0,
      //表格数据
      tableData: [],
      //列表查询参数
      listParm: {
        currentPage: 1,
        pageSize: 10,
        categoryId: "",
        bookName: "",
        bookPlaceNum: "",
        bookAuther: "",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getCateList();
    this.getList();
  },
  methods: {
    //列表查询
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //弹框确定事件
    onConfirm() {
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addBookApi(this.addModel);
          } else {
            res = await editBookApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    //新增弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //查询分类列表
    async getCateList() {
      let res = await getCateListApi();
      if (res && res.code == 200) {
        console.log(res);
        this.options = res.data;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList()
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList()
    },
    //删除按钮
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteBookApi({ bookId: row.bookId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      this.dialog.title = "编辑图书";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把当前要编辑的数据复制到表单绑定的数据域里面
      this.$objCoppy(row, this.addModel);
      this.addModel.type = "1";
    },
    //新增按钮
    addBtn() {
      this.dialog.title = "新增图书";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.listParm.categoryId = '';
      this.listParm.bookName = '';
      this.listParm.bookPlaceNum = '';
      this.listParm.bookAuther = '';
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第42讲 借书管理页面制作

##### 1、在router/index.js路由中添加如下路由页面,并新建对应的页面

```js
{
    path: '/borrow',
    component: Layout,
    alwaysShow: true,
    name: 'borrow',
    meta: { title: '借阅管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/bookBorrow',
        name: 'bookBorrow',
        component: () => import('@/views/borrow/bookBorrow'),
        meta: { title: '借书管理', icon: 'table' }
      },
      {
        path: '/bookReturn',
        name: 'bookReturn',
        component: () => import('@/views/borrow/bookReturn'),
        meta: { title: '还书管理', icon: 'table' }
      }
    ]
  }
```

##### 2、安装elt-transfer

基于element-ui的可分页表格穿梭框

https://github.com/TanxiangCode/elt-transfer

```js
npm install elt-transfer
```

##### 3、main.js中引入elt-transfer

```js
//表格穿梭框
import eltTransfer from 'elt-transfer'
Vue.use(eltTransfer)
```

##### 4、使用elt-transfer

```js
import eltTransfer from 'elt-transfer/src/eltTransfer'

//注册组件
components: {
    "elt-transfer": eltTransfer,
}
```

##### 5、bookBorrow.vue页面

```js
<template>
  <el-main>
    <div style="margin:0px 0px 15px 0px;color:#67c23a;font-weight:600;font-size:15px;">读者信息</div>
    <el-card class="box-card">
      <div slot="header" style="padding: 0px" class="clearfix">
        <el-form
          :model="searchParm"
          label-width="80px"
          :inline="true"
          size="mini"
        >
          <el-form-item label="学号">
            <el-input v-model="searchParm.username"></el-input>
          </el-form-item>
          <el-form-item>
            <el-button icon="el-icon-search">查询</el-button>
            <el-button
              style="color: #ff7670"
              icon="el-icon-close"
              >重置</el-button
            >
          </el-form-item>
        </el-form>
      </div>
      <div>
        <el-form
          :model="showUser"
          ref="form"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item label="姓名">
            <el-input v-model="showUser.learnNum"></el-input>
          </el-form-item>
          <el-form-item label="班级">
            <el-input v-model="showUser.className"></el-input>
          </el-form-item>
          <el-form-item label="学号">
            <el-input v-model="showUser.username"></el-input>
          </el-form-item>
          <el-form-item label="电话">
            <el-input v-model="showUser.phone"></el-input>
          </el-form-item>
          <el-form-item label="证件号">
            <el-input v-model="showUser.idCard"></el-input>
          </el-form-item>
          <el-form-item label="性别">
            <el-radio v-model="showUser.sex" label="0">男</el-radio>
            <el-radio v-model="showUser.sex" label="1">女</el-radio>
          </el-form-item>
          <el-form-item label="状态">
            <el-radio v-model="showUser.checkStatus" label="0">未审核</el-radio>
            <el-radio v-model="showUser.checkStatus" label="1">已审核</el-radio>
          </el-form-item>
        </el-form>
      </div>
    </el-card>
    <div style="margin:15px 0px;color:#67c23a;font-weight:600;font-size:15px;">图书列表</div>
    <div>
      <elt-transfer
        ref="eltTransfer"
        :show-query="true"
        :show-pagination="true"
        :pagination-call-back="paginationCallBack"
        :left-columns="leftColumns"
        :title-texts="['待选', '已选']"
        :button-texts="['添加', '删除']"
        :query-texts="['筛选', '筛选']"
        :table-row-key="(row) => row.name"
        v-model="tableData"
      >
        <!-- 可以使用插槽获取到列信息和行信息，从而进行数据的处理 -->
        <template v-slot:default="{ scope }">
          <div>
            <span v-if="scope.col.id === 'gender'">{{
              scope.row.gender === "男" ? "男生" : "女生"
            }}</span>
            <span v-else>{{ scope.row[scope.col.id] }}</span>
          </div>
        </template>
        <template v-slot:leftCondition="{ scope }">
          <el-form-item label="姓名">
            <el-input v-model="scope.name" placeholder="姓名"></el-input>
          </el-form-item>
          <el-form-item label="年龄">
            <el-input v-model="scope.age" placeholder="年龄"></el-input>
          </el-form-item>
        </template>
        <template v-slot:rightCondition="{ scope }">
          <el-form-item label="名称">
            <el-input v-model="scope.name" placeholder="名称"></el-input>
          </el-form-item>
        </template>
      </elt-transfer>
    </div>
  </el-main>
</template>

<script>
import eltTransfer from 'elt-transfer/src/eltTransfer'
export default {
  components: {
    "elt-transfer": eltTransfer,
  },
  data() {
    return {
      tableData: [
        { name: "方琼岚", gender: "女", age: 15 },
        { name: "焉彦珺", gender: "女", age: 15 },
      ],
      leftColumns: [
        { label: "姓名", id: "name", width: "120px" },
        { label: "性别", id: "gender", width: "120px" },
        { label: "年龄", id: "age" },
      ],
      data1: [
        { name: "佘寄南", gender: "男", age: 12 },
        { name: "聊夏云", gender: "男", age: 13 },
        { name: "出凌柏", gender: "男", age: 14 },
        { name: "丛琴心", gender: "女", age: 15 },
        { name: "方琼岚", gender: "女", age: 15 },
        { name: "焉彦珺", gender: "女", age: 15 },
        { name: "第凝旋", gender: "女", age: 15 },
        { name: "续文君", gender: "女", age: 15 },
        { name: "独松雪", gender: "女", age: 15 },
        { name: "有念桃", gender: "女", age: 15 },
        { name: "闻人晶瑶", gender: "男", age: 12 },
        { name: "祖震博", gender: "男", age: 13 },
        { name: "史妞妞", gender: "男", age: 14 },
        { name: "天如风", gender: "女", age: 15 },
        { name: "隗飞昂", gender: "女", age: 15 },
        { name: "堵舒", gender: "女", age: 15 },
        { name: "菅芬", gender: "女", age: 15 },
        { name: "疏千风", gender: "女", age: 15 },
        { name: "项虹颖", gender: "女", age: 15 },
        { name: "劳念云", gender: "女", age: 15 },
        { name: "闻凝绿", gender: "男", age: 12 },
        { name: "牧冬莲", gender: "男", age: 13 },
        { name: "楚驰颖", gender: "男", age: 14 },
        { name: "奕丹山", gender: "女", age: 15 },
        { name: "姬孤晴", gender: "女", age: 15 },
        { name: "邛俊晤", gender: "女", age: 15 },
        { name: "悟瑜蓓", gender: "女", age: 15 },
        { name: "桓嘉颖", gender: "女", age: 15 },
        { name: "卿安琪", gender: "女", age: 15 },
        { name: "程宾", gender: "女", age: 15 },
        { name: "答斐", gender: "男", age: 12 },
        { name: "竺琬凝", gender: "男", age: 13 },
        { name: "谷鸿才", gender: "男", age: 14 },
        { name: "牵忆南", gender: "女", age: 15 },
        { name: "飞晓彤", gender: "女", age: 15 },
        { name: "范鸿波", gender: "女", age: 15 },
        { name: "庚经亘", gender: "女", age: 15 },
        { name: "干芮欣", gender: "女", age: 15 },
        { name: "才靖荷", gender: "女", age: 15 },
        { name: "原婧", gender: "女", age: 15 },
        { name: "士霞飞", gender: "男", age: 12 },
        { name: "首雨安", gender: "男", age: 13 },
        { name: "保皛", gender: "男", age: 14 },
        { name: "皇甫文轩", gender: "女", age: 15 },
        { name: "颛孙兴平", gender: "女", age: 15 },
        { name: "水鸾", gender: "女", age: 15 },
        { name: "仉棠", gender: "女", age: 15 },
        { name: "伦昊昊", gender: "女", age: 15 },
        { name: "速晟睿", gender: "女", age: 15 },
        { name: "万俟仪芳", gender: "女", age: 15 },
        { name: "卫孟", gender: "男", age: 12 },
        { name: "仆访波", gender: "男", age: 13 },
        { name: "奚冰海", gender: "男", age: 14 },
        { name: "褚冰香", gender: "女", age: 15 },
        { name: "布凌丝", gender: "女", age: 15 },
        { name: "苦星", gender: "女", age: 15 },
        { name: "钦忆安", gender: "女", age: 15 },
        { name: "姒晓曼", gender: "女", age: 15 },
        { name: "蒉英武", gender: "女", age: 15 },
        { name: "锺晴美", gender: "女", age: 15 },
        { name: "泥元槐", gender: "男", age: 12 },
        { name: "买初珍", gender: "男", age: 13 },
        { name: "秦乾", gender: "男", age: 14 },
        { name: "谭白山", gender: "女", age: 15 },
        { name: "登幻翠", gender: "女", age: 15 },
        { name: "蚁盼夏", gender: "女", age: 15 },
        { name: "居梓莹", gender: "女", age: 15 },
        { name: "中觅风", gender: "女", age: 15 },
        { name: "慈珺琦", gender: "女", age: 15 },
        { name: "谏听云", gender: "女", age: 15 },
        { name: "应鹏煊", gender: "男", age: 12 },
        { name: "驹霁", gender: "男", age: 13 },
        { name: "慕容智纯", gender: "男", age: 14 },
        { name: "可茹薇", gender: "女", age: 15 },
        { name: "夫冰薇", gender: "女", age: 15 },
        { name: "李朋", gender: "女", age: 15 },
        { name: "轩辕萍韵", gender: "女", age: 15 },
        { name: "简沛蓝", gender: "女", age: 15 },
        { name: "粟阳舒", gender: "女", age: 15 },
        { name: "郦高韵", gender: "女", age: 15 },
      ],
      //读者信息搜索框
      searchParm: {
        username: "",
      },
      showUser: {
        learnNum: "张三",
        username: "2021145646",
        idCard: "53233158964645",
        sex: "1",
        phone: "18687116223",
        className: "软件1班",
        checkStatus: "1",
      },
    };
  },
  methods: {
    paginationCallBack(obj) {
      // console.log(obj)
      let d = this.data1.filter((item, index) => {
        if (
          index >= (obj.pageIndex - 1) * obj.pageSize &&
          index < obj.pageIndex * obj.pageSize
        ) {
          return true;
        }
        return false;
      });
      return new Promise((resolve, reject) => {
        try {
          resolve({ total: this.data1.length, data: d });
        } catch {
          reject();
        }
      });
    },
    clearTransfer() {
      this.$refs.eltTransfer.clear();
    },
  },
};
</script>

<style scoped>
::v-deep .el-card__header {
  padding: 15px 0px 0px 0px;
}
::v-deep .el-card__body {
  padding: 15px 0px 0px 0px;
}
</style>
```



#### 第43讲 借书页面数据对接

##### 1、SysReaderController控制器添加如下方法

```js
    //根据学号查询
    @GetMapping("/getByUserName")
    public ResultVo getReader(SysReader reader){
        QueryWrapper<SysReader> query = new QueryWrapper<>();
        query.lambda().eq(SysReader::getUsername,reader.getUsername());
        SysReader one = sysReaderService.getOne(query);
        return ResultUtils.success("查询成功",one);
    }
```

##### 2、/api/reader添加如下方法

```js
//根据学号查询
export const getByUserNameApi = async(parm) =>{
    return await http.get("/api/reader/getByUserName",parm)
}
```

##### 3、bookBrrow.vue页面

```js
<template>
  <el-main>
    <div
      style="
        margin: 0px 0px 15px 0px;
        color: #67c23a;
        font-weight: 600;
        font-size: 15px;
      "
    >
      读者信息
    </div>
    <el-card class="box-card">
      <div slot="header" style="padding: 0px" class="clearfix">
        <el-form
          :model="searchParm"
          label-width="80px"
          :inline="true"
          size="mini"
        >
          <el-form-item label="学号">
            <el-input v-model="searchParm.username"></el-input>
          </el-form-item>
          <el-form-item>
            <el-button icon="el-icon-search" @click="getByUserName"
              >查询</el-button
            >
            <el-button
              style="color: #ff7670"
              icon="el-icon-close"
              @click="resetBtn"
              >重置</el-button
            >
            <el-button type="primary" size="small" icon="el-icon-edit-outline" @click="borrowBtn">借书</el-button>
            
          </el-form-item>
        </el-form>
      </div>
      <div>
        <el-form
          :model="showUser"
          ref="form"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item label="姓名">
            <el-input v-model="showUser.learnNum"></el-input>
          </el-form-item>
          <el-form-item label="班级">
            <el-input v-model="showUser.className"></el-input>
          </el-form-item>
          <el-form-item label="学号">
            <el-input v-model="showUser.username"></el-input>
          </el-form-item>
          <el-form-item label="电话">
            <el-input v-model="showUser.phone"></el-input>
          </el-form-item>
          <el-form-item label="证件号">
            <el-input v-model="showUser.idCard"></el-input>
          </el-form-item>
          <el-form-item label="性别">
            <el-radio v-model="showUser.sex" label="0">男</el-radio>
            <el-radio v-model="showUser.sex" label="1">女</el-radio>
          </el-form-item>
          <el-form-item label="状态">
            <el-radio v-model="showUser.checkStatus" label="0">未审核</el-radio>
            <el-radio v-model="showUser.checkStatus" label="1">已审核</el-radio>
          </el-form-item>
        </el-form>
      </div>
    </el-card>
    <div
      style="
        margin: 15px 0px;
        color: #67c23a;
        font-weight: 600;
        font-size: 15px;
      "
    >
      图书列表
    </div>
    <div>
      <elt-transfer
        ref="eltTransfer"
        :show-query="true"
        :show-pagination="true"
        :pagination-call-back="paginationCallBack"
        :left-columns="leftColumns"
        :title-texts="['待选', '已选']"
        :button-texts="['添加', '删除']"
        :query-texts="['查询', '查询']"
        :table-row-key="(row) => row.bookId"
        v-model="tableData"
      >
        <!-- 可以使用插槽获取到列信息和行信息，从而进行数据的处理 -->
        <template v-slot:leftCondition>
          <el-form-item label="图书名称">
            <el-input
              v-model="listParm.bookName"
              placeholder="图书名称"
            ></el-input>
          </el-form-item>
          <el-form-item label="图书作者">
            <el-input
              v-model="listParm.bookAuther"
              placeholder="图书作者"
            ></el-input>
          </el-form-item>
        </template>
        <template v-slot:rightCondition="{ scope }">
          <el-form-item label="名称">
            <el-input v-model="scope.bookName" placeholder="名称"></el-input>
          </el-form-item>
        </template>
      </elt-transfer>
    </div>
  </el-main>
</template>

<script>
import { getByUserNameApi } from "@/api/reader";
import { getListApi } from "@/api/book";
import eltTransfer from "elt-transfer/src/eltTransfer";
export default {
  components: {
    "elt-transfer": eltTransfer,
  },
  data() {
    return {
      tableData: [],
      leftColumns: [
        { label: "图书名称", id: "bookName", width: "120px" },
        { label: "图书分类", id: "categoryName", width: "120px" },
        { label: "书架号", id: "bookPlaceNum" },
        { label: "作者", id: "bookAuther" },
        { label: "出版社", id: "bookProduct" },
        { label: "库存", id: "bookStore" },
      ],
      //读者信息搜索框
      searchParm: {
        username: "",
      },
      showUser: {
        learnNum: "",
        username: "",
        idCard: "",
        sex: "",
        phone: "",
        className: "",
        checkStatus: "",
      },
      listParm: {
        currentPage: "",
        pageSize: "",
        bookName: "",
        bookAuther: "",
      },
    };
  },
  methods: {
    //借书按钮
    borrowBtn(){
      console.log(this.tableData)
    },
    async paginationCallBack(obj) {
      console.log(obj);
      this.listParm.currentPage = obj.pageIndex;
      this.listParm.pageSize = obj.pageSize;
      let res = await getListApi(this.listParm);
      return new Promise((resolve, reject) => {
        try {
          resolve({ total: res.data.total, data: res.data.records });
        } catch {
          reject();
        }
      });
    },
    clearTransfer() {
      this.$refs.eltTransfer.clear();
    },
    //根据学号查询读者
    async getByUserName() {
      let res = await getByUserNameApi(this.searchParm);
      console.log(res);
      if (res && res.code == 200 && res.data) {
        this.showUser = res.data;
      }
    },
    resetBtn() {
      this.searchParm.username = "";
      this.showUser.learnNum = "";
      this.showUser.username = "";
      this.showUser.idCard = "";
      this.showUser.sex = "";
      this.showUser.phone = "";
      this.showUser.className = "";
      this.showUser.checkStatus = "";
    },
  },
};
</script>

<style scoped>
::v-deep .el-card__header {
  padding: 15px 0px 0px 0px;
}
::v-deep .el-card__body {
  padding: 15px 0px 0px 0px;
}
</style>
```



#### 第44讲 借书表设计

##### 1、借书表sql

```js

create table borrow_book
(
   borrow_id            int not null auto_increment comment '主键',
   book_id              int comment '图书id',
   reader_id            int comment '读者id',
   borrow_time          datetime comment '借书时间',
   return_time          datetime comment '还书时间',
   apply_status         varchar(2) comment '0: 待审核 1： 已审核  2：拒绝',
   borrow_status        varchar(2) comment '1:在借中  2：已还   3：拒绝',
   return_status        varchar(2) comment '1: 正常还书 2：异常还书',
   excepion_text        varchar(128) comment '异常还书备注',
   apply_text           varchar(128) comment '审核拒绝备注',
   primary key (borrow_id)
);

```



#### 第45讲 借书接口开发

1、新建BusinessExceptionEnum

```js
package com.itmk.exception_advice;

public enum  BusinessExceptionEnum {
    SERVER_ERROR(500, "服务器异常！"),
    NO_STOCK(1001,"---->存不足!"),
    ;

    private Integer code;
    private String message;

    BusinessExceptionEnum(Integer code, String message) {
        this.code = code;
        this.message = message;
    }

    public Integer getCode() {
        return code;
    }

    public String getMessage() {
        return message;
    }
}

```

```js
package com.itmk.exception;


public class BusinessException extends RuntimeException {
    private Integer code;

    private String message;

    public BusinessException(Integer code, String message) {
        this.code = code;
        this.message = message;
    }

    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

    @Override
    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}
```





##### 2、新建全局异常处理类GlobalExceptionHandler

```js
package com.itmk.exception_advice;

import com.itmk.exception.BusinessException;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

@ControllerAdvice
public class GlobalExceptionHandler {
     /**
     * 自定义业务异常拦截
     * BusinessException
     */
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public ResultVo bussinessexception(BusinessException e) {
        return ResultUtils.error(e.getMessage(),e.getCode());
    }

    /**
     * 未知的运行时异常拦截
     */
    @ExceptionHandler(RuntimeException.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    @ResponseBody
    public ResultVo notFount(RuntimeException e) {
        return ResultUtils.error(e.getMessage(),BusinessExceptionEnum.SERVER_ERROR.getMessage());
    }
}

```

##### 3、新建实体类

```js
package com.itmk.web.borrow_book.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.util.Date;

@Data
@TableName("borrow_book")
public class BorrowBook {
    @TableId(type = IdType.AUTO)
    private Long borrowId;
    //图书id
    private Long bookId;
    //借书人id
    private Long readerId;
    //借书时间
    private Date borrowTime;
    //还书时间
    private Date returnTime;
    //0: 待审核 1： 已审核  2：拒绝
    private String applyStatus;
    //1:在借中  2：已还   3：拒绝
    private String borrowStatus;
    //1: 正常还书 2：异常还书
    private String returnStatus;
    //异常还书备注
    private String excepionText;
    //审核拒绝备注
    private String applyText;
}

```

**参数接收类**

```js
package com.itmk.web.borrow_book.entity;

import lombok.Data;

import java.util.Date;
import java.util.List;

@Data
public class BorrowParm {
    //借书人id
    private Long readerId;
    //图书id
    private List<Long> bookIds;
    //还书时间
    private Date returnTime;
}

```

##### 4、新建mapper层

```js
package com.itmk.web.borrow_book.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.borrow_book.entity.BorrowBook;

public interface BorrowBookMapper extends BaseMapper<BorrowBook> {
}
```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.borrow_book.mapper.BorrowBookMapper">

</mapper>
```

##### 5、新建service层

```js
package com.itmk.web.borrow_book.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.BorrowParm;

public interface BorrowBookService extends IService<BorrowBook> {
    void borrow(BorrowParm borrowParm);
}

```

**实现类**

```js
package com.itmk.web.borrow_book.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.exception.BusinessException;
import com.itmk.exception_advice.BusinessExceptionEnum;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.BorrowParm;
import com.itmk.web.borrow_book.mapper.BorrowBookMapper;
import com.itmk.web.borrow_book.service.BorrowBookService;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.stream.Collectors;

@Service
public class BorrowBookServiceImpl extends ServiceImpl<BorrowBookMapper, BorrowBook> implements BorrowBookService {
    @Autowired
    private SysBooksService sysBooksService;

    private Lock lock = new ReentrantLock();

    @Override
    @Transactional
    public void borrow(BorrowParm borrowParm) {
        lock.lock();
        try {
            //查询图书库存
            QueryWrapper<SysBooks> query = new QueryWrapper<>();
            query.lambda().in(SysBooks::getBookId, borrowParm.getBookIds());
            List<SysBooks> list = sysBooksService.list(query);
            List<SysBooks> collect = list.stream().filter(item -> item.getBookStore().longValue() < 1L).collect(Collectors.toList());
            //如果存在库存不足
            if (collect.size() > 0) {
                List<String> stringList = collect.stream().map(SysBooks::getBookName).collect(Collectors.toList());
                throw new BusinessException(BusinessExceptionEnum.NO_STOCK.getCode(),
                        stringList + BusinessExceptionEnum.NO_STOCK.getMessage());
            }
            //库存充足，减库存，插入借书明细
            List<Long> bookIds = borrowParm.getBookIds();
            for(int i=0;i<bookIds.size();i++){
                Long bookId = bookIds.get(i);
                //减库存
                int res = sysBooksService.subBook(bookId);
                //查询借书表数据
                if(res > 0){
                    BorrowBook borrowBook = new BorrowBook();
                    borrowBook.setBookId(bookId);
                    borrowBook.setReaderId(borrowParm.getReaderId());
                    borrowBook.setReturnTime(borrowParm.getReturnTime());
                    borrowBook.setApplyStatus("1");
                    borrowBook.setBorrowStatus("1");
                    borrowBook.setBorrowTime(new Date());
                    this.baseMapper.insert(borrowBook);
                }
            }
        } finally {
            lock.unlock();
        }

    }
}

```

##### 6、新建控制器

```js
package com.itmk.web.borrow_book.controller;

import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.BorrowParm;
import com.itmk.web.borrow_book.service.BorrowBookService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/borrow")
public class BorrowBookController {
    @Autowired
    private BorrowBookService borrowBookService;

    //借书
    @PostMapping
    public ResultVo borrow(@RequestBody BorrowParm borrowParm){
        borrowBookService.borrow(borrowParm);
        return ResultUtils.success("借书成功!");
    }
}

```

##### 7、前端api下新建borrow.js

```js
import http from '@/utils/http'
//借书
export const borrowApi = async(parm) =>{
    return await http.post("/api/borrow",parm)
}
```

##### 8、bookBorrow.vue页面

```js
<template>
  <el-main>
    <div
      style="
        margin: 0px 0px 15px 0px;
        color: #67c23a;
        font-weight: 600;
        font-size: 15px;
      "
    >
      读者信息
    </div>
    <el-card class="box-card">
      <div slot="header" style="padding: 0px" class="clearfix">
        <el-form
          :model="searchParm"
          label-width="80px"
          :inline="true"
          size="mini"
        >
          <el-form-item label="学号">
            <el-input v-model="searchParm.username"></el-input>
          </el-form-item>
          <el-form-item>
            <el-button icon="el-icon-search" @click="getByUserName"
              >查询</el-button
            >
            <el-button
              style="color: #ff7670"
              icon="el-icon-close"
              @click="resetBtn"
              >重置</el-button
            >
          </el-form-item>
          <el-form-item label="还书时间">
            <el-date-picker
              v-model="returnTime"
              type="date"
              placeholder="选择还书日期"
            >
            </el-date-picker>
          </el-form-item>
          <el-form-item>
            <el-button
              type="primary"
              size="mini"
              icon="el-icon-edit-outline"
              @click="borrowBtn"
              >借书</el-button
            >
          </el-form-item>
        </el-form>
      </div>
      <div>
        <el-form
          :model="showUser"
          ref="form"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item label="姓名">
            <el-input v-model="showUser.learnNum"></el-input>
          </el-form-item>
          <el-form-item label="班级">
            <el-input v-model="showUser.className"></el-input>
          </el-form-item>
          <el-form-item label="学号">
            <el-input v-model="showUser.username"></el-input>
          </el-form-item>
          <el-form-item label="电话">
            <el-input v-model="showUser.phone"></el-input>
          </el-form-item>
          <el-form-item label="证件号">
            <el-input v-model="showUser.idCard"></el-input>
          </el-form-item>
          <el-form-item label="性别">
            <el-radio v-model="showUser.sex" label="0">男</el-radio>
            <el-radio v-model="showUser.sex" label="1">女</el-radio>
          </el-form-item>
          <el-form-item label="状态">
            <el-radio v-model="showUser.checkStatus" label="0">未审核</el-radio>
            <el-radio v-model="showUser.checkStatus" label="1">已审核</el-radio>
          </el-form-item>
        </el-form>
      </div>
    </el-card>
    <div
      style="
        margin: 15px 0px;
        color: #67c23a;
        font-weight: 600;
        font-size: 15px;
      "
    >
      图书列表
    </div>
    <div>
      <elt-transfer
        ref="eltTransfer"
        :show-query="true"
        :show-pagination="true"
        :pagination-call-back="paginationCallBack"
        :left-columns="leftColumns"
        :title-texts="['待选', '已选']"
        :button-texts="['添加', '删除']"
        :query-texts="['查询', '查询']"
        :table-row-key="(row) => row.bookId"
        v-model="tableData"
      >
        <!-- 可以使用插槽获取到列信息和行信息，从而进行数据的处理 -->
        <template v-slot:leftCondition>
          <el-form-item label="图书名称">
            <el-input
              v-model="listParm.bookName"
              placeholder="图书名称"
            ></el-input>
          </el-form-item>
          <el-form-item label="图书作者">
            <el-input
              v-model="listParm.bookAuther"
              placeholder="图书作者"
            ></el-input>
          </el-form-item>
        </template>
        <template v-slot:rightCondition="{ scope }">
          <el-form-item label="名称">
            <el-input v-model="scope.bookName" placeholder="名称"></el-input>
          </el-form-item>
        </template>
      </elt-transfer>
    </div>
  </el-main>
</template>

<script>
import { borrowApi } from "@/api/borrow";
import { getByUserNameApi } from "@/api/reader";
import { getListApi } from "@/api/book";
import eltTransfer from "elt-transfer/src/eltTransfer";
export default {
  components: {
    "elt-transfer": eltTransfer,
  },
  data() {
    return {
      returnTime: "",
      bookIds: [],
      tableData: [],
      leftColumns: [
        { label: "图书名称", id: "bookName", width: "120px" },
        { label: "图书分类", id: "categoryName", width: "120px" },
        { label: "书架号", id: "bookPlaceNum" },
        { label: "作者", id: "bookAuther" },
        { label: "出版社", id: "bookProduct" },
        { label: "库存", id: "bookStore" },
      ],
      //读者信息搜索框
      searchParm: {
        username: "",
      },
      showUser: {
        readerId: "",
        learnNum: "",
        username: "",
        idCard: "",
        sex: "",
        phone: "",
        className: "",
        checkStatus: "",
      },
      listParm: {
        currentPage: "",
        pageSize: "",
        bookName: "",
        bookAuther: "",
      },
    };
  },
  methods: {
    //借书按钮
    async borrowBtn() {
      this.bookIds = [];
      if (!this.returnTime) {
        return this.$message.error("请选择还书时间!");
      }
      if (!this.showUser.readerId) {
        return this.$message.error("请查询借书人信息");
      }
      if (this.tableData.length == 0) {
        return this.$message.error("请选择要借的图书");
      }
      for (let i = 0; i < this.tableData.length; i++) {
        console.log(this.tableData[i]);
        this.bookIds.push(this.tableData[i].bookId);
      }
      let parm = {
        readerId: this.showUser.readerId,
        bookIds: this.bookIds,
        returnTime: this.returnTime,
      };
      let res = await borrowApi(parm);
      if (res && res.code == 200) {
        this.$message.success(res.msg);
        setTimeout(function () {
          window.location.reload();
        }, 3000);
      }
    },
    async paginationCallBack(obj) {
      console.log(obj);
      this.listParm.currentPage = obj.pageIndex;
      this.listParm.pageSize = obj.pageSize;
      let res = await getListApi(this.listParm);
      return new Promise((resolve, reject) => {
        try {
          resolve({ total: res.data.total, data: res.data.records });
        } catch {
          reject();
        }
      });
    },
    clearTransfer() {
      this.$refs.eltTransfer.clear();
    },
    //根据学号查询读者
    async getByUserName() {
      let res = await getByUserNameApi(this.searchParm);
      console.log(res);
      if (res && res.code == 200 && res.data) {
        this.showUser = res.data;
      }
    },
    resetBtn() {
      this.returnTime = "";
      this.searchParm.username = "";
      this.showUser.readerId = "";
      this.showUser.learnNum = "";
      this.showUser.username = "";
      this.showUser.idCard = "";
      this.showUser.sex = "";
      this.showUser.phone = "";
      this.showUser.className = "";
      this.showUser.checkStatus = "";
    },
  },
};
</script>

<style scoped>
::v-deep .el-card__header {
  padding: 15px 0px 0px 0px;
}
::v-deep .el-card__body {
  padding: 15px 0px 0px 0px;
}
</style>
```





#### 第46讲 还书列表功能开发

##### 1、新建还书实体类

```js
package com.itmk.web.borrow_book.entity;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;
import java.util.Date;

@Data
public class ReturnBook {
    private Long borrowId;
    private String bookName;
    private String bookPlaceNum;
    private String username;
    private String learnNum;
    private String className;
    private String phone;
    private String borrowStatus;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date borrowTime;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date returnTime;
}

```

```js
package com.itmk.web.borrow_book.entity;

import lombok.Data;

@Data
public class ListParm {
    private Long currentPage;
    private Long pageSize;
    private String username;
    private String borrowStatus;
}

```



##### 2、BorrowBookMapper接口添加getBorrowList()方法

```js
package com.itmk.web.borrow_book.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.ListParm;
import com.itmk.web.borrow_book.entity.ReturnBook;
import org.apache.ibatis.annotations.Param;

public interface BorrowBookMapper extends BaseMapper<BorrowBook> {
    IPage<ReturnBook> getBorrowList(Page<ReturnBook> page, @Param("parm") ListParm parm);
}

```

##### 3、映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.borrow_book.mapper.BorrowBookMapper">
    <select id="getBorrowList" resultType="com.itmk.web.borrow_book.entity.ReturnBook">
        select b.borrow_id,sb.book_name,sb.book_place_num, sr.username,sr.learn_num,sr.class_name,sr.phone,b.borrow_time,b.return_time,b.borrow_status
        from  borrow_book as b left join sys_books as sb on b.book_id = sb.book_id
        left join sys_reader as sr  on b.reader_id = sr.reader_id
        where 1=1
        <if test="parm.username != null and parm.username !=''">
            and sr.username =#{parm.username}
        </if>
         <if test="parm.borrowStatus != null and parm.borrowStatus !=''">
            and b.borrow_status =#{parm.borrowStatus}
        </if>
        order by b.borrow_time desc
    </select>
</mapper>
```

##### 4、BorrowBookService添加getBorrowList()方法

```js
package com.itmk.web.borrow_book.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.BorrowParm;
import com.itmk.web.borrow_book.entity.ListParm;
import com.itmk.web.borrow_book.entity.ReturnBook;

public interface BorrowBookService extends IService<BorrowBook> {
    void borrow(BorrowParm borrowParm);
    IPage<ReturnBook> getBorrowList(ListParm parm);
}

```

**实现类**

```js
package com.itmk.web.borrow_book.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.exception.BusinessException;
import com.itmk.exception_advice.BusinessExceptionEnum;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.BorrowParm;
import com.itmk.web.borrow_book.entity.ListParm;
import com.itmk.web.borrow_book.entity.ReturnBook;
import com.itmk.web.borrow_book.mapper.BorrowBookMapper;
import com.itmk.web.borrow_book.service.BorrowBookService;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.stream.Collectors;

@Service
public class BorrowBookServiceImpl extends ServiceImpl<BorrowBookMapper, BorrowBook> implements BorrowBookService {
    @Autowired
    private SysBooksService sysBooksService;


    private Lock lock = new ReentrantLock();

    @Override
    @Transactional
    public void borrow(BorrowParm borrowParm) {
        lock.lock();
        try {
            //查询图书库存
            QueryWrapper<SysBooks> query = new QueryWrapper<>();
            query.lambda().in(SysBooks::getBookId, borrowParm.getBookIds());
            List<SysBooks> list = sysBooksService.list(query);
            List<SysBooks> collect = list.stream().filter(item -> item.getBookStore().longValue() < 1L).collect(Collectors.toList());
            //如果存在库存不足
            if (collect.size() > 0) {
                List<String> stringList = collect.stream().map(SysBooks::getBookName).collect(Collectors.toList());
                throw new BusinessException(BusinessExceptionEnum.NO_STOCK.getCode(),
                        stringList + BusinessExceptionEnum.NO_STOCK.getMessage());
            }
            //库存充足，减库存，插入借书明细
            List<Long> bookIds = borrowParm.getBookIds();
            for(int i=0;i<bookIds.size();i++){
                Long bookId = bookIds.get(i);
                //减库存
                int res = sysBooksService.subBook(bookId);
                //查询借书表数据
                if(res > 0){
                    BorrowBook borrowBook = new BorrowBook();
                    borrowBook.setBookId(bookId);
                    borrowBook.setReaderId(borrowParm.getReaderId());
                    borrowBook.setReturnTime(borrowParm.getReturnTime());
                    borrowBook.setApplyStatus("1");
                    borrowBook.setBorrowStatus("1");
                    borrowBook.setBorrowTime(new Date());
                    this.baseMapper.insert(borrowBook);
                }
            }
        } finally {
            lock.unlock();
        }

    }

    @Override
    public IPage<ReturnBook> getBorrowList(ListParm parm) {
        //构造分页对象
        Page<ReturnBook> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        return this.baseMapper.getBorrowList(page,parm);
    }
}

```

##### 5、BorrowBookController控制器添加getBorrowList()方法

```js
package com.itmk.web.borrow_book.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.borrow_book.entity.BorrowBook;
import com.itmk.web.borrow_book.entity.BorrowParm;
import com.itmk.web.borrow_book.entity.ListParm;
import com.itmk.web.borrow_book.entity.ReturnBook;
import com.itmk.web.borrow_book.service.BorrowBookService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/borrow")
public class BorrowBookController {
    @Autowired
    private BorrowBookService borrowBookService;

    //借书
    @PostMapping
    public ResultVo borrow(@RequestBody BorrowParm borrowParm){
        borrowBookService.borrow(borrowParm);
        return ResultUtils.success("借书成功!");
    }

    //还书列表
    @GetMapping("/getBorrowList")
    public ResultVo getBorrowList(ListParm parm){
        IPage<ReturnBook> borrowList = borrowBookService.getBorrowList(parm);
        return ResultUtils.success("查询成功",borrowList);
    }
}

```

**6、bookReturn.vue页面**

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listparm" label-width="80px" :inline="true" size="small">
      <el-form-item label="学号">
        <el-input v-model="listparm.username"></el-input>
      </el-form-item>
      <el-form-item label="借书状态">
        <el-select v-model="listparm.borrowStatus" placeholder="请选择">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">查询</el-button>
        <el-button icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" icon="el-icon-edit" @click="returnBtn"
          >还书</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="bookName" label="图书名称"> </el-table-column>
      <el-table-column prop="bookPlaceNum" label="书架号"> </el-table-column>
      <el-table-column prop="username" label="学号"> </el-table-column>
      <el-table-column prop="learnNum" label="读者"> </el-table-column>
      <el-table-column prop="className" label="班级"> </el-table-column>
      <el-table-column prop="phone" label="电话"> </el-table-column>
      <el-table-column prop="borrowTime" label="借书时间"> </el-table-column>
      <el-table-column prop="returnTime" label="还书时间"> </el-table-column>
      <el-table-column prop="borrowStatus" label="借书状态" align="center" width="100">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.borrowStatus == '1'">在借中</el-tag>
          <el-tag type="success" v-if="scope.row.borrowStatus == '2'">已还</el-tag>
          <el-tag type="danger" v-if="scope.row.borrowStatus == '3'">拒绝</el-tag>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listparm.currentPage"
      :page-sizes="[10,20, 40, 80, 100]"
      :page-size="listparm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listparm.total" background>
    </el-pagination>
    
  </el-main>
</template>

<script>
import { returnBorrowApi } from "@/api/borrow";
export default {
  data() {
    return {
      tableHeight:0,
      tableData: [],
      options: [
        {
          value: "1",
          label: "在借中",
        },
        {
          value: "2",
          label: "已还",
        },
        {
          value: "3",
          label: "拒绝",
        },
      ],
      listparm: {
        currentPage: 1,
        pageSize: 10,
        username: "",
        borrowStatus: "1",
        total:0
      },
    };
  },
  mounted(){
    this.$nextTick(() =>{
      this.tableHeight = window.innerHeight -220
    })
  },
  created() {
    this.returnBorrow();
  },
  methods: {
    currentChange(val){

    },
    sizeChange(val){

    },
    searchBtn() {
      this.returnBorrow()
    },
    resetBtn() {
      this.listparm.currentPage = 1;
      this.listparm.username = '';
      this.listparm.borrowStatus = '';
      this.returnBorrow()
    },
    returnBtn() {},
    async returnBorrow() {
      let res = await returnBorrowApi(this.listparm);
      if (res && res.code == 200) {
        console.log(res);
        this.listparm.total = res.data.total;
        this.tableData = res.data.records
      }
    },
  },
};
</script>

<style>
</style>
```





#### 第47讲 还书功能开发

##### 1、新建参数接收类

```js
package com.itmk.web.borrow_book.entity;

import lombok.Data;

@Data
public class ReturnParm {

    private Long borrowId;
    //图书id
    private Long bookId;
}

```

##### 2、BorrowBookService接口添加returnBook()方法

```js
package com.itmk.web.borrow_book.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.borrow_book.entity.*;

import java.util.List;

public interface BorrowBookService extends IService<BorrowBook> {
    //借书
    void borrow(BorrowParm borrowParm);
    //还书列表
    IPage<ReturnBook> getBorrowList(ListParm parm);
    //还书
    void returnBook(List<ReturnParm> list);
}

```

**实现类**

```js
package com.itmk.web.borrow_book.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.exception.BusinessException;
import com.itmk.exception_advice.BusinessExceptionEnum;
import com.itmk.web.borrow_book.entity.*;
import com.itmk.web.borrow_book.mapper.BorrowBookMapper;
import com.itmk.web.borrow_book.service.BorrowBookService;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.stream.Collectors;

@Service
public class BorrowBookServiceImpl extends ServiceImpl<BorrowBookMapper, BorrowBook> implements BorrowBookService {
    @Autowired
    private SysBooksService sysBooksService;


    private Lock lock = new ReentrantLock();

    @Override
    @Transactional
    public void borrow(BorrowParm borrowParm) {
        lock.lock();
        try {
            //查询图书库存
            QueryWrapper<SysBooks> query = new QueryWrapper<>();
            query.lambda().in(SysBooks::getBookId, borrowParm.getBookIds());
            List<SysBooks> list = sysBooksService.list(query);
            List<SysBooks> collect = list.stream().filter(item -> item.getBookStore().longValue() < 1L).collect(Collectors.toList());
            //如果存在库存不足
            if (collect.size() > 0) {
                List<String> stringList = collect.stream().map(SysBooks::getBookName).collect(Collectors.toList());
                throw new BusinessException(BusinessExceptionEnum.NO_STOCK.getCode(),
                        stringList + BusinessExceptionEnum.NO_STOCK.getMessage());
            }
            //库存充足，减库存，插入借书明细
            List<Long> bookIds = borrowParm.getBookIds();
            for (int i = 0; i < bookIds.size(); i++) {
                Long bookId = bookIds.get(i);
                //减库存
                int res = sysBooksService.subBook(bookId);
                //查询借书表数据
                if (res > 0) {
                    BorrowBook borrowBook = new BorrowBook();
                    borrowBook.setBookId(bookId);
                    borrowBook.setReaderId(borrowParm.getReaderId());
                    borrowBook.setReturnTime(borrowParm.getReturnTime());
                    borrowBook.setApplyStatus("1");
                    borrowBook.setBorrowStatus("1");
                    borrowBook.setBorrowTime(new Date());
                    this.baseMapper.insert(borrowBook);
                }
            }
        } finally {
            lock.unlock();
        }

    }

    @Override
    public IPage<ReturnBook> getBorrowList(ListParm parm) {
        //构造分页对象
        Page<ReturnBook> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        return this.baseMapper.getBorrowList(page, parm);
    }

    @Override
    @Transactional
    public void returnBook(List<ReturnParm> list) {
        for (int i = 0; i < list.size(); i++) {
            //更新图书库存
            int res = sysBooksService.addBook(list.get(i).getBookId());
            if (res > 0) {
                //更新状态为还书
                BorrowBook borrowBook = new BorrowBook();
                borrowBook.setBorrowStatus("2");
                borrowBook.setBorrowId(list.get(i).getBorrowId());
                this.baseMapper.updateById(borrowBook);
            }
        }
    }
}

```

##### 3、SysBooksService接口添加addBook()方法

```js
package com.itmk.web.sys_books.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;

public interface SysBooksService extends IService<SysBooks> {
    IPage<SysBooks> getList(ListParm parm);
    //借书减库存
    int subBook(Long bookId);
    //还书加库存
    int addBook(Long bookId);
}

```

**实现类**

```js
package com.itmk.web.sys_books.service.impl;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.mapper.SysBooksMapper;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.stereotype.Service;

@Service
public class SysBooksServiceImpl extends ServiceImpl<SysBooksMapper, SysBooks> implements SysBooksService {
    @Override
    public IPage<SysBooks> getList(ListParm parm) {
        //构造分页对象
        Page<SysBooks> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        return this.baseMapper.getList(page,parm);
    }

    @Override
    public int subBook(Long bookId) {
        return this.baseMapper.subBook(bookId);
    }

    @Override
    public int addBook(Long bookId) {
        return this.baseMapper.addBook(bookId);
    }
}

```

##### 4、SysBooksMapper接口添加addBook()方法

```js
package com.itmk.web.sys_books.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.web.sys_books.entity.ListParm;
import com.itmk.web.sys_books.entity.SysBooks;
import org.apache.ibatis.annotations.Param;

public interface SysBooksMapper extends BaseMapper<SysBooks> {
    IPage<SysBooks> getList(Page<SysBooks> page,@Param("parm") ListParm parm);
    //借书减库存
    int subBook(@Param("bookId") Long bookId);
    //还书加库存
    int addBook(@Param("bookId") Long bookId);
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_books.mapper.SysBooksMapper">
    <select id="getList" resultType="com.itmk.web.sys_books.entity.SysBooks">
        select b.*,c.category_name from sys_books as b , sys_category as c where b.category_id = c.category_id
        <if test="parm.categoryId != null and parm.categoryId !=''">
            and c.category_id =#{parm.categoryId}
        </if>
        <if test="parm.bookName != null and parm.bookName !=''">
            and b.book_name like CONCAT('%',#{parm.bookName},'%')
        </if>
        <if test="parm.bookPlaceNum != null and parm.bookPlaceNum !=''">
            and b.book_place_num like CONCAT('%',#{parm.bookPlaceNum},'%')
        </if>
        <if test="parm.bookAuther != null and parm.bookAuther !=''">
            and b.book_auther like CONCAT('%',#{parm.bookAuther},'%')
        </if>
    </select>
    <update id="subBook">
        update sys_books set book_store = book_store -1 where book_id =#{bookId} and book_store > 0
    </update>
    <update id="addBook">
        update sys_books set book_store = book_store + 1 where book_id =#{bookId}
    </update>
</mapper>
```

##### 5、BorrowBookController控制器添加returnBook()方法

```js
package com.itmk.web.borrow_book.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.borrow_book.entity.*;
import com.itmk.web.borrow_book.service.BorrowBookService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/borrow")
public class BorrowBookController {
    @Autowired
    private BorrowBookService borrowBookService;

    //借书
    @PostMapping
    public ResultVo borrow(@RequestBody BorrowParm borrowParm){
        borrowBookService.borrow(borrowParm);
        return ResultUtils.success("借书成功!");
    }

    //还书列表
    @GetMapping("/getBorrowList")
    public ResultVo getBorrowList(ListParm parm){
        IPage<ReturnBook> borrowList = borrowBookService.getBorrowList(parm);
        return ResultUtils.success("查询成功",borrowList);
    }

    //还书
    @PostMapping("/returnBook")
    public ResultVo returnBook(@RequestBody List<ReturnParm> list){
        borrowBookService.returnBook(list);
        return ResultUtils.success("还书成功!");
    }
}

```



#### 第48讲 异常还书功能开发

##### 1、新建参数接收类

```js
package com.itmk.web.book_borrow.entity;

import lombok.Data;

@Data
public class ExceptionParm {
    private Long borrowId;
    //图书id
    private Long bookId;
    //判断是异常还是丢失 0：异常 1：丢失
    private String type;
    //异常还书备注
    private String excepionText;

}

```

##### 2、BorrowBookService接口添加exceptionBook()方法

```js
package com.itmk.web.book_borrow.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.book_borrow.entity.*;

import java.util.List;


public interface BorrowBookService extends IService<BorrowBook> {
    //借书
    void borrow(BorrowParm parm);
    //还书列表
    IPage<ReturnBook> getBorrowList(ListParm parm);
    //还书
    void returnBook(List<ReturnParm> list);
    //异常还书
    void exceptionBook(ExceptionParm parm);
}
```

**实现类**

```js
package com.itmk.web.book_borrow.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.exception.BusinessException;
import com.itmk.exception_advice.BusinessExceptionEnum;
import com.itmk.web.book_borrow.entity.*;
import com.itmk.web.book_borrow.mapper.BorrowBookMapper;
import com.itmk.web.book_borrow.service.BorrowBookService;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.stream.Collectors;

@Service
public class BorrowBookServiceImpl extends ServiceImpl<BorrowBookMapper, BorrowBook> implements BorrowBookService {

    @Autowired
    private SysBooksService sysBooksService;

    private Lock lock = new ReentrantLock();

    @Override
    @Transactional
    public void borrow(BorrowParm parm) {
        //加锁
        lock.lock();
        try {
            //构造查询条件
            QueryWrapper<SysBooks> query = new QueryWrapper<>();
            query.lambda().in(SysBooks::getBookId, parm.getBookIds());
            List<SysBooks> list = sysBooksService.list(query);
            //查看库存是否充足
            List<SysBooks> collect = list.stream().filter(item -> item.getBookStore().longValue() < 1L).collect(Collectors.toList());
            if (collect.size() > 0) {
                //提示哪本图书库存不足
                List<String> stringList = collect.stream().map(SysBooks::getBookName).collect(Collectors.toList());
                throw new BusinessException(BusinessExceptionEnum.NO_STOCK.getCode(),
                        stringList + BusinessExceptionEnum.NO_STOCK.getMessage());
            }
            //减库存，插入借书明细
            List<Long> bookIds = parm.getBookIds();
            for (int i = 0; i < bookIds.size(); i++) {
                Long bookId = bookIds.get(i);
                //减库存
                int res = sysBooksService.subBook(bookId);
                if (res > 0) {
                    BorrowBook borrowBook = new BorrowBook();
                    borrowBook.setBookId(bookId);
                    borrowBook.setReaderId(parm.getReaderId());
                    borrowBook.setReturnTime(parm.getReturnTime());
                    borrowBook.setApplyStatus("1");
                    borrowBook.setBorrowStatus("1");
                    borrowBook.setBorrowTime(new Date());
                    //插入明细
                    this.baseMapper.insert(borrowBook);
                }
            }

        } finally {
            //释放锁
            lock.unlock();
        }
    }

    @Override
    public IPage<ReturnBook> getBorrowList(ListParm parm) {
        //构造分页对象
        Page<ReturnBook> page = new Page<>();
        page.setCurrent(parm.getCurrentPage());
        page.setSize(parm.getPageSize());
        return this.baseMapper.getBorrowList(page,parm);
    }

    @Override
    @Transactional
    public void returnBook(List<ReturnParm> list) {
        //加库存，变更借书状态
        for(int i=0;i<list.size();i++){
            //加库存
           int res = sysBooksService.addBook(list.get(i).getBookId());
           if(res > 0){
               //变更借书状态
               BorrowBook borrowBook = new BorrowBook();
               borrowBook.setBorrowId(list.get(i).getBorrowId());
               borrowBook.setBorrowStatus("2"); //已还
               borrowBook.setReturnStatus("1"); //正常还书
               this.baseMapper.updateById(borrowBook);
           }
        }

    }

    @Override
    public void exceptionBook(ExceptionParm parm) {
        // 0: 异常、破损  1：丢失 ：不能还库存
        String type = parm.getType();
        if(type.equals("0")){
            //加库存
           int res = sysBooksService.addBook(parm.getBookId());
           if(res > 0){
               //变更借书状态
               BorrowBook borrowBook = new BorrowBook();
               borrowBook.setBorrowId(parm.getBorrowId());
               borrowBook.setBorrowStatus("2"); //已还
               borrowBook.setReturnStatus("2"); //异常还书
               borrowBook.setExcepionText(parm.getExcepionText());
               this.baseMapper.updateById(borrowBook);
           }
        }else{ //丢失
             //变更借书状态
               BorrowBook borrowBook = new BorrowBook();
               borrowBook.setBorrowId(parm.getBorrowId());
               borrowBook.setBorrowStatus("2"); //已还
               borrowBook.setReturnStatus("3"); //丢失
               borrowBook.setExcepionText(parm.getExcepionText());
               this.baseMapper.updateById(borrowBook);
        }
    }
}

```

##### 3、BorrowBookController控制器添加exceptionBooks()方法

```js
package com.itmk.web.book_borrow.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.book_borrow.entity.*;
import com.itmk.web.book_borrow.service.BorrowBookService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/borrow")
public class BorrowBookController {
    @Autowired
    private BorrowBookService borrowBookService;

    @PostMapping
    public ResultVo borrow(@RequestBody BorrowParm parm){
        borrowBookService.borrow(parm);
        return ResultUtils.success("借书成功!");
    }

    //还书列表
    @GetMapping("/getBorrowList")
    public ResultVo getBorrowList(ListParm parm){
        IPage<ReturnBook> borrowList = borrowBookService.getBorrowList(parm);
        return ResultUtils.success("查询成功",borrowList);
    }

    //还书
    @PostMapping("/returnBooks")
    public ResultVo returnBooks(@RequestBody List<ReturnParm> parm){
        borrowBookService.returnBook(parm);
        return ResultUtils.success("还书成功!");
    }

    //异常还书
    @PostMapping("/exceptionBooks")
    public ResultVo exceptionBooks(@RequestBody ExceptionParm parm){
        borrowBookService.exceptionBook(parm);
        return ResultUtils.success("还书成功!");
    }
}

```

##### 4、api/borrow.js添加exceptionBooksApi()方法

```js
import http from '@/utils/http'
//借书
export const borrowApi = async(parm) =>{
    return await http.post("/api/borrow",parm);
}
//还书列表
export const returnBorrowApi = async(parm) =>{
    return await http.get("/api/borrow/getBorrowList",parm)
}
//还书
export const returnBooksApi = async(parm) =>{
    return await http.post("/api/borrow/returnBooks",parm)
}
//异常还书
export const exceptionBooksApi = async(parm) =>{
    return await http.post("/api/borrow/exceptionBooks",parm)
}
```

##### 5、bookReturn.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" label-width="80px" :inline="true" size="small">
      <el-form-item label="学号">
        <el-input v-model="listParm.username"></el-input>
      </el-form-item>
      <el-form-item label="借书状态">
        <el-select v-model="listParm.borrowStatus" placeholder="请选择">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn">重置</el-button>
        <el-button type="primary" icon="el-icon-edit" @click="returnBtn"
          >批量还书</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      ref="tables"
      :height="tableHeight"
      :data="tableData"
      border
      stripe
    >
      <el-table-column type="selection" width="55"> </el-table-column>
      <el-table-column prop="bookName" label="图书名称"> </el-table-column>
      <el-table-column prop="bookPlaceNum" label="书架号"> </el-table-column>
      <el-table-column prop="username" label="学号"> </el-table-column>
      <el-table-column prop="learnNum" label="读者"> </el-table-column>
      <el-table-column prop="className" label="班级"> </el-table-column>
      <el-table-column prop="phone" label="电话"> </el-table-column>
      <el-table-column prop="borrowTime" label="借书时间"> </el-table-column>
      <el-table-column prop="returnTime" label="还书时间"> </el-table-column>
      <el-table-column
        prop="borrowStatus"
        label="借书状态"
        align="center"
        width="100"
      >
        <template slot-scope="scope">
          <el-tag v-if="scope.row.borrowStatus == '1'">在借中</el-tag>
          <el-tag type="success" v-if="scope.row.borrowStatus == '2'"
            >已还</el-tag
          >
          <el-tag type="danger" v-if="scope.row.borrowStatus == '3'"
            >拒绝</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column label="操作" align="center" width="210">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="alongReturnBtn(scope.row)"
            >还书</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-edit"
            size="small"
            @click="ExceptioReturnBtn(scope.row)"
            >异常还书</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 异常还书备注 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="exception"
          ref="exceptionRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-form-item prop="type" label="异常类型">
            <el-select v-model="exception.type" placeholder="请选择">
              <el-option
                v-for="item in exoptions"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              >
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item prop="excepionText" label="备注">
            <el-input
              type="textarea"
              v-model="exception.excepionText"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  returnBorrowApi,
  returnBooksApi,
  exceptionBooksApi,
} from "@/api/borrow";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      rules: {
        type: [
          { required: true, message: "请选择异常类型", trigger: "change" },
        ],
        excepionText: [
          { required: true, message: "请填写备注", trigger: "change" },
        ],
      },
      exoptions: [
        {
          value: "0",
          label: "异常还书",
        },
        {
          value: "1",
          label: "丢失",
        },
      ],
      exception: {
        borrowId: "",
        bookId: "",
        type: "",
        excepionText: "",
      },
      //弹框属性定义
      dialog: {
        width: 630,
        height: 150,
        title: "还书备注",
        visible: false,
      },
      bookIds: [],
      tableHeight: 0,
      options: [
        {
          value: "1",
          label: "在借中",
        },
        {
          value: "2",
          label: "已还",
        },
        {
          value: "3",
          label: "拒绝",
        },
      ],
      tableData: [],
      listParm: {
        currentPage: 1,
        pageSize: 10,
        username: "",
        borrowStatus: "1",
        total: 0,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.returnBorrow();
  },
  methods: {
    onConfirm() {
      this.$refs.exceptionRef.validate(async (valid) => {
        if (valid) {
          let res = await exceptionBooksApi(this.exception);
          if (res && res.code == 200) {
            this.$message.success(res.msg)
            this.returnBorrow();
            this.dialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
    //异常还书的事件
    ExceptioReturnBtn(row) {
      this.exception.borrowId = row.borrowId
      this.exception.bookId = row.bookId
      this.dialog.visible = true;
    },
    //单独还书的事件
    async alongReturnBtn(row) {
      this.bookIds = [];
      console.log(row);
      let confirm = await this.$myconfirm("确定还书吗?");
      if (confirm) {
        if (row.borrowStatus == "1") {
          //在借中的才能还
          let obj = {};
          obj.borrowId = row.borrowId;
          obj.bookId = row.bookId;
          this.bookIds.push(obj);
          let res = await returnBooksApi(this.bookIds);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.returnBorrow();
          }
        }
      }
    },
    currentChange(val) {
      this.listParm.currentPage = val;
      this.returnBorrow();
    },
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.returnBorrow();
    },
    async returnBtn() {
      this.bookIds = [];
      let confirm = await this.$myconfirm("确定还书吗?");
      if (confirm) {
        let datas = this.$refs.tables.selection;
        if (datas.length == 0) {
          this.$message.error("请选择要还的书！");
          return;
        }
        for (let i = 0; i < datas.length; i++) {
          let obj = {};
          obj.borrowId = datas[i].borrowId;
          obj.bookId = datas[i].bookId;
          this.bookIds.push(obj);
        }
        let res = await returnBooksApi(this.bookIds);
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.returnBorrow();
        }
      }
    },
    resetBtn() {
      this.listParm.currentPage = 1;
      this.listParm.username = "";
      this.listParm.borrowStatus = "";
      this.returnBorrow();
    },
    searchBtn() {
      this.returnBorrow();
    },
    async returnBorrow() {
      let res = await returnBorrowApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
  },
};
</script>

<style>
</style>
```



#### 第49讲 还书bug解决



#### 第50讲 借阅查看接口开发

##### 1、新建返回值实体类

```js
package com.itmk.web.borrow_book.entity;

import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.util.Date;

@Data
public class LookBorrow {
    private Long borrowId;
    private Long bookId;
    private String bookName;
    private String bookPlaceNum;
    private String username;
    private String learnNum;
    private String className;
    private String phone;
    private String borrowStatus;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date borrowTime;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date returnTime;
    private String applyStatus;
    private String returnStatus;
    private String excepionText;
    private String applyText;
    private String timeStatus;
}

```

**参数接收实体类**

```js
package com.itmk.web.borrow_book.entity;

import lombok.Data;

@Data
public class LookParm {
    //当前页
    private Long currentPage;
    //每页条数
    private Long pageSize;
    //学号
    private String username;
    //姓名
    private String learnNum;
    private String bookName;
     //0: 待审核 1： 已审核  2：拒绝
    private String applyStatus;
    //1:在借中  2：已还   3：拒绝
    private String borrowStatus;
    //1: 正常还书 2：异常还书
    private String returnStatus;
    // 1:到期 0：未到期
    private String timeStatus;
}
```



##### 2、BorrowBookMapper接口添加getLookBorrowList()方法

```js
package com.itmk.web.borrow_book.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.itmk.web.borrow_book.entity.*;
import org.apache.ibatis.annotations.Param;

public interface BorrowBookMapper extends BaseMapper<BorrowBook> {
    IPage<ReturnBook> getBorrowList(Page<ReturnBook> page, @Param("parm") ListParm parm);
    //借阅查看
    IPage<LookBorrow> getLookBorrowList(Page<LookBorrow> page, @Param("parm") LookParm parm);
}
```

##### 3、映射文件

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.borrow_book.mapper.BorrowBookMapper">
    <select id="getBorrowList" resultType="com.itmk.web.borrow_book.entity.ReturnBook">
        select b.borrow_id,b.book_id,sb.book_name,sb.book_place_num,
        sr.username,sr.learn_num,sr.class_name,sr.phone,b.borrow_time,b.return_time,b.borrow_status
        from  borrow_book as b left join sys_books as sb on b.book_id = sb.book_id
        left join sys_reader as sr  on b.reader_id = sr.reader_id
        where 1=1
        <if test="parm.username != null and parm.username !=''">
            and sr.username =#{parm.username}
        </if>
         <if test="parm.borrowStatus != null and parm.borrowStatus !=''">
            and b.borrow_status =#{parm.borrowStatus}
        </if>
        order by b.borrow_time desc
    </select>
    <select id="getLookBorrowList" resultType="com.itmk.web.borrow_book.entity.LookBorrow">
        select t.* from(
        select b.borrow_id,b.book_id,sb.book_name,sb.book_place_num,
        sr.username,sr.learn_num,sr.class_name,sr.phone,b.borrow_time,b.return_time,b.borrow_status,b.apply_status,b.return_status,b.excepion_text,b.apply_text,
		case when b.return_time &lt;  now()  then '1' else '0' end as time_status
        from  borrow_book as b left join sys_books as sb on b.book_id = sb.book_id
        left join sys_reader as sr  on b.reader_id = sr.reader_id
        order by b.borrow_time desc)t
        where 1=1
        <if test="parm.username != null and parm.username !=''">
            and t.username =#{parm.username}
        </if>
        <if test="parm.borrowStatus != null and parm.borrowStatus !=''">
            and t.borrow_status =#{parm.borrowStatus}
        </if>
        <if test="parm.learnNum != null and parm.learnNum !=''">
            and t.learn_num  like CONCAT('%',#{parm.learnNum},'%')
        </if>
        <if test="parm.bookName != null and parm.bookName !=''">
            and t.book_name  like CONCAT('%',#{parm.bookName},'%')
        </if>
        <if test="parm.applyStatus != null and parm.applyStatus !=''">
            and t.apply_status =#{parm.applyStatus}
        </if>
        <if test="parm.returnStatus != null and parm.returnStatus !=''">
            and t.return_status =#{parm.returnStatus}
        </if>
        <if test="parm.timeStatus != null and parm.timeStatus !=''">
            and t.time_status =#{parm.timeStatus}
        </if>
        order by t.borrow_time desc
    </select>
</mapper>
```

##### 4、BorrowBookService接口添加getLookBorrowList()方法

```js
package com.itmk.web.borrow_book.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.borrow_book.entity.*;


import java.util.List;

public interface BorrowBookService extends IService<BorrowBook> {
    //借书
    void borrow(BorrowParm borrowParm);
    //还书列表
    IPage<ReturnBook> getBorrowList(ListParm parm);
    //还书
    void returnBook(List<ReturnParm> list);
    //借阅查看
    IPage<LookBorrow> getLookBorrowList(LookParm parm);
}

```

**实现类**

```js
package com.itmk.web.borrow_book.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.exception.BusinessException;
import com.itmk.exception_advice.BusinessExceptionEnum;
import com.itmk.web.borrow_book.entity.*;
import com.itmk.web.borrow_book.mapper.BorrowBookMapper;
import com.itmk.web.borrow_book.service.BorrowBookService;
import com.itmk.web.sys_books.entity.SysBooks;
import com.itmk.web.sys_books.service.SysBooksService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.stream.Collectors;

@Service
public class BorrowBookServiceImpl extends ServiceImpl<BorrowBookMapper, BorrowBook> implements BorrowBookService {
    @Autowired
    private SysBooksService sysBooksService;


    private Lock lock = new ReentrantLock();

    @Override
    @Transactional
    public void borrow(BorrowParm borrowParm) {
        lock.lock();
        try {
            //查询图书库存
            QueryWrapper<SysBooks> query = new QueryWrapper<>();
            query.lambda().in(SysBooks::getBookId, borrowParm.getBookIds());
            List<SysBooks> list = sysBooksService.list(query);
            List<SysBooks> collect = list.stream().filter(item -> item.getBookStore().longValue() < 1L).collect(Collectors.toList());
            //如果存在库存不足
            if (collect.size() > 0) {
                List<String> stringList = collect.stream().map(SysBooks::getBookName).collect(Collectors.toList());
                throw new BusinessException(BusinessExceptionEnum.NO_STOCK.getCode(),
                        stringList + BusinessExceptionEnum.NO_STOCK.getMessage());
            }
            //库存充足，减库存，插入借书明细
            List<Long> bookIds = borrowParm.getBookIds();
            for (int i = 0; i < bookIds.size(); i++) {
                Long bookId = bookIds.get(i);
                //减库存
                int res = sysBooksService.subBook(bookId);
                //查询借书表数据
                if (res > 0) {
                    BorrowBook borrowBook = new BorrowBook();
                    borrowBook.setBookId(bookId);
                    borrowBook.setReaderId(borrowParm.getReaderId());
                    borrowBook.setReturnTime(borrowParm.getReturnTime());
                    borrowBook.setApplyStatus("1");
                    borrowBook.setBorrowStatus("1");
                    borrowBook.setBorrowTime(new Date());
                    this.baseMapper.insert(borrowBook);
                }
            }
        } finally {
            lock.unlock();
        }

    }

    @Override
    public IPage<ReturnBook> getBorrowList(ListParm parm) {
        //构造分页对象
        Page<ReturnBook> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        return this.baseMapper.getBorrowList(page, parm);
    }

    @Override
    @Transactional
    public void returnBook(List<ReturnParm> list) {
        for (int i = 0; i < list.size(); i++) {
            //更新图书库存
            int res = sysBooksService.addBook(list.get(i).getBookId());
            if (res > 0) {
                //更新状态为还书
                BorrowBook borrowBook = new BorrowBook();
                borrowBook.setBorrowStatus("2");
                borrowBook.setReturnStatus("1");
                borrowBook.setBorrowId(list.get(i).getBorrowId());
                this.baseMapper.updateById(borrowBook);
            }
        }
    }

    @Override
    public IPage<LookBorrow> getLookBorrowList(LookParm parm) {
        //构造分页对象
        Page<LookBorrow> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        return this.baseMapper.getLookBorrowList(page,parm);
    }
}

```

##### 5、控制器添加getLookBorrowList()方法

```js
package com.itmk.web.borrow_book.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.borrow_book.entity.*;
import com.itmk.web.borrow_book.service.BorrowBookService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/borrow")
public class BorrowBookController {
    @Autowired
    private BorrowBookService borrowBookService;

    //借书
    @PostMapping
    public ResultVo borrow(@RequestBody BorrowParm borrowParm){
        borrowBookService.borrow(borrowParm);
        return ResultUtils.success("借书成功!");
    }

    //还书列表
    @GetMapping("/getBorrowList")
    public ResultVo getBorrowList(ListParm parm){
        IPage<ReturnBook> borrowList = borrowBookService.getBorrowList(parm);
        return ResultUtils.success("查询成功",borrowList);
    }

    //还书
    @PostMapping("/returnBook")
    public ResultVo returnBook(@RequestBody List<ReturnParm> list){
        borrowBookService.returnBook(list);
        return ResultUtils.success("还书成功!");
    }

    //借阅查看
    @GetMapping("/getLookBorrowList")
    public ResultVo getLookBorrowList(LookParm parm){
        IPage<LookBorrow> borrowList = borrowBookService.getLookBorrowList(parm);
        return ResultUtils.success("查询成功",borrowList);
    }
}

```



#### 第51讲借阅列表制作与对接

##### 1、router添加借阅列表页面路由

```js
import Vue from 'vue'
import Router from 'vue-router'

Vue.use(Router)

/* Layout */
import Layout from '@/layout'

/**
 * Note: sub-menu only appear when route children.length >= 1
 * Detail see: https://panjiachen.github.io/vue-element-admin-site/guide/essentials/router-and-nav.html
 *
 * hidden: true                   if set true, item will not show in the sidebar(default is false)
 * alwaysShow: true               if set true, will always show the root menu
 *                                if not set alwaysShow, when item has more than one children route,
 *                                it will becomes nested mode, otherwise not show the root menu
 * redirect: noRedirect           if set noRedirect will no redirect in the breadcrumb
 * name:'router-name'             the name is used by <keep-alive> (must set!!!)
 * meta : {
    roles: ['admin','editor']    control the page roles (you can set multiple roles)
    title: 'title'               the name show in sidebar and breadcrumb (recommend set)
    icon: 'svg-name'/'el-icon-x' the icon show in the sidebar
    breadcrumb: false            if set false, the item will hidden in breadcrumb(default is true)
    activeMenu: '/example/list'  if set path, the sidebar will highlight the path you set
  }
 */

/**
 * constantRoutes
 * a base page that does not have permission requirements
 * all roles can be accessed
 */
export const constantRoutes = [
  {
    path: '/login',
    component: () => import('@/views/login/index'),
    hidden: true
  },

  {
    path: '/404',
    component: () => import('@/views/404'),
    hidden: true
  },

  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [{
      path: 'dashboard',
      name: 'Dashboard',
      component: () => import('@/views/dashboard/index'),
      meta: { title: '首页', icon: 'dashboard', affix: true }
    }]
  }
]

/**
 * asyncRoutes 需要权限才能访问
 * the routes that need to be dynamically loaded based on user roles
 */
export const asyncRoutes = [
  {
    path: '/system',
    component: Layout,
    alwaysShow: true,
    name: 'system',
    meta: { title: '系统管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/sysUserList',
        name: 'sysUserList',
        component: () => import('@/views/system/sysUserList'),
        meta: { title: '用户管理', icon: 'table' }
      },
      {
        path: '/sysRoleList',
        name: 'sysRoleList',
        component: () => import('@/views/system/sysRoleList'),
        meta: { title: '角色管理', icon: 'tree' }
      },
      {
        path: '/sysMenuList',
        name: 'sysMenuList',
        component: () => import('@/views/system/sysMenuList'),
        meta: { title: '菜单管理', icon: 'tree' }
      }
    ]
  },
  {
    path: '/reader',
    component: Layout,
    name: 'reader',
    alwaysShow: true,
    meta: { title: '读者管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/readerList',
        name: 'readerList',
        component: () => import('@/views/reader/readerList'),
        meta: { title: '读者列表', icon: 'table' }
      }
    ]
  },
  {
    path: '/book',
    component: Layout,
    alwaysShow: true,
    name: 'book',
    meta: { title: '图书管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/bookCategory',
        name: 'bookCategory',
        component: () => import('@/views/book/bookCategory'),
        meta: { title: '图书分类', icon: 'table' }
      },
      {
        path: '/bookList',
        name: 'bookList',
        component: () => import('@/views/book/bookList'),
        meta: { title: '图书列表', icon: 'table' }
      }
    ]
  },
  {
    path: '/borrow',
    component: Layout,
    alwaysShow: true,
    name: 'borrow',
    meta: { title: '借阅管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/bookBorrow',
        name: 'bookBorrow',
        component: () => import('@/views/borrow/bookBorrow'),
        meta: { title: '借书管理', icon: 'table' }
      },
      {
        path: '/bookReturn',
        name: 'bookReturn',
        component: () => import('@/views/borrow/bookReturn'),
        meta: { title: '还书管理', icon: 'el-icon-document-copy' }
      },
      {
        path: '/borrowLook',
        name: 'borrowLook',
        component: () => import('@/views/borrow/borrowLook'),
        meta: { title: '借阅查看', icon: 'el-icon-s-cooperation' }
      }
    ]
  },
  // 404 page must be placed at the end !!!
  { path: '*', redirect: '/404', hidden: true }
]

const createRouter = () => new Router({
  // mode: 'history', // require service support
  scrollBehavior: () => ({ y: 0 }),
  routes: constantRoutes
})

const router = createRouter()

// Detail see: https://github.com/vuejs/vue-router/issues/1234#issuecomment-357941465
export function resetRouter() {
  const newRouter = createRouter()
  router.matcher = newRouter.matcher // reset router
}

export default router

```



##### 2、api/borrow.js添加getLookBorrowListApi()方法

```js
import http from '@/utils/http'
//借书
export const borrowApi = async(parm) =>{
    return await http.post("/api/borrow",parm)
}
//还书列表
export const returnBorrowApi = async(parm) =>{
    return await http.get("/api/borrow/getBorrowList",parm)
}
//还书
export const returnBookApi = async(parm) =>{
    return await http.post("/api/borrow/returnBook",parm)
}
//借阅列表
export const getLookBorrowListApi = async(parm) =>{
    return await http.get("/api/borrow/getLookBorrowList",parm)
}
```

##### 3、borrowLook.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="lookParm" label-width="80px" :inline="true" size="mini">
      <el-form-item label="读者学号">
        <el-input v-model="lookParm.username"></el-input>
      </el-form-item>
      <el-form-item label="读者姓名">
        <el-input v-model="lookParm.learnNum"></el-input>
      </el-form-item>
      <el-form-item label="图书名称">
        <el-input v-model="lookParm.bookName"></el-input>
      </el-form-item>
      <el-form-item label="借书状态">
        <el-select v-model="lookParm.borrowStatus" placeholder="请选择">
          <el-option
            v-for="item in options"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="异常状态">
        <el-select v-model="lookParm.returnStatus" placeholder="请选择">
          <el-option
            v-for="item in exceoptions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="到期状态">
        <el-select v-model="lookParm.timeStatus" placeholder="请选择">
          <el-option
            v-for="item in timetions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item label="审核状态">
        <el-select v-model="lookParm.applyStatus" placeholder="请选择">
          <el-option
            v-for="item in applytions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          >
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button style="color: #ff7670" icon="el-icon-close">重置</el-button>
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      size="small"
      ref="tables"
      :height="tableHeight"
      :data="tableData"
      border
      stripe
    >
      <el-table-column type="selection" width="55"> </el-table-column>
      <el-table-column prop="bookName" label="图书名称"> </el-table-column>
      <el-table-column prop="bookPlaceNum" label="书架号"> </el-table-column>
      <el-table-column prop="username" label="学号"> </el-table-column>
      <el-table-column prop="learnNum" label="读者"> </el-table-column>
      <el-table-column prop="className" label="班级"> </el-table-column>
      <el-table-column prop="phone" label="电话"> </el-table-column>
      <el-table-column prop="borrowTime" label="借书时间"> </el-table-column>
      <el-table-column prop="returnTime" label="还书时间"> </el-table-column>
      <el-table-column prop="applyText" label="审核备注"> </el-table-column>
      <el-table-column prop="excepionText" label="还书备注"> </el-table-column>
      <el-table-column
        prop="borrowStatus"
        label="借书状态"
        align="center"
        width="100"
      >
        <template slot-scope="scope">
          <el-tag v-if="scope.row.borrowStatus == '1'">在借中</el-tag>
          <el-tag type="success" v-if="scope.row.borrowStatus == '2'"
            >已还</el-tag
          >
          <el-tag type="danger" v-if="scope.row.borrowStatus == '3'"
            >拒绝</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column
        prop="timeStatus"
        label="到期状态"
        align="center"
        width="100"
      >
        <template slot-scope="scope">
          <el-tag type="danger" v-if="scope.row.timeStatus == '1'">到期</el-tag>
          <el-tag type="success" v-if="scope.row.timeStatus == '0'"
            >未到期</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column
        prop="applyStatus"
        label="审核状态"
        align="center"
        width="100"
      >
        <template slot-scope="scope">
          <el-tag type="danger" v-if="scope.row.applyStatus == '0'">待审核</el-tag>
          <el-tag type="success" v-if="scope.row.applyStatus == '1'">已审核</el-tag>
          <el-tag type="danger" v-if="scope.row.applyStatus == '2'">拒绝</el-tag>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="lookParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="lookParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="lookParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getLookBorrowListApi } from "@/api/borrow";
export default {
  data() {
    return {
      tableData: [],
      applytions: [
        {
          value: "0",
          label: "待审核",
        },
        {
          value: "1",
          label: "已审核",
        },
        {
          value: "2",
          label: "拒绝",
        },
      ],
      timetions: [
        {
          value: "1",
          label: "到期",
        },
        {
          value: "0",
          label: "未到期",
        },
      ],
      exceoptions: [
        {
          value: "1",
          label: "正常还书",
        },
        {
          value: "2",
          label: "异常还书",
        },
      ],
      options: [
        {
          value: "1",
          label: "在借中",
        },
        {
          value: "2",
          label: "已还",
        },
        {
          value: "3",
          label: "拒绝",
        },
      ],
      lookParm: {
        total: 0,
        currentPage: 1,
        pageSize: 10,
        username: "",
        learnNum: "",
        bookName: "",
        applyStatus: "",
        borrowStatus: "",
        returnStatus: "",
        timeStatus: "",
      },
      tableHeight:0
    };
  },
  mounted() {
    this.$nextTick(() =>{
      this.tableHeight = window.innerHeight -250
    })
    this.getLookBorrowList();
  },
  methods: {
    searchBtn(){
      this.getLookBorrowList()
    },
    currentChange(){

    },
    sizeChange(){

    },
    async getLookBorrowList() {
      let res = await getLookBorrowListApi(this.lookParm);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.lookParm.total = res.data.total;
      }
    },
  },
};
</script>

<style lang="scss" scoped>

</style>
```



#### 第52讲 公告表设计

```js
create table sys_notice
(
   notice_id            int not null auto_increment comment '主键',
   notice_title         varchar(128) comment '标题',
   notice_content       text comment '内容',
   create_time          datetime comment '创建时间',
   primary key (notice_id)
);
```



#### 第53讲 公告接口开发

##### 1、新建实体类SysNotice

```js
package com.itmk.web.sys_notice.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.util.Date;

@Data
@TableName("sys_notice")
public class SysNotice {
    @TableId(type = IdType.AUTO)
    private Long noticeId;
    private String noticeTitle;
    private String noticeContent;
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date createTime;
}

```

**参数接收类**

```js
package com.itmk.web.sys_notice.entity;

import lombok.Data;

@Data
public class NoticeParm {
    private Long currentPage;
    private Long pageSize;
    private String noticeTitle;
}

```

##### 2、新建SysNoticeMapper

```js
package com.itmk.web.sys_notice.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_notice.entity.SysNotice;

public interface SysNoticeMapper extends BaseMapper<SysNotice> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_notice.mapper.SysNoticeMapper">

</mapper>
```

##### 3、新建SysNoticeService接口

```js
package com.itmk.web.sys_notice.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_notice.entity.NoticeParm;
import com.itmk.web.sys_notice.entity.SysNotice;

public interface SysNoticeService extends IService<SysNotice> {
    IPage<SysNotice> getList(NoticeParm parm);
}

```

**实现类**

```js
package com.itmk.web.sys_notice.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_notice.entity.NoticeParm;
import com.itmk.web.sys_notice.entity.SysNotice;
import com.itmk.web.sys_notice.mapper.SysNoticeMapper;
import com.itmk.web.sys_notice.service.SysNoticeService;
import org.apache.commons.lang.StringUtils;
import org.springframework.stereotype.Service;

@Service
public class SysNoticeServiceImpl extends ServiceImpl<SysNoticeMapper, SysNotice> implements SysNoticeService {
    @Override
    public IPage<SysNotice> getList(NoticeParm parm) {
        //构造分页对象
        Page<SysNotice> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        //构造查询条件
        QueryWrapper<SysNotice> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getNoticeTitle())){
            query.lambda().like(SysNotice::getNoticeTitle,parm.getNoticeTitle());
        }
        query.lambda().orderByDesc(SysNotice::getCreateTime);
        return this.baseMapper.selectPage(page,query);
    }
}

```

##### 4、新建控制器

```js
package com.itmk.web.sys_notice.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_notice.entity.NoticeParm;
import com.itmk.web.sys_notice.entity.SysNotice;
import com.itmk.web.sys_notice.service.SysNoticeService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/notice")
public class SysNoticeController {
    @Autowired
    private SysNoticeService sysNoticeService;

    //新增
    @PostMapping
    public ResultVo add(@RequestBody SysNotice sysNotice){
        sysNotice.setCreateTime(new Date());
        boolean save = sysNoticeService.save(sysNotice);
        if(save){
            return ResultUtils.success("新增成功");
        }
        return ResultUtils.error("新增失败!");
    }

    //编辑
    @PutMapping
    public ResultVo edit(@RequestBody SysNotice sysNotice){
        boolean save = sysNoticeService.updateById(sysNotice);
        if(save){
            return ResultUtils.success("编辑成功");
        }
        return ResultUtils.error("编辑失败!");
    }

    //删除
    @DeleteMapping("/{noticeId}")
    public ResultVo delete(@PathVariable("noticeId") Long noticeId){
        boolean save = sysNoticeService.removeById(noticeId);
        if(save){
            return ResultUtils.success("删除成功");
        }
        return ResultUtils.error("删除失败!");
    }

    //列表
    @GetMapping("/list")
    public ResultVo getList(NoticeParm parm){
        IPage<SysNotice> list = sysNoticeService.getList(parm);
        return ResultUtils.success("查询成功",list);
    }
}

```



#### 第54讲 公告列表页面制作对接

##### 1、配置路由

在router/index.js中添加如下

```js
{
    path: '/notice',
    component: Layout,
    alwaysShow: true,
    name: 'notice',
    meta: { title: '公告管理', icon: 'el-icon-s-help' },
    children: [
      {
        path: '/noticeList',
        name: 'noticeList',
        component: () => import('@/views/notice/noticeList'),
        meta: { title: '公告列表', icon: 'table' }
      }
    ]
  },
```

##### 2、views/notice下新建noticeList页面

##### 3、api下新建notice.js

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get("/api/notice/list",parm)
}
```

##### 4、noticeList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="noticeParm" label-width="80px" :inline="true" size="mini">
      <el-form-item label="公告标题">
        <el-input v-model="noticeParm.noticeTitle"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      size="small"
      :height="tableHeight"
      :data="tableData"
      border
      stripe
    >
      <el-table-column prop="noticeTitle" label="公告标题"></el-table-column>
      <el-table-column prop="noticeContent" label="公告内容"></el-table-column>
      <el-table-column prop="createTime" label="公告时间"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            @click="editBtn(scope.row)"
          ></el-button>
          <el-button
            type="danger"
            size="small"
            @click="deleteBtn(scope.row)"
          ></el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="noticeParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="noticeParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="noticeParm.total"
      background
    >
    </el-pagination>
  </el-main>
</template>

<script>
import { getListApi } from "@/api/notice";
export default {
  data() {
    return {
      tableHeight: 0,
      tableData: [],
      noticeParm: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    currentChange(val) {},
    sizeChange(val) {},
    deleteBtn(row) {},
    editBtn(row) {},
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
    //新增按钮
    addBtn() {},
    async getList() {
      let res = await getListApi(this.noticeParm);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.noticeParm.total = res.data.total;
      }
    },
  },
};
</script>

<style>
</style>
```



#### 第55讲 新增公告页面制作与对接

##### 1、api/notice添加如下方法

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get("/api/notice/list",parm)
}
//新增
export const addApi = async(parm) =>{
    return await http.post("/api/notice",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/notice",parm)
}
```



##### 2、noticeList.vue页面

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="noticeParm" label-width="80px" :inline="true" size="mini">
      <el-form-item label="公告标题">
        <el-input v-model="noticeParm.noticeTitle"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      size="small"
      :height="tableHeight"
      :data="tableData"
      border
      stripe
    >
      <el-table-column prop="noticeTitle" label="公告标题"></el-table-column>
      <el-table-column prop="noticeContent" label="公告内容"></el-table-column>
      <el-table-column prop="createTime" label="公告时间"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
          >编辑</el-button>
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
          >删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="noticeParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="noticeParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="noticeParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="noticeTitle" label="标题">
            <el-input v-model="addModel.noticeTitle"></el-input>
          </el-form-item>
          <el-form-item prop="noticeContent" label="内容">
            <el-input
              type="textarea"
              v-model="addModel.noticeContent"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, editApi } from "@/api/notice";
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi } from "@/api/notice";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        noticeTitle: [
          { required: true, message: "请输入标题", trigger: "blur" },
        ],
        noticeContent: [
          { required: true, message: "请输入内容", trigger: "blur" },
        ],
      },
      addModel: {
        editType: "", // 0：新增 1：编辑
        noticeId: "",
        noticeTitle: "",
        noticeContent: "",
      },
      //弹框属性
      dialog: {
        title: "",
        width: 650,
        height: 180,
        visible: false,
      },
      tableHeight: 0,
      tableData: [],
      noticeParm: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
    currentChange(val) {},
    sizeChange(val) {},
    deleteBtn(row) {},
    editBtn(row) {
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据设置到addModel里面
      this.$objCoppy(row, this.addModel);
      //设置type
      this.addModel.editType = "1";
      //弹框显示
      this.dialog.title = "编辑公告";
      this.dialog.visible = true;
    },
    //重置按钮
    resetBtn() {},
    //搜索按钮
    searchBtn() {},
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置type
      this.addModel.editType = "0";
      //弹框显示
      this.dialog.title = "新增公告";
      this.dialog.visible = true;
    },
    async getList() {
      let res = await getListApi(this.noticeParm);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.noticeParm.total = res.data.total;
      }
    },
  },
};
</script>

<style>
</style>
```



#### 第56讲 删除、搜索功能对接

##### 1、api/notice新建删除方法

```js
import http from '@/utils/http'
//列表
export const getListApi = async(parm) =>{
    return await http.get("/api/notice/list",parm)
}
//新增
export const addApi = async(parm) =>{
    return await http.post("/api/notice",parm)
}
//编辑
export const editApi = async(parm)=>{
    return await http.put("/api/notice",parm)
}
//删除
export const deleteApi = async(parm) =>{
    return await http.delete("/api/notice",parm)
}
```

##### 2、noticeList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="noticeParm" label-width="80px" :inline="true" size="mini">
      <el-form-item label="公告标题">
        <el-input v-model="noticeParm.noticeTitle"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" icon="el-icon-plus" @click="addBtn"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table
      size="small"
      :height="tableHeight"
      :data="tableData"
      border
      stripe
    >
      <el-table-column prop="noticeTitle" label="公告标题"></el-table-column>
      <el-table-column prop="noticeContent" label="公告内容"></el-table-column>
      <el-table-column prop="createTime" label="公告时间"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-delete"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="noticeParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="noticeParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="noticeParm.total"
      background
    >
    </el-pagination>
    <!-- 新增、编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :width="dialog.width"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
        >
          <el-form-item prop="noticeTitle" label="标题">
            <el-input v-model="addModel.noticeTitle"></el-input>
          </el-form-item>
          <el-form-item prop="noticeContent" label="内容">
            <el-input
              type="textarea"
              v-model="addModel.noticeContent"
            ></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { addApi, editApi, deleteApi } from "@/api/notice";
import SysDialog from "@/components/dialog/SysDialog.vue";
import { getListApi } from "@/api/notice";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      //表单验证规则
      rules: {
        noticeTitle: [
          { required: true, message: "请输入标题", trigger: "blur" },
        ],
        noticeContent: [
          { required: true, message: "请输入内容", trigger: "blur" },
        ],
      },
      addModel: {
        editType: "", // 0：新增 1：编辑
        noticeId: "",
        noticeTitle: "",
        noticeContent: "",
      },
      //弹框属性
      dialog: {
        title: "",
        width: 650,
        height: 180,
        visible: false,
      },
      tableHeight: 0,
      tableData: [],
      noticeParm: {
        currentPage: 1,
        pageSize: 10,
        noticeTitle: "",
        total: 0,
      },
    };
  },
  created() {
    this.getList();
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  methods: {
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.editType == "0") {
            res = await addApi(this.addModel);
          } else {
            res = await editApi(this.addModel);
          }
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.getList();
            this.dialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
    currentChange(val) {},
    sizeChange(val) {},
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let parm = {
          noticeId: row.noticeId,
        };
        let res = await deleteApi(parm);
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          this.getList();
        }
      }
    },
    editBtn(row) {
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据设置到addModel里面
      this.$objCoppy(row, this.addModel);
      //设置type
      this.addModel.editType = "1";
      //弹框显示
      this.dialog.title = "编辑公告";
      this.dialog.visible = true;
    },
    //重置按钮
    resetBtn() {
      this.noticeParm.noticeTitle = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //新增按钮
    addBtn() {
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置type
      this.addModel.editType = "0";
      //弹框显示
      this.dialog.title = "新增公告";
      this.dialog.visible = true;
    },
    async getList() {
      let res = await getListApi(this.noticeParm);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.noticeParm.total = res.data.total;
      }
    },
  },
};
</script>

<style>
</style>
```



#### 第57讲  菜单数据创建





#### 第58讲 用户分配角色功能开发

##### 1、新建UserRole实体类

```js
package com.itmk.web.sys_user_role.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

@Data
@TableName("sys_user_role")
public class UserRole {
    @TableId(type = IdType.AUTO)
    private Long userRoleId;
    private Long userId;
    private Long roleId;
}

```

##### 2、新建UserRoleMapper接口

```js
package com.itmk.web.sys_user_role.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_user_role.entity.UserRole;

public interface UserRoleMapper extends BaseMapper<UserRole> {
}

```

**映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_user_role.mapper.UserRoleMapper">

</mapper>
```

##### 3、新建UserRoleService接口

```js
package com.itmk.web.sys_user_role.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_user_role.entity.UserRole;

public interface UserRoleService extends IService<UserRole> {
}

```

**实现类**

```js
package com.itmk.web.sys_user_role.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_user_role.entity.UserRole;
import com.itmk.web.sys_user_role.mapper.UserRoleMapper;
import com.itmk.web.sys_user_role.service.UserRoleService;
import org.springframework.stereotype.Service;

@Service
public class UserRoleServiceImpl extends ServiceImpl<UserRoleMapper, UserRole> implements UserRoleService {
}

```

##### 4、SysUserService添加如下addUser和editUser两个方法

```js
package com.itmk.web.sys_user.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;

public interface SysUserService extends IService<SysUser> {
    IPage<SysUser> list(PageParm parm);
    void addUser(SysUser user);
    void editUser(SysUser user);
}

```

**实现类**

```js
package com.itmk.web.sys_user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.mapper.SysUserMapper;
import com.itmk.web.sys_user.service.SysUserService;
import com.itmk.web.sys_user_role.entity.UserRole;
import com.itmk.web.sys_user_role.service.UserRoleService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {
    @Autowired
    private UserRoleService userRoleService;

    @Override
    public IPage<SysUser> list(PageParm parm) {
        //构造分页对象
        IPage<SysUser> page = new Page<>();
        page.setSize(parm.getPageSize());
        page.setCurrent(parm.getCurrentPage());
        //构造查询条件
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        if(StringUtils.isNotEmpty(parm.getNickName())){
             query.lambda().like(SysUser::getNickName,parm.getNickName());
        }
        if(StringUtils.isNotEmpty(parm.getPhone())){
             query.lambda().like(SysUser::getPhone,parm.getPhone());
        }
        return this.baseMapper.selectPage(page,query);
    }

    @Override
    @Transactional
    public void addUser(SysUser user) {
        //新增用户
        int insert = this.baseMapper.insert(user);
        //分配角色
        if(insert > 0){
            UserRole userRole = new UserRole();
            userRole.setRoleId(user.getRoleId());
            userRole.setUserId(user.getUserId());
            userRoleService.save(userRole);
        }
    }

    @Override
    @Transactional
    public void editUser(SysUser user) {
        int i = this.baseMapper.updateById(user);
        if(i > 0){
            //先删除，再插入
            QueryWrapper<UserRole> query = new QueryWrapper<>();
            query.lambda().eq(UserRole::getUserId,user.getUserId());
            userRoleService.remove(query);
            UserRole userRole = new UserRole();
            userRole.setUserId(user.getUserId());
            userRole.setRoleId(user.getRoleId());
            userRoleService.save(userRole);
        }
    }
}

```

##### 5、SysUserController控制器

```js
package com.itmk.web.sys_user.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_user.entity.PageParm;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import com.itmk.web.sys_user_role.entity.UserRole;
import com.itmk.web.sys_user_role.service.UserRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

@RestController
@RequestMapping("/api/user")
public class SysUserController {
    @Autowired
    private SysUserService sysUserService;
    @Autowired
    private UserRoleService userRoleService;

    //新增用户
    @PostMapping
    public ResultVo addUser(@RequestBody SysUser user){
        //判断账户是否被占用
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,user.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null){
            return ResultUtils.error("账户被占用!");
        }
        //密码加密
        user.setPassword(DigestUtils.md5DigestAsHex(user.getPassword().getBytes()));
        //设置是否是管理员
        user.setIsAdmin("0");
        user.setCreateTime(new Date());
        //入库
        sysUserService.addUser(user);
        return ResultUtils.success("新增用户成功!");
    }

    //编辑用户
    @PutMapping
    public ResultVo editUser(@RequestBody SysUser user){
        //判断账户是否被占用
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,user.getUsername());
        SysUser one = sysUserService.getOne(query);
        if(one != null && one.getUserId() != user.getUserId()){
            return ResultUtils.error("账户被占用!");
        }
        //密码加密
        user.setPassword(DigestUtils.md5DigestAsHex(user.getPassword().getBytes()));
        user.setUpdateTime(new Date());
        //更新
        sysUserService.editUser(user);
        return ResultUtils.success("编辑用户成功!");
    }

    //删除
    @DeleteMapping("/{userId}")
    public ResultVo delete(@PathVariable("userId") Long userId){
        boolean remove = sysUserService.removeById(userId);
        if(remove){
            return ResultUtils.success("删除用户成功!");
        }
        return ResultUtils.error("删除用户失败!");
    }

    //列表查询
    @GetMapping("/list")
    public ResultVo getList(PageParm parm){
        IPage<SysUser> list = sysUserService.list(parm);
        //密码处理
        list.getRecords().stream().forEach(item ->{
            item.setPassword("");
        });
        return ResultUtils.success("查询成功",list);
    }

    //根据用户id查询角色id
    @GetMapping("/getRoleId")
    public ResultVo getRoleId(String userId){
        QueryWrapper<UserRole> query = new QueryWrapper<>();
        query.lambda().eq(UserRole::getUserId,userId);
        UserRole one = userRoleService.getOne(query);
        return ResultUtils.success("查询成功",one);
    }
}

```

##### 6、api/user.js添加getRoleIdApi方法

```js
//获取角色id
export const getRoleIdApi = async(parm) =>{
  return await http.get("/api/user/getRoleId",parm)
}
```

##### 7、sysUserList.vue页面

```js
<template>
  <!-- element的标签，只需要当做一个普通的div看待就可以 -->
  <el-main>
    <!-- 搜索栏
     model :绑定表单的数据，通常是一个对象
     ref ： 相当于div的id
     rules ：表单验证的规则
     label-width ： 表单域标签的宽度
     inline ： 是否在同一行显示
     size ：尺寸
      -->
    <el-form
      :model="listParm"
      ref="searchRef"
      label-width="80px"
      :inline="true"
      size="small"
      :rules="rules"
    >
      <el-form-item>
        <el-input
          v-model="listParm.nickName"
          placeholder="请输入姓名"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-input v-model="listParm.phone" placeholder="请输入电话"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button icon="el-icon-search" @click="searchBtn">搜索</el-button>
        <el-button icon="el-icon-close" @click="resetBtn" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格
     data： 表格的数据
      -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="nickName" label="姓名"></el-table-column>
      <el-table-column prop="phone" label="电话"></el-table-column>
      <el-table-column prop="email" label="邮箱"></el-table-column>
      <el-table-column label="操作" align="center" width="180">
        <template slot-scope="scope">
          <el-button
            type="primary"
            icon="el-icon-edit"
            size="small"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            icon="el-icon-edit"
            size="small"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增或编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :width="dialog.width"
      :height="dialog.height"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <!-- el-form : 当做一个普通的form标签
        model ：表单绑定的数据对象
        ref ： 相当于div的id , 唯一的
        rules ： 表单验证规则
        label-width ： 表单域标签的宽度
        inline ： 是否在同一行展示
        size ：尺寸
         -->
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          :inline="false"
          size="small"
          style="margin-right: 40px"
        >
          <!-- el-row  : 代表一行，分为24等分
              el-col ： 代表列
         -->
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="nickName" label="姓名">
                <el-input v-model="addModel.nickName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="邮箱">
                <el-input v-model="addModel.email"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="sex" label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="账户">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col v-if="addModel.type == '0'" :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="角色">
                <el-select v-model="addModel.roleId" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.roleId"
                    :label="item.roleName"
                    :value="item.roleId"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import { getListForUserApi } from "@/api/role";
import { addUserApi, editUserApi, getListApi, deleteUserApi,getRoleIdApi } from "@/api/user";
//引入弹框组件
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  //注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      options: [],
      //表单验证规则
      rules: {
        nickName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写姓名",
          },
        ],
        phone: [
          {
            trigger: "blur",
            required: true,
            message: "请填写电话",
          },
        ],
        sex: [
          {
            trigger: "blur",
            required: true,
            message: "请选择性别",
          },
        ],
        username: [
          {
            trigger: "blur",
            required: true,
            message: "请填写账户",
          },
        ],
        password: [
          {
            trigger: "blur",
            required: true,
            message: "请填写密码",
          },
        ],
      },
      //表单绑定的数据
      addModel: {
        roleId:'',
        type: "", // 0:新增 1：编辑
        userId: "",
        nickName: "",
        phone: "",
        email: "",
        sex: "",
        username: "",
        password: "",
      },
      //弹框属性
      dialog: {
        title: "",
        visible: false,
        width: 630,
        height: 220,
      },
      //表格的高度
      tableHeight: 0,
      //列表查询的参数
      listParm: {
        nickName: "",
        phone: "",
        currentPage: 1,
        pageSize: 10,
        total: 0,
      },
      //表格的数据
      tableData: [],
    };
  },
  created() {
    this.getList();
    this.getRoleList();
  },
  methods: {
    async getRoleList(){
      let res = await getListForUserApi();
      console.log(res)
      this.options = res.data;
    },
    //重置按钮
    resetBtn() {
      this.listParm.nickName = "";
      this.listParm.phone = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      console.log("返回成功");
      console.log(res);
      if (res && res.code == 200) {
        this.tableData = res.data.records;
        this.total = res.data.total;
      }
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = null;
          if (this.addModel.type == "0") {
            res = await addUserApi(this.addModel);
          } else {
            res = await editUserApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
            //关闭弹框
            this.dialog.visible = false;
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      let confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteUserApi({ userId: row.userId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.title = "编辑用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);

      //把要编辑的数据复制到表单绑定的数据域
      this.$objCoppy(row, this.addModel);
      //设置编辑
      this.addModel.type = "1";
      this.getRoleId(row.userId)
    },
    async getRoleId(userId){
      let res = await getRoleIdApi({userId:userId})
      if(res && res.code == 200){
        this.addModel.roleId = res.data.roleId;
      }
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.title = "新增用户";
      this.dialog.visible = true;
      //清空表单
      this.$resetForm("addRef", this.addModel);
      //设置为新增
      this.addModel.type = "0";
    },
  },
  mounted() {
    this.$nextTick(() => {
      //计算表格高度
      this.tableHeight = window.innerHeight - 220;
    });
  },
};
</script>

<style lang="scss" scoped>
</style>
```



#### 第59讲 角色分配权限回显接口开发

##### 1、SysMenuMapper接口添加如下方法

```js
package com.itmk.web.sys_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.itmk.web.sys_menu.entity.SysMenu;
import org.apache.ibatis.annotations.Param;

import java.util.List;

public interface SysMenuMapper extends BaseMapper<SysMenu> {
    //根据用户id查询权限
    List<SysMenu> getMenuByUserId(@Param("userId") Long userId);
    //根据角色id查询权限
    List<SysMenu> getMenuByRoleId(@Param("roleId") Long roleId);
}

```

**SysMenuMapper.xml映射文件**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_menu.mapper.SysMenuMapper">
    <select id="getMenuByUserId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from  sys_user_role as ur
        left join sys_role  as r on ur.role_id = r.role_id
        left join sys_role_menu as rm on r.role_id = rm.role_id
        left join sys_menu  as m on rm.menu_id = m.menu_id
        where ur.user_id =#{userId}
        order by m.order_num asc
    </select>
    <select id="getMenuByRoleId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from sys_role_menu as rm , sys_menu as m
        where rm.menu_id = m.menu_id  and rm.role_id =#{roleId}
    </select>
</mapper>
```

##### 2、SysMenuService接口添加如下方法

```js
	//根据用户id查询权限
    List<SysMenu> getMenuByUserId(Long userId);
    //根据角色id查询权限
    List<SysMenu> getMenuByRoleId(Long roleId);
```

**实现类SysMenuServiceImpl**

```js
	@Override
    public List<SysMenu> getMenuByUserId(Long userId) {
        return this.baseMapper.getMenuByUserId(userId);
    }

    @Override
    public List<SysMenu> getMenuByRoleId(Long roleId) {
        return this.baseMapper.getMenuByRoleId(roleId);
    }
```

##### 3、新建实体类

```js
package com.itmk.web.sys_role.entiy;

import com.itmk.web.sys_menu.entity.SysMenu;
import lombok.Data;

import java.util.ArrayList;
import java.util.List;

@Data
public class AssignVo {
    //当前用户拥有的菜单
    private List<SysMenu> menuList = new ArrayList<>();
    //被分配的角色拥有的菜单id
    private Object[] checkList;
}

```

```js
package com.itmk.web.sys_role.entiy;

import lombok.Data;

@Data
public class AssignParm {
    private Long userId;
    private Long roleId;
}

```

##### 4、SysRoleService接口添加如下方法

```js
	//角色权限的回显
    AssignVo getAssignShow(AssignParm parm);
```

**实现类**

```js
@Override
    public AssignVo getAssignShow(AssignParm parm) {
        //查询当前用户的信息
        SysUser user = sysUserService.getById(parm.getUserId());
        //菜单数据
        List<SysMenu> list = null;
        if(user.getIsAdmin().equals("1")){ //如果是超级管理员，拥有所有的权限
            QueryWrapper<SysMenu> query = new QueryWrapper<>();
            query.lambda().orderByAsc(SysMenu::getOrderNum);
            list = sysMenuService.list(query);
        }else{
            list = sysMenuService.getMenuByUserId(user.getUserId());
        }
        //组装树
        List<SysMenu> menuList = MakeTree.makeMenuTree(list, 0L);
        //查询角色原来的菜单
        List<SysMenu> roleList = sysMenuService.getMenuByRoleId(parm.getRoleId());
        List<Long> ids = new ArrayList<>();
        Optional.ofNullable(roleList).orElse(new ArrayList<>()).stream().filter(item -> item != null).forEach(item ->{
            ids.add(item.getMenuId());
        });
        //组装数据
        AssignVo vo = new AssignVo();
        vo.setMenuList(menuList);
        vo.setCheckList(ids.toArray());
        return vo;
    }
```

##### 5、SysRoleController控制器添加如下方法

```js
//查询角色权限树的回显
    @GetMapping("/getAssingShow")
    public ResultVo getAssingShow(AssignParm parm){
        AssignVo show = sysRoleService.getAssignShow(parm);
        return ResultUtils.success("查询成功",show);
    }
```





#### 第60讲 权限回显数据对接

##### 1、权限树弹框

```js
<!-- 分配权限弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :width="assignDialog.width"
      :height="assignDialog.height"
      :visible="assignDialog.visible"
      @onClose="assignClose"
      @onConfirm="assignConfirm"
    >
      <template slot="content">
        <el-tree
          ref="assignTree"
          :data="assignTreeData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="true"
          default-expand-all
          :default-checked-keys="assignTreeChecked"
        ></el-tree>
      </template>
    </sys-dialog>
```





#### 第61讲 角色分配权限保存

##### 1、新建试实体类

```js
package com.itmk.web.sys_role_menu.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

@Data
@TableName("sys_role_menu")
public class RoleMenu {
    @TableId(type = IdType.AUTO)
    private Long roleMenuId;
    private Long roleId;
    private Long menuId;
}

```

##### 2、新建RoleMenuMapper接口

```js
package com.itmk.web.sys_role_menu.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_role_menu.entity.RoleMenu;
import org.apache.ibatis.annotations.Param;

import java.util.List;

public interface RoleMenuMapper extends BaseMapper<RoleMenu> {
    //保存角色的权限
    void assignSave(@Param("roleId") Long roleId, @Param("menuList")List<Long> menuList);
}

```

**映射文件** RoleMenuMapper.xml

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_role_menu.mapper.RoleMenuMapper">
    <insert id="assignSave">
        insert into sys_role_menu(role_id,menu_id) values
        <foreach collection="menuList" item="item" index="index" separator=",">
            (#{roleId},#{item})
        </foreach>
    </insert>
</mapper>
```

##### 3、新建RoleMenuService接口

```js
package com.itmk.web.sys_role_menu.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.itmk.web.sys_role_menu.entity.RoleMenu;

import java.util.List;

public interface RoleMenuService extends IService<RoleMenu> {
    //保存角色的权限
    void assignSave(Long roleId,List<Long> menuList);
}

```

**实现类**

```js
package com.itmk.web.sys_role_menu.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.itmk.web.sys_role_menu.entity.RoleMenu;
import com.itmk.web.sys_role_menu.mapper.RoleMenuMapper;
import com.itmk.web.sys_role_menu.service.RoleMenuService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
@Service
public class RoleMenuServiceImpl extends ServiceImpl<RoleMenuMapper, RoleMenu> implements RoleMenuService {
    @Override
    @Transactional
    public void assignSave(Long roleId, List<Long> menuList) {
        //1、删除角色原来的菜单
        QueryWrapper<RoleMenu> query = new QueryWrapper<>();
        query.lambda().eq(RoleMenu::getRoleId,roleId);
        this.baseMapper.delete(query);
        //2、插入新的菜单
        this.baseMapper.assignSave(roleId,menuList);
    }
}

```

##### 4、SysRoleController控制器添加如下方法

```js
	//角色分配权限保存
    @PostMapping("/assignSave")
    public ResultVo assignSave(@RequestBody SaveAssign parm){
        roleMenuService.assignSave(parm.getRoleId(),parm.getList());
        return ResultUtils.success("分配成功!");
    }
```

##### 5、sysRoleList.vue页面完整源码

```js
<template>
  <el-main>
    <!-- 搜索栏 -->
    <el-form :model="listParm" label-width="80px" :inline="true" size="small">
      <el-form-item>
        <el-input
          placeholder="请输入角色名称"
          v-model="listParm.roleName"
        ></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="searchBtn" icon="el-icon-search">搜索</el-button>
        <el-button @click="resetBtn" icon="el-icon-close" style="color: #ff7670"
          >重置</el-button
        >
        <el-button type="primary" @click="addBtn" icon="el-icon-plus"
          >新增</el-button
        >
      </el-form-item>
    </el-form>
    <!-- 表格 -->
    <el-table :height="tableHeight" :data="tableData" border stripe>
      <el-table-column prop="roleName" label="角色名称"></el-table-column>
      <el-table-column prop="roleType" label="角色类型">
        <template slot-scope="scope">
          <el-tag v-if="scope.row.roleType == '1'">系统角色</el-tag>
          <el-tag v-if="scope.row.roleType == '2'" type="success"
            >读者角色</el-tag
          >
        </template>
      </el-table-column>
      <el-table-column prop="remark" label="角色备注"></el-table-column>
      <el-table-column label="操作" align="center" width="300">
        <template slot-scope="scope">
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="editBtn(scope.row)"
            >编辑</el-button
          >
          <el-button
            type="danger"
            size="small"
            icon="el-icon-delete"
            @click="deleteBtn(scope.row)"
            >删除</el-button
          >
          <el-button
            type="primary"
            size="small"
            icon="el-icon-edit"
            @click="assignBtn(scope.row)"
            >分配权限</el-button
          >
        </template>
      </el-table-column>
    </el-table>
    <!-- 分页 -->
    <el-pagination
      @size-change="sizeChange"
      @current-change="currentChange"
      :current-page.sync="listParm.currentPage"
      :page-sizes="[10, 20, 40, 80, 100]"
      :page-size="listParm.pageSize"
      layout="total, sizes, prev, pager, next, jumper"
      :total="listParm.total"
      background
    >
    </el-pagination>
    <!-- 新增编辑弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :visible="dialog.visible"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="rules"
          label-width="80px"
          size="small"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="roleName" label="角色名称">
                <el-input v-model="addModel.roleName"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色类型">
                <el-select v-model="addModel.roleType" placeholder="请选择">
                  <el-option
                    v-for="item in options"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item label="角色备注">
                <el-input v-model="addModel.remark"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
    <!-- 分配权限的弹框 -->
    <sys-dialog
      :title="assignDialog.title"
      :visible="assignDialog.visible"
      :width="assignDialog.width"
      :height="assignDialog.height"
      @onConfirm="assignConfirm"
      @onClose="assignClose"
    >
      <div slot="content">
        <el-tree
          ref="assignTree"
          :data="assignTreeData"
          node-key="menuId"
          :props="defaultProps"
          empty-text="暂无数据"
          :show-checkbox="true"
          default-expand-all
          :default-checked-keys="assignTreeChecked"
        ></el-tree>
      </div>
    </sys-dialog>
  </el-main>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import {
  getListApi,
  addRoleApi,
  editRoleApi,
  deleteRoleApi,
  getAssingShowApi,
  saveAssignApi,
} from "@/api/role";
export default {
  // 注册组件
  components: {
    SysDialog,
  },
  data() {
    return {
      defaultProps: {
        children: "children",
        label: "title",
      },
      options: [
        {
          value: "1",
          label: "系统用户",
        },
        {
          value: "2",
          label: "读者",
        },
      ],
      //表单验证
      rules: {
        roleName: [
          {
            trigger: "blur",
            required: true,
            message: "请填写角色名称",
          },
        ],
      },
      //表单数据
      addModel: {
        type: "", // 0：新增 1：编辑
        roleId: "",
        roleName: "",
        remark: "",
        roleType: "",
      },
      //弹框属性
      dialog: {
        title: "",
        height: 150,
        visible: false,
      },
      //表格高度
      tableHeight: 0,
      //列表查询参数
      listParm: {
        pageSize: 10,
        currentPage: 1,
        roleName: "",
        total: 0,
      },
      tableData: [],
      //角色Id
      roleId: "",
      //树数据
      assignTreeData: [],
      //角色原来的权限
      assignTreeChecked: [],
      assignDialog: {
        title: "",
        visible: false,
        width: 300,
        height: 450,
      },
    };
  },
  mounted() {
    this.$nextTick(() => {
      this.tableHeight = window.innerHeight - 220;
    });
  },
  created() {
    this.getList();
  },
  methods: {
    assignClose() {
      this.assignDialog.visible = false;
    },
    async assignConfirm() {
      //获取树选中的数据
      let ids = this.$refs.assignTree
        .getCheckedKeys()
        .concat(this.$refs.assignTree.getHalfCheckedKeys());
      console.log(ids);
      let parm = {
        roleId: this.roleId,
        list: ids,
      };
      let res = await saveAssignApi(parm);
      if (res && res.code == 200) {
         this.$message({ type: "success", message: res.msg });
        this.assignDialog.visible = false;
      }
    },
    async assignBtn(row) {
      //清空数据
      this.roleId = "";
      this.assignTreeData = [];
      this.assignTreeChecked = [];
      this.roleId = row.roleId;
      //设置弹框属性
      this.assignDialog.title = "为【" + row.roleName + "】分配权限";
      this.assignDialog.visible = true;
      //获取权限数据
      let parm = {
        userId: "3",
        roleId: this.roleId,
      };
      let res = await getAssingShowApi(parm);
      console.log(res);
      if (res && res.code == 200) {
        this.assignTreeData = res.data.menuList;
        this.assignTreeChecked = res.data.checkList;
      }
      //如果角色原来有权限
      if (this.assignTreeChecked.length > 0) {
        let newArr = [];
        this.assignTreeChecked.forEach((item) => {
          this.checked(item, this.assignTreeData, newArr);
        });
        this.assignTreeChecked = newArr;
      }
    },
    //找出所有的回显数据
    checked(id, data, newArr) {
      data.forEach((item) => {
        if (item.menuId == id) {
          
          //是不是末级
          if (item.children && item.children.length == 0) {
            newArr.push(item.menuId);
          }
        } else {
          if (item.children && item.children.length != 0) {
            this.checked(id, item.children, newArr);
          }
        }
      });
    },
    //弹框确定
    onConfirm() {
      //表单验证
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          this.dialog.visible = false;
          let res = null;
          if (this.addModel.type == "0") {
            res = await addRoleApi(this.addModel);
          } else {
            res = await editRoleApi(this.addModel);
          }
          if (res && res.code == 200) {
            //信息提示
            this.$message({ type: "success", message: res.msg });
            //刷新表格
            this.getList();
          }
        }
      });
    },
    //弹框关闭
    onClose() {
      this.dialog.visible = false;
    },
    //获取列表
    async getList() {
      let res = await getListApi(this.listParm);
      if (res && res.code == 200) {
        console.log(res);
        //设置表格数据
        this.tableData = res.data.records;
        this.listParm.total = res.data.total;
      }
    },
    //页数改变时触发
    currentChange(val) {
      this.listParm.currentPage = val;
      this.getList();
    },
    //页容量改变时触发
    sizeChange(val) {
      this.listParm.pageSize = val;
      this.getList();
    },
    //删除按钮
    async deleteBtn(row) {
      //确定
      const confirm = await this.$myconfirm("确定删除该数据吗?");
      if (confirm) {
        let res = await deleteRoleApi({ roleId: row.roleId });
        if (res && res.code == 200) {
          //信息提示
          this.$message({ type: "success", message: res.msg });
          //刷新表格
          this.getList();
        }
      }
    },
    //编辑按钮
    editBtn(row) {
      //设置弹框属性
      this.dialog.visible = true;
      this.dialog.title = "新增角色";
      //清空表单数据
      this.$resetForm("addRef", this.addModel);
      //把要编辑的数据放到表单数据对象
      this.$objCoppy(row, this.addModel);
      this.addModel.type = "1"; //编辑
    },
    //新增按钮
    addBtn() {
      //设置弹框属性
      this.dialog.visible = true;
      this.dialog.title = "新增角色";
      //清空表单数据
      this.$resetForm("addRef", this.addModel);
      //
      this.addModel.type = "0";
    },
    //重置按钮
    resetBtn() {
      this.listParm.roleName = "";
      this.getList();
    },
    //搜索按钮
    searchBtn() {
      this.getList();
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
```





#### 第62讲 vue-admin-template登录和权限验证流程讲解

##### 1、登录流程图





![](D:\Files\Simple\vue+springboot资料\资料\images\登录流程图.png)





##### 2、权限验证流程图



![](D:\Files\Simple\vue+springboot资料\资料\images\权限验证流程图.png)







#### 第63讲  读者角色设置

##### 1、sql

```js
create table sys_reader_role
(
   reader_role_id       int not null auto_increment comment '主键',
   reader_id            int comment '读者id',
   role_id              int comment '角色id',
   primary key (reader_role_id)
);

```





#### 第64讲 用户登录对接

##### 1、定义登录接收参数类

```js
package com.itmk.web.sys_login.entity;


import lombok.Data;

import java.io.Serializable;

@Data
public class LoginParm implements Serializable {
    private String username;
    private String password;
    private String userType;
}
```

##### 2、定义返回值类型

```js
package com.itmk.web.sys_login.entity;

import lombok.Data;

@Data
public class LoginResult {
    private Long userId;
    private String token;
    //token过期时间
    private Long expireTime;
}

```



##### 3、新建登录控制器

```js
package com.itmk.web.sys_login.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.itmk.utils.ResultUtils;
import com.itmk.utils.ResultVo;
import com.itmk.web.sys_login.entity.LoginParm;
import com.itmk.web.sys_login.entity.LoginResult;
import com.itmk.web.sys_reader.entity.SysReader;
import com.itmk.web.sys_reader.service.SysReaderService;
import com.itmk.web.sys_user.entity.SysUser;
import com.itmk.web.sys_user.service.SysUserService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api/system")
public class LoginController {
    @Autowired
    private SysReaderService sysReaderService;
    @Autowired
    private SysUserService sysUserService;

    //登录
    @PostMapping("/login")
    public ResultVo login(@RequestBody LoginParm parm) {
        if (StringUtils.isEmpty(parm.getUsername()) || StringUtils.isEmpty(parm.getPassword()) || StringUtils.isEmpty(parm.getUserType())) {
            return ResultUtils.error("用户名、密码或用户类型不能为空!");
        }
        if (parm.getUserType().equals("0")) { //0 ：读者
            QueryWrapper<SysReader> query = new QueryWrapper<>();
            query.lambda().eq(SysReader::getUsername, parm.getUsername())
                    .eq(SysReader::getPassword, DigestUtils.md5DigestAsHex(parm.getPassword().getBytes()));
            SysReader one = sysReaderService.getOne(query);
            if(one == null){
                return ResultUtils.error("用户名或密码错误!");
            }
            LoginResult result = new LoginResult();
            result.setUserId(one.getReaderId());
            result.setToken(String.valueOf(one.getReaderId()));
            return ResultUtils.success("登录成功", result);
        } else if (parm.getUserType().equals("1")) { // 1: 系统用户
            QueryWrapper<SysUser> query = new QueryWrapper<>();
            query.lambda().eq(SysUser::getUsername, parm.getUsername())
                    .eq(SysUser::getPassword, DigestUtils.md5DigestAsHex(parm.getPassword().getBytes()));
            SysUser one = sysUserService.getOne(query);
            if(one == null){
                return ResultUtils.error("用户名或密码错误!");
            }
            LoginResult result = new LoginResult();
            result.setUserId(one.getUserId());
            result.setToken(String.valueOf(one.getUserId()));
            return ResultUtils.success("登录成功", result);
        } else {
            return ResultUtils.error("用户类型不存在!");
        }
    }

}

```

##### 4、api/user.js注释原来的login方法，改为如下所示

```js
//用户登录
export const loginApi = async(parm) =>{
  return await http.post("/api/system/login",parm)
}
```

##### 5、修改登录页面如下

```js
<template>
  <div class="logincontainer">
    <el-form
      class="loginForm"
      :model="loginForm"
      ref="loginForm"
      :rules="rules"
      label-width="80px"
      :inline="false"
      size="normal"
    >
      <el-form-item>
        <span class="loginTitle">高校图书管理系统</span>
      </el-form-item>
      <el-form-item prop="username">
        <el-input
          v-model="loginForm.username"
          placeholder="请输入用户名"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password">
        <el-input
          type="password"
          v-model="loginForm.password"
          placeholder="请输入密码"
        ></el-input>
      </el-form-item>
      <el-form-item prop="userType">
        <el-radio-group v-model="loginForm.userType">
          <el-radio :label="0">读者</el-radio>
          <el-radio :label="1">管理员</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item>
        <el-row :gutter="20">
          <el-col :span="12" :offset="0">
            <el-button type="primary" class="mybtn" @click="onSubmit"
              >登录</el-button
            >
          </el-col>
          <el-col :span="12" :offset="0">
            <el-button class="mybtn">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
  </div>
</template>

<script>
export default {
  data() {
    return {
      //登录表单绑定数据源
      loginForm: {
        username: "",
        password: "",
        userType: "", //0：读者  1： 管理员
      },
      //表单验证规则
      rules: {
        username: [
          {
            trigger: "change",
            required: true,
            message: "请输入用户名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请输入密码",
          },
        ],
        userType: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户类型",
          },
        ],
      },
    };
  },
  methods: {
    //登录提交事件
    onSubmit() {
      //表单验证
      this.$refs.loginForm.validate((valid) => {
        //验证通过才提交表单
        if (valid) {
          this.loading = true;
          //调用store里面的login方法
          this.$store
            .dispatch("user/login", this.loginForm)
            .then(() => {
              //跳转路由
              this.$router.push({ path: this.redirect || "/" });
              this.loading = false;
            })
            .catch(() => {
              this.loading = false;
            });
        }
      });
    },
  },
};
</script>

<style  scoped>
.logincontainer {
  height: 100%;
  background: #fff;
  background-image: url("../../assets/images/login_bg.png");
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: 100% 100%;
}
.loginForm {
  height: 350px;
  width: 480px;
  background: #fff;
  padding: 35px 20px;
  border-radius: 10px;
}
.loginTitle {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  font-weight: 600;
  color: #409eff;
}
.logincontainer ::v-deep .el-form-item__content {
  margin-left: 0px !important;
}
.mybtn {
  width: 100%;
}
</style>

```



#### 第65讲 用户信息接口开发与对接

##### 1、登录添加token生成

**依赖**

```js
 <!-- jwt-->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>0.9.0</version>
        </dependency>
```

**配置文件**

```js
#jwt配置
jwt:
  secret: com.itmk
  #30分钟过期
  expiration: 1800000

```

**工具类**

```js


import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
@Data
@ConfigurationProperties(prefix = "jwt")
@Component  //把该类交给spring进行管理
public class JwtUtils {
    //密钥
    private String secret;

    // 过期时间 毫秒
    private Long expiration;


    /**
     * 从数据声明生成令牌
     *
     * @param claims 数据声明
     * @return 令牌
     */
    private String generateToken(Map<String, Object> claims) {
        Date expirationDate = new Date(System.currentTimeMillis() + expiration);
        return Jwts.builder().setClaims(claims).setExpiration(expirationDate).signWith(SignatureAlgorithm.HS512, secret).compact();
    }

    /**
     * 从令牌中获取数据声明
     *
     * @param token 令牌
     * @return 数据声明
     */
    public Claims getClaimsFromToken(String token) {
        Claims claims;
        try {
            claims = Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();
        } catch (Exception e) {
            claims = null;
        }
        return claims;
    }

    /**
     * 生成令牌
     *
     * @param username 用户
     * @return 令牌
     */
    public String generateToken(String username,String userType) {
        Map<String, Object> claims = new HashMap<>(2);
        claims.put(Claims.SUBJECT,username);
        claims.put(Claims.ISSUED_AT, new Date());
        claims.put("userType",userType);
        return generateToken(claims);
    }

    /**
     * 从令牌中获取用户名
     *
     * @param token 令牌
     * @return 用户名
     */
    public String getUsernameFromToken(String token) {
        String username;
        try {
            Claims claims = getClaimsFromToken(token);
            username = claims.getSubject();
        } catch (Exception e) {
            username = null;
        }
        return username;
    }

    /**
     * 判断令牌是否过期
     *
     * @param token 令牌
     * @return 是否过期
     */
    public Boolean isTokenExpired(String token) {
        Claims claims = getClaimsFromToken(token);
        Date expiration = claims.getExpiration();
        return expiration.before(new Date());
    }

    /**
     * 刷新令牌
     *
     * @param token 原令牌
     * @return 新令牌
     */
    public String refreshToken(String token) {
        String refreshedToken;
        try {
            Claims claims = getClaimsFromToken(token);
            claims.put(Claims.ISSUED_AT, new Date());
            refreshedToken = generateToken(claims);
        } catch (Exception e) {
            refreshedToken = null;
        }
        return refreshedToken;
    }

    /**
     * 验证令牌
     *
     * @param token       令牌
     * @param username 用户名
     * @return 是否有效
     */
    public Boolean validateToken(String token, String username) {
        String tokenUsername = getUsernameFromToken(token);
        return (username.equals(tokenUsername) && !isTokenExpired(token));
    }

    /**
     * 获取token过期时间
     * @param token
     * @param
     * @return
     */
    public Long getExpireTime(String token){
        Long expireTime =  Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody().getExpiration().getTime();
        return expireTime;
    }
}
```



##### 2、后端登录接口修改生成token的方法

```js
//返回数据给前端
LoginResult result = new LoginResult();
result.setToken(jwtUtils.generateToken(one.getUsername(), loginParm.getUserType()));
result.setUserId(one.getReaderId());
```



##### 3、前端修改auth.js里面setToken和getToken的方法如下

修改原因，token大小超出Cookies存储的大小

```js
export function getToken() {
  return sessionStorage.getItem(TokenKey,)
}

export function setToken(token) {
  return sessionStorage.setItem(TokenKey, token)
}
```



##### 4、定义用户信息返回值的实体类

根据前端mock里面user.js里面的users定义

```js
package com.itmk.web.sys_login.entity;

import lombok.Data;

/**
 * 返回前端的用户信息
 */
@Data
public class UserInfo {
    private String name;
    private String avatar;
    private String introduction;
    private Object[] roles;
}

```



##### 5、SysMenuMapper接口新建getReaderMenuByUserId方法如下

```js
//根据读者id查询权限
List<SysMenu> getReaderMenuByUserId(@Param("readerId") Long readerId);
```

**SysMenuMapper.xml映射文件**

```js
<select id="getReaderMenuByUserId" resultType="com.itmk.web.sys_menu.entity.SysMenu">
        select m.* from  sys_reader_role as ur
        left join sys_role  as r on ur.role_id = r.role_id
        left join sys_role_menu as rm on r.role_id = rm.role_id
        left join sys_menu  as m on rm.menu_id = m.menu_id
        where ur.reader_id =#{readerId}
        order by m.order_num asc
    </select>
```



##### 6、SysMenuService接口添加如下方法

```js
//根据读者id查询权限
 List<SysMenu> getReaderMenuByUserId(Long readerId);
```

**实现类**

```js
@Override
public List<SysMenu> getReaderMenuByUserId(Long readerId) {
    return this.baseMapper.getReaderMenuByUserId(readerId);
}
```



##### 7、LoginController控制器添加getInfo()方法

```js
//获取用户权限字段
    @GetMapping("/getInfo")
    public ResultVo getInfo(Long userId, HttpServletRequest request){
        //从请求的头部获取token
        String token = request.getHeader("token");
        //从token里面解析用户的类型
        Claims claims = jwtUtils.getClaimsFromToken(token);
        Object userType = claims.get("userType");
        //定义用户信息类
        UserInfo userInfo = new UserInfo();
        if(userType.equals("0")){ //读者
            //根据id查询读者信息
            SysReader reader = sysReaderService.getById(userId);
            userInfo.setIntroduction(reader.getLearnNum());
            userInfo.setName(reader.getLearnNum());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            //权限字段查询与设置
            List<SysMenu> menuList = sysMenuService.getReaderMenuByUserId(userId);
            List<String> collect = menuList.stream().filter(item -> item != null && item.getCode() != null).map(item -> item.getCode()).collect(Collectors.toList());
            if(collect.size() ==0){
                return ResultUtils.error("暂无登录权限，请联系管理员!");
            }
            //转成数组
            String[] strings = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(strings);
            return ResultUtils.success("查询成功",userInfo);
        }else if(userType.equals("1")){ //管理员
            SysUser user = sysUserService.getById(userId);
            userInfo.setIntroduction(user.getNickName());
            userInfo.setName(user.getNickName());
            userInfo.setAvatar("https://wpimg.wallstcn.com/f778738c-e4f8-4870-b634-56703b4acafe.gif");
            //权限字段查询与设置
            List<SysMenu> menuList = sysMenuService.getMenuByUserId(userId);
            List<String> collect = menuList.stream().filter(item -> item != null && item.getCode() != null).map(item -> item.getCode()).collect(Collectors.toList());
            if(collect.size() ==0){
                return ResultUtils.error("暂无登录权限，请联系管理员!");
            }
            //转成数组
            String[] strings = collect.toArray(new String[collect.size()]);
            userInfo.setRoles(strings);
            return ResultUtils.success("查询成功",userInfo);
        }else{
            return ResultUtils.success("用户类型不存在",userInfo);
        }
    }
```

##### 8、api/user.js修改getInfo()如下所示

```js
export const getInfo = async(parm) =>{
  return await http.get("/api/system/getInfo",parm)
}
```



##### 9、修改store/module/user.js的getInfo()如下

```js
//获取用户的权限信息和自己的信息
  getInfo({ commit, state }) {
    return new Promise((resolve, reject) => {
      getInfo({userId:getUserId()}).then(response => {
        console.log('33333333333')
        console.log(response)
        const { data } = response

        if (!data) {
          reject('Verification failed, please Login again.')
        }

        const { roles, name, avatar } = data

        // roles must be a non-empty array
        if (!roles || roles.length <= 0) {
          reject('getInfo: roles must be a non-null array!')
        }

        commit('SET_ROLES', roles)
        commit('SET_NAME', name)
        commit('SET_AVATAR', avatar)
        resolve(data)
      }).catch(error => {
        reject(error)
      })
    })
  },
```





#### 第66讲 动态菜单、动态路由对接

**注意事项：**

```js
1、菜单表里面的name、path需要有值，否则前端渲染菜单是会报错
2、注释permission.js里面的  Message.error(error || 'Has Error')
```



##### 1、定义路由实体类

```js

/**
 * 路由需要的数据格式
 */
@Data
@JsonInclude(JsonInclude.Include.NON_EMPTY)
public class RouterVO {

    private String path;

    private String component;

    private boolean alwaysShow;

    private String name;

    private Meta meta;

    @Data
    @AllArgsConstructor
    public class Meta {
        private String title;
        private String icon;
        private Object[] roles;
    }
    private List<RouterVO> children =new ArrayList<>();

}
```

##### 2、创建生成路由树的工具类

```js
 /**
     * 生成路由数据格式
     */
    public static List<RouterVO> makeRouter(List<SysMenu> menuList, Long pid){
        //接受生产的路由数据
        List<RouterVO> list = new ArrayList<>();
        //组装数据
        Optional.ofNullable(menuList).orElse(new ArrayList<>())
                .stream()
                .filter(item ->item != null && item.getParentId() == pid)
                .forEach(item ->{
                    RouterVO router = new RouterVO();
                    router.setName(item.getName());
                    router.setPath(item.getPath());
                    //判断是否是一级菜单
                    if(item.getParentId() == 0L){
                        router.setComponent("Layout");
                        router.setAlwaysShow(true);
                    }else{
                        router.setComponent(item.getUrl());
                        router.setAlwaysShow(false);
                    }
                    //设置meta
                    router.setMeta(router.new Meta(
                            item.getTitle(),
                            item.getIcon(),
                            item.getCode().split(",")
                    ));
                    //设置children
                    List<RouterVO> children = makeRouter(menuList, item.getMenuId());
                    router.setChildren(children);
                    if(router.getChildren().size() > 0){
                        router.setAlwaysShow(true);
                    }
                    list.add(router);
                });
        return list;
    }
```



##### 3、SysReaderService接口添加loadByUsername()方法

```js
SysReader loadByUsername(String username);
```

**实现类**

```js
@Override
    public SysReader loadByUsername(String username) {
        QueryWrapper<SysReader> query = new QueryWrapper<>();
        query.lambda().eq(SysReader::getUsername,username);
        return this.baseMapper.selectOne(query);
    }
```

##### 4、SysUserService接口添加loadByUsername()方法

```js
SysUser loadByUsername(String username);
```

**实现类**

```js
@Override
    public SysUser loadByUsername(String username) {
        QueryWrapper<SysUser> query = new QueryWrapper<>();
        query.lambda().eq(SysUser::getUsername,username);
        return this.baseMapper.selectOne(query);
    }
```

##### 5、LoginController控制器添加getMenuList()方法

```js
//获取菜单
    @GetMapping("/getMenuList")
    public ResultVo getMenuList(HttpServletRequest request){
        //获取token
        String token = request.getHeader("token");
        //获取用户名
        String username = jwtUtils.getUsernameFromToken(token);
        //获取用户类型
        Claims claims = jwtUtils.getClaimsFromToken(token);
        Object userType = claims.get("userType");
        if(userType.equals("0")){  //读者
            //获取用户信息
            SysReader reader = sysReaderService.loadByUsername(username);
            //获取权限信息
            List<SysMenu> menuList = sysMenuService.getReaderMenuByUserId(reader.getReaderId());
            List<SysMenu> collect = menuList.stream().filter(item -> item != null && !item.getType().equals("2")).collect(Collectors.toList());
            if(collect.size() == 0){
                return ResultUtils.error("暂无登录权限，请联系管理员!");
            }
            List<RouterVO> routerVOS = MakeTree.makeRouter(collect, 0L);
            return ResultUtils.success("查询成功",routerVOS);

        }else if(userType.equals("1")){  // 管理员
            //获取用户信息
            SysUser reader = sysUserService.loadByUsername(username);
            //获取权限信息
            List<SysMenu> menuList = sysMenuService.getMenuByUserId(reader.getUserId());
            List<SysMenu> collect = menuList.stream().filter(item -> item != null && !item.getType().equals("2")).collect(Collectors.toList());
            if(collect.size() == 0){
                return ResultUtils.error("暂无登录权限，请联系管理员!");
            }
            List<RouterVO> routerVOS = MakeTree.makeRouter(collect, 0L);
            return ResultUtils.success("查询成功",routerVOS);
        }else {
            return ResultUtils.error("用户类型不存在!");
        }
    }
```

##### 6、api/user.js添加getMenuListApi()方法

```js
//获取用户的菜单
export const getMenuListApi = async() =>{
  return await http.get("/api/system/getMenuList",null)
}
```

##### 7、修改store/modules/permission.js里面的generateRoutes()和 filterAsyncRoutes()方法如下

```js

export function filterAsyncRoutes(routes, roles) {
  const res = []
  routes.forEach(route => {
    const tmp = { ...route }
    if (hasPermission(roles, tmp)) {
      //动态找到页面路径
      const component = tmp.component;
      if (component) {
        //判断是否是一级菜单
        if (component == 'Layout') {
          tmp.component = Layout;
        } else {
          tmp.component = (resolve) => require([`@/views${component}`], resolve)
        }
      }
      if (tmp.children) {
        tmp.children = filterAsyncRoutes(tmp.children, roles)
      }
      res.push(tmp)
    }
  })

  return res
}
```

```js
generateRoutes({ commit }, roles) {
    return new Promise(resolve => {
      //accessedRoutes对接后端接口之后，返回的菜单数据
      getMenuListApi().then(res => {
        console.log('返回菜单数据')
        console.log(res)
        let accessedRoutes = filterAsyncRoutes(res.data, roles)
        commit('SET_ROUTES', accessedRoutes)
        resolve(accessedRoutes)
      })
    })
  }
```

8、添加404页面

```js
let obj =  { path: '*', redirect: '/404', hidden: true };
accessRoutes.push(obj)
```





#### 第67讲 读者注册功能开发

##### 1、SysReaderController控制器添加register()方法

```js
//读者注册
    @PostMapping("/register")
    public ResultVo register(@RequestBody SysReader reader) {
        //查询学号是否已经被占用
        QueryWrapper<SysReader> query = new QueryWrapper<>();
        query.lambda().eq(SysReader::getUsername, reader.getUsername());
        SysReader one = sysReaderService.getOne(query);
        if (one != null) {
            return ResultUtils.error("该学号被占用!");
        }
        reader.setPassword(DigestUtils.md5DigestAsHex(reader.getPassword().getBytes()));
        reader.setCheckStatus("0");
        reader.setUserStatus("1");
        sysReaderService.saveReader(reader);
        return ResultUtils.success("注册成功!");
    }
```

##### 2、api/reader添加registerApi()方法

```js
//注册读者
export const registerApi = async(parm) =>{
    return await http.post("/api/reader/register",parm)
}
```

##### 3、登录页面

```js
<template>
  <div class="logincontainer">
    <el-form
      class="loginForm"
      :model="loginForm"
      ref="loginForm"
      :rules="rules"
      label-width="80px"
      :inline="false"
      size="normal"
    >
      <el-form-item>
        <span class="loginTitle">高校图书管理系统</span>
      </el-form-item>
      <el-form-item prop="username">
        <el-input
          v-model="loginForm.username"
          placeholder="请输入用户名"
        ></el-input>
      </el-form-item>
      <el-form-item prop="password">
        <el-input
          type="password"
          v-model="loginForm.password"
          placeholder="请输入密码"
        ></el-input>
      </el-form-item>
      <el-form-item prop="userType">
        <el-radio-group v-model="loginForm.userType">
          <el-radio :label="0">读者</el-radio>
          <el-radio :label="1">管理员</el-radio>
        </el-radio-group>
        <span
          @click="registerBtn"
          style="
            margin-right: 10px;
            float: right;
            color: #ff7670;
            cursor: pointer;
          "
          >无账号,读者注册</span
        >
      </el-form-item>
      <el-form-item>
        <el-row :gutter="20">
          <el-col :span="12" :offset="0">
            <el-button type="primary" class="mybtn" @click="onSubmit"
              >登录</el-button
            >
          </el-col>
          <el-col :span="12" :offset="0">
            <el-button class="mybtn">取消</el-button>
          </el-col>
        </el-row>
      </el-form-item>
    </el-form>
    <!-- 注册弹框 -->
    <sys-dialog
      :title="dialog.title"
      :visible="dialog.visible"
      :height="dialog.height"
      :width="dialog.width"
      @onClose="onClose"
      @onConfirm="onConfirm"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addRef"
          :rules="registerRules"
          label-width="80px"
          size="small"
          style="margin-right: 30px"
        >
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="learnNum" label="姓名">
                <el-input v-model="addModel.learnNum"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="phone" label="电话">
                <el-input v-model="addModel.phone"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="username" label="学号">
                <el-input v-model="addModel.username"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="className" label="班级">
                <el-input v-model="addModel.className"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="idCard" label="身份证">
                <el-input v-model="addModel.idCard"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item prop="password" label="密码">
                <el-input v-model="addModel.password"></el-input>
              </el-form-item>
            </el-col>
          </el-row>
          <el-row>
            <el-col :span="12" :offset="0">
              <el-form-item prop="confirmPassword" label="确认密码">
                <el-input v-model="addModel.confirmPassword"></el-input>
              </el-form-item>
            </el-col>
            <el-col :span="12" :offset="0">
              <el-form-item label="性别">
                <el-radio-group v-model="addModel.sex">
                  <el-radio :label="'0'">男</el-radio>
                  <el-radio :label="'1'">女</el-radio>
                </el-radio-group>
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </div>
    </sys-dialog>
  </div>
</template>

<script>
import { registerApi } from "@/api/reader";
import SysDialog from "@/components/dialog/SysDialog.vue";
export default {
  components: {
    SysDialog,
  },
  data() {
    return {
      registerRules: {
        learnNum: [{ required: true, message: "请填写姓名", trigger: "blur" }],
        username: [{ required: true, message: "请填写学号", trigger: "blur" }],
        idCard: [
          { required: true, message: "请填写身份证号", trigger: "blur" },
        ],
        phone: [{ required: true, message: "请填写电话", trigger: "blur" }],
        password: [{ required: true, message: "请填写密码", trigger: "blur" }],
        confirmPassword: [
          { required: true, message: "请填写确认密码", trigger: "blur" },
        ],
        className: [{ required: true, message: "请填写班级", trigger: "blur" }],
      },
      //表单属性
      addModel: {
        type: "",
        readerId: "",
        learnNum: "",
        username: "",
        idCard: "",
        sex: "",
        phone: "",
        password: "",
        confirmPassword: "",
        type: "",
        className: "",
      },
      dialog: {
        title: "读者注册",
        visible: false,
        height: 250,
        width: 650,
      },
      //登录表单绑定数据源
      loginForm: {
        username: "",
        password: "",
        userType: "", //0：读者  1： 管理员
      },
      //表单验证规则
      rules: {
        username: [
          {
            trigger: "change",
            required: true,
            message: "请输入用户名",
          },
        ],
        password: [
          {
            trigger: "change",
            required: true,
            message: "请输入密码",
          },
        ],
        userType: [
          {
            trigger: "change",
            required: true,
            message: "请选择用户类型",
          },
        ],
      },
    };
  },
  methods: {
    onConfirm() {
      if (this.addModel.password != this.addModel.confirmPassword) {
        this.$message.warning("确认密码不对!");
        return;
      }
      this.$refs.addRef.validate(async (valid) => {
        if (valid) {
          let res = await registerApi(this.addModel);
          if (res && res.code == 200) {
            this.$message.success(res.msg);
            this.dialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
    //注册按钮
    registerBtn() {
      this.dialog.visible = true;
    },
    //登录提交事件
    onSubmit() {
      //表单验证
      this.$refs.loginForm.validate((valid) => {
        //验证通过才提交表单
        if (valid) {
          this.loading = true;
          //调用store里面的login方法
          this.$store
            .dispatch("user/login", this.loginForm)
            .then(() => {
              //跳转路由
              this.$router.push({ path: this.redirect || "/" });
              this.loading = false;
            })
            .catch(() => {
              this.loading = false;
            });
        }
      });
    },
  },
};
</script>

<style  scoped>
.logincontainer {
  height: 100%;
  background: #fff;
  background-image: url("../../assets/images/login_bg.png");
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: 100% 100%;
}
.loginForm {
  height: 350px;
  width: 450px;
  background: #fff;
  padding: 35px 25px;
  border-radius: 10px;
}
.loginTitle {
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 24px;
  font-weight: 600;
  color: #409eff;
}
.logincontainer ::v-deep .el-form-item__content {
  margin-left: 0px !important;
}
.mybtn {
  width: 100%;
}
</style>

```



#### 第68讲 审核读者、读者订阅图书

##### 1、SysReaderController控制器添加applyReader()方法

```js
//读者审核
    @PutMapping("/applyReader")
    public ResultVo applyReader(@RequestBody SysReader reader) {
        reader.setCheckStatus("1");
        sysReaderService.updateById(reader);
        return ResultUtils.success("审核成功!");
    }
```

##### 2、api/reader.js添加applyReaderApi()方法

```js
//读者审核
export const applyReaderApi = async(parm) =>{
    return await http.put("/api/reader/applyReader",parm)
}
```

##### 3、readerList.vue添加审核按钮

```js
 <el-button
            icon="el-icon-edit"
            type="primary"
            size="small"
            @click="applyBtn(scope.row)"
            >审核</el-button
          >
```

```js
async applyBtn(row) {
      let confirm = await this.$myconfirm("确定审核吗?");
      if (confirm) {
        console.log(row);
        let res = await applyReaderApi({ readerId: row.readerId });
        if (res && res.code == 200) {
          this.$message.success(res.msg);
          //刷新表格
          this.getList();
        }
      }
    },
```





#### 第69讲 读者借阅查看

##### 1、BorrowBookMapper接口添加如下方法

```js
//读者借阅查看列表
IPage<LookBorrow> getReaderLookBorrowList(Page<LookBorrow> page, @Param("parm") LookParm parm);
```

**BorrowBookMapper.xml映射文件添加如下查询**

```js
<select id="getReaderLookBorrowList" resultType="com.itmk.web.book_borrow.entity.LookBorrow">
        select t.* from (
        select  b.reader_id,b.borrow_id,b.book_id,sb.book_name,sb.book_place_num,
        sr.username,sr.learn_num,sr.class_name,sr.phone,b.borrow_time,b.return_time,b.borrow_status,
				b.apply_status,b.return_status,b.excepion_text,b.apply_text,
				case when b.return_time &lt; now() then '1' else '0' end as time_status
        from borrow_book as b left join sys_books as sb on b.book_id = sb.book_id
        left join sys_reader as sr on sr.reader_id =  b.reader_id )t
        where 1=1
        <if test="parm.userId != null and parm.userId !=''">
            and t.reader_id =#{parm.userId}
        </if>
         <if test="parm.username != null and parm.username !=''">
            and t.username =#{parm.username}
        </if>
        <if test="parm.borrowStatus != null and parm.borrowStatus !=''">
            and t.borrow_status =#{parm.borrowStatus}
        </if>
        <if test="parm.learnNum != null and parm.learnNum !=''">
            and t.learn_num  like CONCAT('%',#{parm.learnNum},'%')
        </if>
        <if test="parm.bookName != null and parm.bookName !=''">
            and t.book_name  like CONCAT('%',#{parm.bookName},'%')
        </if>
        <if test="parm.applyStatus != null and parm.applyStatus !=''">
            and t.apply_status =#{parm.applyStatus}
        </if>
        <if test="parm.returnStatus != null and parm.returnStatus !=''">
            and t.return_status =#{parm.returnStatus}
        </if>
        <if test="parm.timeStatus != null and parm.timeStatus !=''">
            and t.time_status =#{parm.timeStatus}
        </if>
        order by t.borrow_time desc
    </select>
```

##### 2、BorrowBookController控制器的getLookBorrowList()方法修改为如下

```js
//借阅查看
    @GetMapping("/getLookBorrowList")
    public ResultVo getLookBorrowList(LookParm parm, HttpServletRequest request) {
        //获取token
        String token = request.getHeader("token");
        Claims claims = jwtUtils.getClaimsFromToken(token);
        String userType = (String) claims.get("userType");
        IPage<LookBorrow> lookBorrowList = null;
        if (userType.equals("0")) {
            lookBorrowList = borrowBookService.getReaderLookBorrowList(parm);
            return ResultUtils.success("查询成功", lookBorrowList);
        } else if (userType.equals("1")) {
            lookBorrowList = borrowBookService.getLookBorrowList(parm);
            return ResultUtils.success("查询成功", lookBorrowList);
        } else {
            return ResultUtils.success("查询成功", lookBorrowList);
        }
    }
```





#### 第70讲 按钮级别权限控制讲解

##### 1、vue-element-admin已经实现按钮权限指令，直接使用即可

```js
1、官网地址  https://panjiachen.github.io/vue-element-admin-site/zh/guide/essentials/permission.html#%E9%80%BB%E8%BE%91%E4%BF%AE%E6%94%B9


2、按钮权限指令代码地址  https://github.com/PanJiaChen/vue-element-admin/tree/master/src/directive/permission
```



##### 2、在src下新建permission文件夹，把vue-element-admin官网的permission.js和index.js复制进来

index.js

```js
import permission from './permission'

const install = function(Vue) {
  Vue.directive('permission', permission)
}

if (window.Vue) {
  window['permission'] = permission
  Vue.use(install); // eslint-disable-line
}

permission.install = install
export default permission
```

permission.js

```js
import store from '@/store'

function checkPermission(el, binding) {
  const { value } = binding
  const roles = store.getters && store.getters.roles

  if (value && value instanceof Array) {
    if (value.length > 0) {
      const permissionRoles = value

      const hasPermission = roles.some(role => {
        return permissionRoles.includes(role)
      })

      if (!hasPermission) {
        el.parentNode && el.parentNode.removeChild(el)
      }
    }
  } else {
    throw new Error(`need roles! Like v-permission="['admin','editor']"`)
  }
}

export default {
  inserted(el, binding) {
    checkPermission(el, binding)
  },
  update(el, binding) {
    checkPermission(el, binding)
  }
}
```

##### 3、main.js中注册指令

```js
// 权限框架注册全局
import permission from '@/permission/index.js' // 权限判断指令
Vue.use(permission)
```

##### 4、页面使用指令

```js
v-permission="['editor']"
```





#### 第71讲 借书续期、token过期处理

**springboot接收日期参数的处理**

```js
@DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss")
@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
private Date startTime;

1、@DateTimeFormat ： 前端传递给后端，日期转换格式
2、@JsonFormat ： 后端传递给前端，日期转换格式
```







#### 第72讲  首页图表制作1



![](D:\Files\Simple\vue+springboot资料\资料\images\首页.png)



##### 1、安装echarts

```js
npm install echarts -S
```

##### 2、在main.js中引入

```js
import * as echarts from 'echarts';
Vue.prototype.$echarts = echarts
```

##### 3、dashboard页面

```js
<template>
  <el-main>
    <!-- 管理员统计 -->
    <el-row
      :gutter="20"
      type="flex"
      class="row-bg"
      justify="center"
      style="margin-bottom: 80px"
    >
      <el-col :span="6">
        <div class="show-header">
          <div class="show-num">110</div>
          <div class="bottom-text">读者总数</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(255, 153, 0)">
          <div class="show-num">10</div>
          <div class="bottom-text">读者待审核</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(45, 183, 245)">
          <div class="show-num">20</div>
          <div class="bottom-text">借书待审核</div>
        </div>
      </el-col>
      <el-col :span="6">
        <div class="show-header" style="background: rgb(237, 64, 20)">
          <div class="show-num">120</div>
          <div class="bottom-text">到期待还书</div>
        </div>
      </el-col>
    </el-row>
    <div style="display: flex">
      <div id="main1" style="width: 400px; height: 300px; flex-grow: 1"></div>
      <div id="main2" style="width: 400px; height: 300px; flex-grow: 1"></div>
    </div>
    <el-card class="box-card" style="margin-top:30px;">
      <div slot="header" class="clearfix">
        <span style="color:#000000;font-weight:600;">公告列表</span>
      </div>
      <div v-for="o in 3" :key="o" class="text item">
        {{ "列表内容 " + o }}
        <el-divider></el-divider>
      </div>
    </el-card>
  </el-main>
</template>

<script>
export default {
  name: "Dashboard",
  data() {
    return {};
  },
  mounted() {
    this.myecharts1();
    this.myecharts2();
  },
  methods: {
    myecharts1() {
      var myChart = this.$echarts.init(document.getElementById("main1"));
      // 指定图表的配置项和数据
      var option = {
        title: {
          text: "图书分类统计",
        },
        tooltip: {},
        legend: {
          data: ["分类"],
        },
        xAxis: {
          data: ["衬衫", "羊毛衫", "雪纺衫", "裤子", "高跟鞋", "袜子"],
        },
        yAxis: {},
        series: [
          {
            name: "销量",
            type: "bar",
            data: [5, 20, 36, 10, 10, 20],
          },
        ],
      };
      // 使用刚指定的配置项和数据显示图表。
      myChart.setOption(option);
    },
    myecharts2() {
      var myChart = this.$echarts.init(document.getElementById("main2"));
      // 指定图表的配置项和数据
      var option = {
        title: {
          text: "热门图书排行榜",
          left: "center",
        },
        tooltip: {
          trigger: "item",
        },
        legend: {
          orient: "vertical",
          left: "left",
        },
        series: [
          {
            // name: "Access From",
            type: "pie",
            radius: ["40%", "70%"],
            avoidLabelOverlap: false,
            label: {
              show: false,
              position: "center",
            },
            emphasis: {
              label: {
                show: true,
                fontSize: "40",
                fontWeight: "bold",
              },
            },
            labelLine: {
              show: false,
            },
            data: [
              { value: 1048, name: "Search Engine" },
              { value: 735, name: "Direct" },
              { value: 580, name: "Email" },
              { value: 484, name: "Union Ads" },
              { value: 300, name: "Video Ads" },
            ],
          },
        ],
      };
      // 使用刚指定的配置项和数据显示图表。
      myChart.setOption(option);
    },
  },
};
</script>

<style lang="scss" scoped>
.bottom-text {
  bottom: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.1);
  height: 25px;
  line-height: 25px;
  text-align: center;
  position: absolute;
  font-weight: 600;
}
.show-header {
  background: #00c0ef;
  color: #fff;
  height: 80px;
  border-radius: 5px;
  position: relative;
}
.show-num {
  font-size: 38px;
  font-weight: 600;
  padding: 5px;
}
</style>

```





#### 第73讲 首页制作2

##### 1、新建实体类

```js
package com.itmk.web.sys_category.entity;

import lombok.Data;

@Data
public class CategoryVo {
    private String categoryName;
    private Integer bookCount;
}

```

```js
package com.itmk.web.sys_category.entity;

import lombok.Data;

import java.util.ArrayList;
import java.util.List;

@Data
public class CategoryEcharts {
    private List<String> names =  new ArrayList<>();
    private List<Integer> counts = new ArrayList<>();
}

```



##### 2、SysCategoryMapper接口添加getCategoryVo()方法

```js
//分类统计
List<CategoryVo> getCategoryVo();
```

**映射文件 SysCategoryMapper.xml**

```js
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itmk.web.sys_category.mapper.SysCategoryMapper">
    <select id="getCategoryVo" resultType="com.itmk.web.sys_category.entity.CategoryVo">
        select c.category_name,count(b.book_id) as book_count
        from sys_category as c
        left join sys_books as b
        on b.category_id = c.category_id
        group by c.category_id
        order by c.order_num asc
    </select>
</mapper>
```

##### 3、SysCategoryService接口添加getCategoryVo()方法

```js
//分类统计
CategoryEcharts getCategoryVo();
```

**实现类**

```js
@Override
    public CategoryEcharts getCategoryVo() {
        CategoryEcharts echarts = new CategoryEcharts();
        List<CategoryVo> categoryVo = this.baseMapper.getCategoryVo();
        List<String> names = new ArrayList<>();
        List<Integer> counts = new ArrayList<>();
        for(int i =0;i<categoryVo.size();i++){
            names.add(categoryVo.get(i).getCategoryName());
            counts.add(categoryVo.get(i).getBookCount());
        }
        echarts.setNames(names);
        echarts.setCounts(counts);
        return echarts;
    }
```



##### 4、SysCategoryController控制器添加categoryCount()方法

```js
 //图书分类统计
    @GetMapping("/categoryCount")
    public ResultVo categoryCount(){
        CategoryEcharts vo = sysCategoryService.getCategoryVo();
        return ResultUtils.success("查询成功",vo);
    }
```



##### 5、新建BookVo实体类

```js
package com.itmk.web.sys_books.entity;

import lombok.Data;

@Data
public class BookVo {
    private String name;
    private Integer value;
}

```

##### 6、SysBooksMapper接口添加getHotBook()方法

```js
 List<BookVo>  getHotBook();
```

**SysBooksMapper.xml映射文件**

```js
<select id="getHotBook" resultType="com.itmk.web.sys_books.entity.BookVo">
        select bk.book_name as name,count(b.reader_id) as value
        from sys_books as bk
        left join borrow_book as b
        on bk.book_id = b.book_id group by b.book_id
        order by value desc limit 10
    </select>
```

##### 7、SysBooksService接口添加getHotBook()方法

```js
List<BookVo> getHotBook();
```

**实现类**

```js
@Override
    public List<BookVo> getHotBook() {
        return this.baseMapper.getHotBook();
    }
```

##### 8、SysBooksController控制器添加getHotBook()方法

```js
//列表
    @GetMapping("/getHotBook")
    public ResultVo getHotBook(){
        List<BookVo> hotBook = sysBooksService.getHotBook();
        return ResultUtils.success("查询成功",hotBook);
    }
```



##### 9、SysNoticeController控制器添加getTopList()方法

```js
//列表
    @GetMapping("/getTopList")
    public ResultVo getTopList(){
        QueryWrapper<SysNotice> query = new QueryWrapper<>();
        query.lambda().orderByDesc(SysNotice::getCreateTime).last("limit 3");
        List<SysNotice> list = sysNoticeService.list(query);
        return ResultUtils.success("查询成功",list);
    }
```





#### 第74讲 token验证讲解

##### 1、新建Auth注解

```js
package com.itmk.annotation;

import java.lang.annotation.*;

@Target(ElementType.METHOD)
@Documented
@Retention(RetentionPolicy.RUNTIME)
public @interface Auth {
}
```

##### 2、新建拦截器

```js
package com.itmk.annotation;

import com.itmk.exception.BusinessException;
import com.itmk.jwt.JwtUtils;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class AuthInterceptor implements HandlerInterceptor {
    @Autowired
    private JwtUtils jwtUtils;
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        Auth annotation;
        if(handler instanceof HandlerMethod){
            annotation = ((HandlerMethod) handler).getMethodAnnotation(Auth.class);
        }else{
            return true;
        }
        if(annotation == null){
            return true;
        }
        String token = request.getHeader("token");
        if(StringUtils.isEmpty(token)){
            token = request.getParameter("token");
        }
        if(StringUtils.isEmpty(token)){
            throw new BusinessException(600,"token不能为空!");
        }
        Boolean expired = jwtUtils.isTokenExpired(token);
        if(expired){
            throw new BusinessException(600,"token过期!");
        }
        String username = jwtUtils.getUsernameFromToken(token);
        if(StringUtils.isEmpty(username)){
            throw new BusinessException(600,"token验证失败!");
        }
        return true;
    }
}

```

##### 3、WebMvcConfig配置类加入拦截器

```js
package com.itmk.config.web;


import com.itmk.annotation.AuthInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Autowired
    private AuthInterceptor authInterceptor;
    /**
     * 跨域配置
     * @param registry
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("*")
                .allowedHeaders("*")
                .maxAge(3600)
                .allowCredentials(true);
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(authInterceptor).addPathPatterns("/api/**");
    }
}
```







#### 第75讲 修改密码功能讲解

##### 1、清空选项卡数据

```js
//清空tagsview里面的数据
dispatch('tagsView/delAllViews', {}, { root: true })
```

##### 2、SysUserController控制器添加updatePassword()方法

```js
package com.itmk.web.sys_user.entity;

import lombok.Data;

@Data
public class UpdatePasswordParm {
    private Long userId;
    private String oldPassword;
    private String password;
}

```



```js
//修改密码
    @Auth
    @PostMapping("/updatePassword")
    public ResultVo updatePassword(@RequestBody UpdatePasswordParm parm, HttpServletRequest request) {
        String token = request.getHeader("token");
        Claims claims = jwtUtils.getClaimsFromToken(token);
        Object userType = claims.get("userType");
        String old = DigestUtils.md5DigestAsHex(parm.getOldPassword().getBytes());
        if (userType.equals("0")) { //读者
            SysReader reader = sysReaderService.getById(parm.getUserId());
            if (!reader.getPassword().equals(old)) {
                return ResultUtils.error("原密码不正确!");
            }
            SysReader sysReader = new SysReader();
            sysReader.setReaderId(parm.getUserId());
            sysReader.setPassword(DigestUtils.md5DigestAsHex(parm.getPassword().getBytes()));
            boolean b = sysReaderService.updateById(sysReader);
            if (b) {
                return ResultUtils.success("密码修改成功!");
            }

        } else {

            SysUser user = sysUserService.getById(parm.getUserId());
            if (!user.getPassword().equals(old)) {
                return ResultUtils.error("原密码不正确!");
            }
            SysUser sysUser = new SysUser();
            sysUser.setUserId(parm.getUserId());
            sysUser.setPassword(DigestUtils.md5DigestAsHex(parm.getPassword().getBytes()));
            boolean b = sysUserService.updateById(sysUser);
            if (b) {
                return ResultUtils.success("密码修改成功!");
            }
        }
        return ResultUtils.error("密码修改失败!");
    }
```

##### 3、api/user.js添加updatePasswordApi()方法

```js
//修改密码
export const updatePasswordApi = async(parm) =>{
  return await http.post("/api/user/updatePassword",parm)
}

```

##### 4、修改layout/components/Navbar.vue页面如下

```js
<template>
  <div class="navbar">
    <hamburger
      :is-active="sidebar.opened"
      class="hamburger-container"
      @toggleClick="toggleSideBar"
    />

    <breadcrumb class="breadcrumb-container" />

    <div class="right-menu">
      <el-dropdown class="avatar-container" trigger="click">
        <div class="avatar-wrapper">
          <img :src="avatar + '?imageView2/1/w/80/h/80'" class="user-avatar" />
          <i class="el-icon-caret-bottom" />
        </div>
        <el-dropdown-menu slot="dropdown" class="user-dropdown">
          <router-link to="/">
            <el-dropdown-item> 首页 </el-dropdown-item>
          </router-link>
          <a
            target="_blank"
            href="https://github.com/PanJiaChen/vue-admin-template/"
          >
            <el-dropdown-item>Github</el-dropdown-item>
          </a>
          <a
            target="_blank"
            href="https://panjiachen.github.io/vue-element-admin-site/#/"
          >
            <el-dropdown-item>Docs</el-dropdown-item>
          </a>
          <el-dropdown-item divided @click.native="updatePwd">
            <span style="display: block">修改密码</span>
          </el-dropdown-item>
          <el-dropdown-item divided @click.native="logout">
            <span style="display: block">退出登录</span>
          </el-dropdown-item>
        </el-dropdown-menu>
      </el-dropdown>
    </div>
    <!-- 修改密码弹框 -->
    <sys-dialog
      :title="dialog.title"
      :height="dialog.height"
      :width="dialog.width"
      :visible="dialog.visible"
      @onConfirm="onConfirm"
      @onClose="onClose"
    >
      <div slot="content">
        <el-form
          :model="addModel"
          ref="addModel"
          :rules="rules"
          label-width="80px"
          :inline="true"
          size="small"
        >
          <el-form-item prop="oldPassword" label="原密码">
            <el-input v-model="addModel.oldPassword"></el-input>
          </el-form-item>
          <el-form-item prop="password" label="新密码">
            <el-input v-model="addModel.password"></el-input>
          </el-form-item>
        </el-form>
      </div>
    </sys-dialog>
  </div>
</template>

<script>
import SysDialog from "@/components/dialog/SysDialog.vue";
import { mapGetters } from "vuex";
import Breadcrumb from "@/components/Breadcrumb";
import Hamburger from "@/components/Hamburger";
import {updatePasswordApi} from '@/api/user'
import {getUserId} from '@/utils/auth'
export default {
  components: {
    Breadcrumb,
    Hamburger,
    SysDialog,
  },
  data() {
    return {
      rules: {
        oldPassword: [
          { trigger: "blur", required: true, message: "请填写原密码!" },
        ],
        password: [
          { trigger: "blur", required: true, message: "请填写新密码!" },
        ],
      },
      addModel: {
        oldPassword: "",
        password: "",
        userId:''
      },
      dialog: {
        title: "密码修改",
        height: 150,
        width: 650,
        visible: false,
      },
    };
  },
  computed: {
    ...mapGetters(["sidebar", "avatar"]),
  },
  methods: {
    onConfirm() {
      this.$refs.addModel.validate(async(valid) => {
        if (valid) {
          this.addModel.userId = getUserId()
          let res = await updatePasswordApi(this.addModel)
          if(res && res.code == 200){
            this.$message.success(res.msg)
            this.dialog.visible = false;
          }
        }
      });
    },
    onClose() {
      this.dialog.visible = false;
    },
    updatePwd() {
      this.dialog.visible = true;
    },
    toggleSideBar() {
      this.$store.dispatch("app/toggleSideBar");
    },
    async logout() {
      await this.$store.dispatch("user/logout");
      this.$router.push(`/login?redirect=${this.$route.fullPath}`);
    },
  },
};
</script>

<style lang="scss" scoped>
.navbar {
  height: 50px;
  overflow: hidden;
  position: relative;
  background: #fff;
  box-shadow: 0 1px 4px rgba(0, 21, 41, 0.08);

  .hamburger-container {
    line-height: 46px;
    height: 100%;
    float: left;
    cursor: pointer;
    transition: background 0.3s;
    -webkit-tap-highlight-color: transparent;

    &:hover {
      background: rgba(0, 0, 0, 0.025);
    }
  }

  .breadcrumb-container {
    float: left;
  }

  .right-menu {
    float: right;
    height: 100%;
    line-height: 50px;

    &:focus {
      outline: none;
    }

    .right-menu-item {
      display: inline-block;
      padding: 0 8px;
      height: 100%;
      font-size: 18px;
      color: #5a5e66;
      vertical-align: text-bottom;

      &.hover-effect {
        cursor: pointer;
        transition: background 0.3s;

        &:hover {
          background: rgba(0, 0, 0, 0.025);
        }
      }
    }

    .avatar-container {
      margin-right: 30px;

      .avatar-wrapper {
        margin-top: 5px;
        position: relative;

        .user-avatar {
          cursor: pointer;
          width: 40px;
          height: 40px;
          border-radius: 10px;
        }

        .el-icon-caret-bottom {
          cursor: pointer;
          position: absolute;
          right: -20px;
          top: 25px;
          font-size: 12px;
        }
      }
    }
  }
}
</style>

```



#### 第76 重置密码功能

##### 1、SysUserController控制器添加resetPassword()方法

```js
//重置密码
    @PostMapping("/resetPassword")
    public ResultVo resetPassword(@RequestBody SysUser sysUser){
        String pasword = "666666";
        sysUser.setPassword(DigestUtils.md5DigestAsHex(pasword.getBytes()));
        boolean b = sysUserService.updateById(sysUser);
        if(b){
            return ResultUtils.success("重置密码成功!");
        }
        return ResultUtils.error("重置密码失败!");
    }
```

##### 2、SysReaderController控制器添加resetPassword()方法

```js
//重置密码
    @PostMapping("/resetPassword")
    public ResultVo resetPassword(@RequestBody SysReader sysReader){
        String pasword = "666666";
        sysReader.setPassword(DigestUtils.md5DigestAsHex(pasword.getBytes()));
        boolean b = sysReaderService.updateById(sysReader);
        if(b){
            return ResultUtils.success("重置密码成功!");
        }
        return ResultUtils.error("重置密码失败!");
    }
```





